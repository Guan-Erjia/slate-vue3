import{s as L,d as y,Y as p,r as M}from"./index-FzwapiRn.js";import{R as D,E as I,N as b,D as T,P as N}from"./editable-OBw7MXqz.js";import{i as _,j}from"./index-cO_khfoC.js";const w=new WeakMap,F={isCursorEditor(e){return p.isYjsEditor(e)&&e.awareness&&typeof e.cursorDataField=="string"&&typeof e.selectionStateField=="string"&&typeof e.sendCursorPosition=="function"&&typeof e.sendCursorData=="function"},sendCursorPosition(e,n=e.selection){e.sendCursorPosition(n)},sendCursorData(e,n){e.sendCursorData(n)},on(e,n,s){if(n!=="change")return;const o=w.get(e)??new Set;o.add(s),w.set(e,o)},off(e,n,s){if(n!=="change")return;const o=w.get(e);o&&o.delete(s)},cursorState(e,n){if(n===e.sharedRoot.doc?.clientID||!p.connected(e))return null;const s=e.awareness.getStates().get(n);return s?{selection:s.selection??null,data:s.data}:null},cursorStates(e){return p.connected(e)?Object.fromEntries(Array.from(e.awareness.getStates().entries(),([n,s])=>n===e.sharedRoot.doc?.clientID||!s?null:[n,{selection:s.selection,data:s.data}]).filter(Array.isArray)):{}}};function x(e,n,{cursorStateField:s="selection",cursorDataField:o="data",autoSend:h=!0,data:R}={}){const t=e;t.awareness=n,t.cursorDataField=o,t.selectionStateField=s,t.sendCursorData=a=>{t.awareness.setLocalStateField(t.cursorDataField,a)},t.sendCursorPosition=a=>{const r=t.awareness.getLocalState().selection;if(!a){r&&t.awareness.setLocalStateField(t.selectionStateField,null);return}const i=L(t.sharedRoot,t,a);(!r||!y(i.anchor,r.anchor)||!y(i.focus,r.focus))&&t.awareness.setLocalStateField(t.selectionStateField,i)};const c=a=>{const u=w.get(t);if(!u)return;const r=t.sharedRoot.doc?.clientID,i={added:a.added.filter(l=>l!==r),removed:a.removed.filter(l=>l!==r),updated:a.updated.filter(l=>l!==r)};(i.added.length>0||i.removed.length>0||i.updated.length>0)&&u.forEach(l=>l(i))},{connect:C,disconnect:S}=t;return t.connect=()=>{if(C(),t.awareness.on("change",c),c({removed:[],added:Array.from(t.awareness.getStates().keys()),updated:[]}),h){R&&F.sendCursorData(t,R);const{onChange:a}=t;t.onChange=()=>{a(),p.connected(t)&&F.sendCursorPosition(t)}}},t.disconnect=()=>{t.awareness.off("change",c),c({removed:Array.from(t.awareness.getStates().keys()),added:[],updated:[]}),S()},t}function z(e,n){const s=new ResizeObserver(n);_(()=>{e.value&&s.observe(e.value)}),j(()=>{e.value&&s.unobserve(e.value)})}const P=new WeakMap;function B(e,n){if(!n.selection)return null;let s=P.get(e.children);s||(s=new WeakMap,P.set(e.children,s));let o=s.get(n);if(o===void 0)try{o=M(e.sharedRoot,e,n.selection),s.set(n,o)}catch{return null}return o}function G(e,n,{yOffset:s,xOffset:o,shouldGenerateOverlay:h}){const[R,t]=D.edges(n),c=U(e,n);if(!c)return{caretPosition:null,selectionRects:[]};const C=[],S=I.nodes(e,{at:n,match:(r,i)=>b.isText(r)&&!h});let a=null;const u=D.isBackward(n);for(const[r,i]of S){const l=T.toDOMNode(e,r),m=N.equals(i,R.path),E=N.equals(i,t.path);let g=null;if(m||E){const d=document.createRange();d.selectNode(l),m&&d.setStart(c.startContainer,c.startOffset),E&&d.setEnd(c.endContainer,c.endOffset),g=d.getClientRects()}else g=l.getClientRects();const A=u?m:E;for(let d=0;d<g.length;d++){const f=g.item(d);if(!f)continue;const k=A&&(u?d===0:d===g.length-1),v=f.top-s,O=f.left-o;k&&(a={height:f.height,top:v,left:O+(u||D.isCollapsed(n)?0:f.width)}),C.push({width:f.width,height:f.height,top:v,left:O})}}return{selectionRects:C,caretPosition:a}}function U(e,n){try{return T.toDOMRange(e,n)}catch{return null}}export{F as C,G as a,B as g,z as u,x as w};
