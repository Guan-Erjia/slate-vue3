import{i as io,d as rt,N as ls,P as zn,E as js,L as $l,T as Vl}from"./editable-CteuoeWb.js";const _t=()=>new Map,Hr=e=>{const t=_t();return e.forEach((n,s)=>{t.set(s,n)}),t},ge=(e,t,n)=>{let s=e.get(t);return s===void 0&&e.set(t,s=n()),s},Bl=(e,t)=>{const n=[];for(const[s,r]of e)n.push(t(r,s));return n},Fl=(e,t)=>{for(const[n,s]of e)if(t(s,n))return!0;return!1},Ke=()=>new Set,br=e=>e[e.length-1],jl=(e,t)=>{for(let n=0;n<t.length;n++)e.push(t[n])},de=Array.from,Hl=(e,t)=>{for(let n=0;n<e.length;n++)if(t(e[n],n,e))return!0;return!1},Kr=Array.isArray;class gc{constructor(){this._observers=_t()}on(t,n){return ge(this._observers,t,Ke).add(n),n}once(t,n){const s=(...r)=>{this.off(t,s),n(...r)};this.on(t,s)}off(t,n){const s=this._observers.get(t);s!==void 0&&(s.delete(n),s.size===0&&this._observers.delete(t))}emit(t,n){return de((this._observers.get(t)||_t()).values()).forEach(s=>s(...n))}destroy(){this._observers=_t()}}let Kl=class{constructor(){this._observers=_t()}on(t,n){ge(this._observers,t,Ke).add(n)}once(t,n){const s=(...r)=>{this.off(t,s),n(...r)};this.on(t,s)}off(t,n){const s=this._observers.get(t);s!==void 0&&(s.delete(n),s.size===0&&this._observers.delete(t))}emit(t,n){return de((this._observers.get(t)||_t()).values()).forEach(s=>s(...n))}destroy(){this._observers=_t()}};const Oe=Math.floor,Ms=Math.abs,mc=(e,t)=>e<t?e:t,Xe=(e,t)=>e>t?e:t,yc=e=>e!==0?e<0:1/e<0,oo=1,co=2,vr=4,Sr=8,Wn=32,oe=64,Et=128,tr=31,zr=63,Fe=127,zl=2147483647,wc=Number.MAX_SAFE_INTEGER,Wl=Number.isInteger||(e=>typeof e=="number"&&isFinite(e)&&Oe(e)===e),ql=e=>e.toLowerCase(),Gl=/^\s*/g,Yl=e=>e.replace(Gl,""),Jl=/([A-Z])/g,ao=(e,t)=>Yl(e.replace(Jl,n=>`${t}${ql(n)}`)),Xl=e=>{const t=unescape(encodeURIComponent(e)),n=t.length,s=new Uint8Array(n);for(let r=0;r<n;r++)s[r]=t.codePointAt(r);return s},qn=typeof TextEncoder<"u"?new TextEncoder:null,Zl=e=>qn.encode(e),Ql=qn?Zl:Xl;let Hn=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});Hn&&Hn.decode(new Uint8Array).length===1&&(Hn=null);class ds{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const us=()=>new ds,td=e=>{let t=e.cpos;for(let n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t},$t=e=>{const t=new Uint8Array(td(e));let n=0;for(let s=0;s<e.bufs.length;s++){const r=e.bufs[s];t.set(r,n),n+=r.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),n),t},ed=(e,t)=>{const n=e.cbuf.length;n-e.cpos<t&&(e.bufs.push(new Uint8Array(e.cbuf.buffer,0,e.cpos)),e.cbuf=new Uint8Array(Xe(n,t)*2),e.cpos=0)},at=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(n*2),e.cpos=0),e.cbuf[e.cpos++]=t},Gn=at,F=(e,t)=>{for(;t>Fe;)at(e,Et|Fe&t),t=Oe(t/128);at(e,Fe&t)},er=(e,t)=>{const n=yc(t);for(n&&(t=-t),at(e,(t>zr?Et:0)|(n?oe:0)|zr&t),t=Oe(t/64);t>0;)at(e,(t>Fe?Et:0)|Fe&t),t=Oe(t/128)},Wr=new Uint8Array(3e4),nd=Wr.length/3,sd=(e,t)=>{if(t.length<nd){const n=qn.encodeInto(t,Wr).written||0;F(e,n);for(let s=0;s<n;s++)at(e,Wr[s])}else kt(e,Ql(t))},rd=(e,t)=>{const n=unescape(encodeURIComponent(t)),s=n.length;F(e,s);for(let r=0;r<s;r++)at(e,n.codePointAt(r))},je=qn&&qn.encodeInto?sd:rd,nr=(e,t)=>{const n=e.cbuf.length,s=e.cpos,r=mc(n-s,t.length),i=t.length-r;e.cbuf.set(t.subarray(0,r),s),e.cpos+=r,i>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(Xe(n*2,i)),e.cbuf.set(t.subarray(r)),e.cpos=i)},kt=(e,t)=>{F(e,t.byteLength),nr(e,t)},wi=(e,t)=>{ed(e,t);const n=new DataView(e.cbuf.buffer,e.cpos,t);return e.cpos+=t,n},id=(e,t)=>wi(e,4).setFloat32(0,t,!1),od=(e,t)=>wi(e,8).setFloat64(0,t,!1),cd=(e,t)=>wi(e,8).setBigInt64(0,t,!1),lo=new DataView(new ArrayBuffer(4)),ad=e=>(lo.setFloat32(0,e),lo.getFloat32(0)===e),Yn=(e,t)=>{switch(typeof t){case"string":at(e,119),je(e,t);break;case"number":Wl(t)&&Ms(t)<=zl?(at(e,125),er(e,t)):ad(t)?(at(e,124),id(e,t)):(at(e,123),od(e,t));break;case"bigint":at(e,122),cd(e,t);break;case"object":if(t===null)at(e,126);else if(Kr(t)){at(e,117),F(e,t.length);for(let n=0;n<t.length;n++)Yn(e,t[n])}else if(t instanceof Uint8Array)at(e,116),kt(e,t);else{at(e,118);const n=Object.keys(t);F(e,n.length);for(let s=0;s<n.length;s++){const r=n[s];je(e,r),Yn(e,t[r])}}break;case"boolean":at(e,t?120:121);break;default:at(e,127)}};class uo extends ds{constructor(t){super(),this.w=t,this.s=null,this.count=0}write(t){this.s===t?this.count++:(this.count>0&&F(this,this.count-1),this.count=1,this.w(this,t),this.s=t)}}const ho=e=>{e.count>0&&(er(e.encoder,e.count===1?e.s:-e.s),e.count>1&&F(e.encoder,e.count-2))};class $s{constructor(){this.encoder=new ds,this.s=0,this.count=0}write(t){this.s===t?this.count++:(ho(this),this.count=1,this.s=t)}toUint8Array(){return ho(this),$t(this.encoder)}}const fo=e=>{if(e.count>0){const t=e.diff*2+(e.count===1?0:1);er(e.encoder,t),e.count>1&&F(e.encoder,e.count-2)}};class _r{constructor(){this.encoder=new ds,this.s=0,this.count=0,this.diff=0}write(t){this.diff===t-this.s?(this.s=t,this.count++):(fo(this),this.count=1,this.diff=t-this.s,this.s=t)}toUint8Array(){return fo(this),$t(this.encoder)}}class ld{constructor(){this.sarr=[],this.s="",this.lensE=new $s}write(t){this.s+=t,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(t.length)}toUint8Array(){const t=new ds;return this.sarr.push(this.s),this.s="",je(t,this.sarr.join("")),nr(t,this.lensE.toUint8Array()),$t(t)}}const ue=e=>new Error(e),Wt=()=>{throw ue("Method unimplemented")},Lt=()=>{throw ue("Unexpected case")},bc=ue("Unexpected end of array"),vc=ue("Integer out of Range");class sr{constructor(t){this.arr=t,this.pos=0}}const he=e=>new sr(e),Sc=e=>e.pos!==e.arr.length,dd=(e,t)=>{const n=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n},It=e=>dd(e,$(e)),Sn=e=>e.arr[e.pos++],$=e=>{let t=0,n=1;const s=e.arr.length;for(;e.pos<s;){const r=e.arr[e.pos++];if(t=t+(r&Fe)*n,n*=128,r<Et)return t;if(t>wc)throw vc}throw bc},rr=e=>{let t=e.arr[e.pos++],n=t&zr,s=64;const r=(t&oe)>0?-1:1;if((t&Et)===0)return r*n;const i=e.arr.length;for(;e.pos<i;){if(t=e.arr[e.pos++],n=n+(t&Fe)*s,s*=128,t<Et)return r*n;if(n>wc)throw vc}throw bc},ud=e=>{let t=$(e);if(t===0)return"";{let n=String.fromCodePoint(Sn(e));if(--t<100)for(;t--;)n+=String.fromCodePoint(Sn(e));else for(;t>0;){const s=t<1e4?t:1e4,r=e.arr.subarray(e.pos,e.pos+s);e.pos+=s,n+=String.fromCodePoint.apply(null,r),t-=s}return decodeURIComponent(escape(n))}},hd=e=>Hn.decode(It(e)),He=Hn?hd:ud,bi=(e,t)=>{const n=new DataView(e.arr.buffer,e.arr.byteOffset+e.pos,t);return e.pos+=t,n},fd=e=>bi(e,4).getFloat32(0,!1),pd=e=>bi(e,8).getFloat64(0,!1),gd=e=>bi(e,8).getBigInt64(0,!1),md=[e=>{},e=>null,rr,fd,pd,gd,e=>!1,e=>!0,He,e=>{const t=$(e),n={};for(let s=0;s<t;s++){const r=He(e);n[r]=Jn(e)}return n},e=>{const t=$(e),n=[];for(let s=0;s<t;s++)n.push(Jn(e));return n},It],Jn=e=>md[127-Sn(e)](e);class po extends sr{constructor(t,n){super(t),this.reader=n,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),Sc(this)?this.count=$(this)+1:this.count=-1),this.count--,this.s}}class Vs extends sr{constructor(t){super(t),this.s=0,this.count=0}read(){if(this.count===0){this.s=rr(this);const t=yc(this.s);this.count=1,t&&(this.s=-this.s,this.count=$(this)+2)}return this.count--,this.s}}class kr extends sr{constructor(t){super(t),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const t=rr(this),n=t&1;this.diff=Oe(t/2),this.count=1,n&&(this.count=$(this)+2)}return this.s+=this.diff,this.count--,this.s}}class yd{constructor(t){this.decoder=new Vs(t),this.str=He(this.decoder),this.spos=0}read(){const t=this.spos+this.decoder.read(),n=this.str.slice(this.spos,t);return this.spos=t,n}}const wd=crypto.getRandomValues.bind(crypto),_c=()=>wd(new Uint32Array(1))[0],bd="10000000-1000-4000-8000"+-1e11,vd=()=>bd.replace(/[018]/g,e=>(e^_c()&15>>e/4).toString(16)),Sd=Date.now,_n=e=>new Promise(e);Promise.all.bind(Promise);const go=e=>e===void 0?null:e;class _d{constructor(){this.map=new Map}setItem(t,n){this.map.set(t,n)}getItem(t){return this.map.get(t)}}let kc=new _d,kd=!0;try{typeof localStorage<"u"&&localStorage&&(kc=localStorage,kd=!1)}catch{}const Id=kc,Ed=Object.assign,Ad=Object.keys,Td=(e,t)=>{for(const n in e)t(e[n],n)},mo=e=>Ad(e).length,Cd=e=>{for(const t in e)return!1;return!0},Od=(e,t)=>{for(const n in e)if(!t(e[n],n))return!1;return!0},xd=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),Dd=(e,t)=>e===t||mo(e)===mo(t)&&Od(e,(n,s)=>(n!==void 0||xd(t,s))&&t[s]===n),Rd=Object.freeze,Ic=e=>{for(const t in e){const n=e[t];(typeof n=="object"||typeof n=="function")&&Ic(e[t])}return Rd(e)},vi=(e,t,n=0)=>{try{for(;n<e.length;n++)e[n](...t)}finally{n<e.length&&vi(e,t,n+1)}},Ld=e=>e,Pd=(e,t)=>t.includes(e);var Ec={};const Xn=typeof process<"u"&&process.release&&/node|io\.js/.test(process.release.name)&&Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]";let Ht;const Ud=()=>{if(Ht===void 0)if(Xn){Ht=_t();const e=process.argv;let t=null;for(let n=0;n<e.length;n++){const s=e[n];s[0]==="-"?(t!==null&&Ht.set(t,""),t=s):t!==null&&(Ht.set(t,s),t=null)}t!==null&&Ht.set(t,"")}else typeof location=="object"?(Ht=_t(),(location.search||"?").slice(1).split("&").forEach(e=>{if(e.length!==0){const[t,n]=e.split("=");Ht.set(`--${ao(t,"-")}`,n),Ht.set(`-${ao(t,"-")}`,n)}})):Ht=_t();return Ht},qr=e=>Ud().has(e),Hs=e=>go(Xn?Ec[e.toUpperCase().replaceAll("-","_")]:Id.getItem(e)),Ac=e=>qr("--"+e)||Hs(e)!==null;Ac("production");const Nd=Xn&&Pd(Ec.FORCE_COLOR,["true","1","2"]),Md=Nd||!qr("--no-colors")&&!Ac("no-color")&&(!Xn||process.stdout.isTTY)&&(!Xn||qr("--color")||Hs("COLORTERM")!==null||(Hs("TERM")||"").includes("color")),$d=e=>new Uint8Array(e),Vd=e=>{const t=$d(e.byteLength);return t.set(e),t};class Bd{constructor(t,n){this.left=t,this.right=n}}const ee=(e,t)=>new Bd(e,t);typeof DOMParser<"u"&&new DOMParser;const Fd=e=>Bl(e,(t,n)=>`${n}:${t};`).join(""),me=Symbol,Tc=me(),Cc=me(),jd=me(),Hd=me(),Kd=me(),Oc=me(),zd=me(),Si=me(),Wd=me(),qd=e=>{e.length===1&&e[0]?.constructor===Function&&(e=e[0]());const t=[],n=[];let s=0;for(;s<e.length;s++){const r=e[s];if(r===void 0)break;if(r.constructor===String||r.constructor===Number)t.push(r);else if(r.constructor===Object)break}for(s>0&&n.push(t.join(""));s<e.length;s++){const r=e[s];r instanceof Symbol||n.push(r)}return n},Gd={[Tc]:ee("font-weight","bold"),[Cc]:ee("font-weight","normal"),[jd]:ee("color","blue"),[Kd]:ee("color","green"),[Hd]:ee("color","grey"),[Oc]:ee("color","red"),[zd]:ee("color","purple"),[Si]:ee("color","orange"),[Wd]:ee("color","black")},Yd=e=>{e.length===1&&e[0]?.constructor===Function&&(e=e[0]());const t=[],n=[],s=_t();let r=[],i=0;for(;i<e.length;i++){const o=e[i],c=Gd[o];if(c!==void 0)s.set(c.left,c.right);else{if(o===void 0)break;if(o.constructor===String||o.constructor===Number){const l=Fd(s);i>0||l.length>0?(t.push("%c"+o),n.push(l)):t.push(o)}else break}}for(i>0&&(r=n,r.unshift(t.join("")));i<e.length;i++){const o=e[i];o instanceof Symbol||r.push(o)}return r},xc=Md?Yd:qd,Jd=(...e)=>{console.log(...xc(e)),Rc.forEach(t=>t.print(e))},Dc=(...e)=>{console.warn(...xc(e)),e.unshift(Si),Rc.forEach(t=>t.print(e))},Rc=Ke(),Lc=e=>({[Symbol.iterator](){return this},next:e}),Xd=(e,t)=>Lc(()=>{let n;do n=e.next();while(!n.done&&!t(n.value));return n}),Ir=(e,t)=>Lc(()=>{const{done:n,value:s}=e.next();return{done:n,value:n?void 0:t(s)}});class _i{constructor(t,n){this.clock=t,this.len=n}}class Cn{constructor(){this.clients=new Map}}const kn=(e,t,n)=>t.clients.forEach((s,r)=>{const i=e.doc.store.clients.get(r);if(i!=null){const o=i[i.length-1],c=o.id.clock+o.length;for(let l=0,d=s[l];l<s.length&&d.clock<c;d=s[++l])Gc(e,i,d.clock,d.len,n)}}),Zd=(e,t)=>{let n=0,s=e.length-1;for(;n<=s;){const r=Oe((n+s)/2),i=e[r],o=i.clock;if(o<=t){if(t<o+i.len)return r;n=r+1}else s=r-1}return null},On=(e,t)=>{const n=e.clients.get(t.client);return n!==void 0&&Zd(n,t.clock)!==null},ki=e=>{e.clients.forEach(t=>{t.sort((r,i)=>r.clock-i.clock);let n,s;for(n=1,s=1;n<t.length;n++){const r=t[s-1],i=t[n];r.clock+r.len>=i.clock?r.len=Xe(r.len,i.clock+i.len-r.clock):(s<n&&(t[s]=i),s++)}t.length=s})},Zn=e=>{const t=new Cn;for(let n=0;n<e.length;n++)e[n].clients.forEach((s,r)=>{if(!t.clients.has(r)){const i=s.slice();for(let o=n+1;o<e.length;o++)jl(i,e[o].clients.get(r)||[]);t.clients.set(r,i)}});return ki(t),t},Qn=(e,t,n,s)=>{ge(e.clients,t,()=>[]).push(new _i(n,s))},Pc=()=>new Cn,Uc=e=>{const t=Pc();return e.clients.forEach((n,s)=>{const r=[];for(let i=0;i<n.length;i++){const o=n[i];if(o.deleted){const c=o.id.clock;let l=o.length;if(i+1<n.length)for(let d=n[i+1];i+1<n.length&&d.deleted;d=n[++i+1])l+=d.length;r.push(new _i(c,l))}}r.length>0&&t.clients.set(s,r)}),t},fe=(e,t)=>{F(e.restEncoder,t.clients.size),de(t.clients.entries()).sort((n,s)=>s[0]-n[0]).forEach(([n,s])=>{e.resetDsCurVal(),F(e.restEncoder,n);const r=s.length;F(e.restEncoder,r);for(let i=0;i<r;i++){const o=s[i];e.writeDsClock(o.clock),e.writeDsLen(o.len)}})},ts=e=>{const t=new Cn,n=$(e.restDecoder);for(let s=0;s<n;s++){e.resetDsCurVal();const r=$(e.restDecoder),i=$(e.restDecoder);if(i>0){const o=ge(t.clients,r,()=>[]);for(let c=0;c<i;c++)o.push(new _i(e.readDsClock(),e.readDsLen()))}}return t},yo=(e,t,n)=>{const s=new Cn,r=$(e.restDecoder);for(let i=0;i<r;i++){e.resetDsCurVal();const o=$(e.restDecoder),c=$(e.restDecoder),l=n.clients.get(o)||[],d=et(n,o);for(let a=0;a<c;a++){const u=e.readDsClock(),f=u+e.readDsLen();if(u<d){d<f&&Qn(s,o,d,f-d);let g=Gt(l,u),m=l[g];for(!m.deleted&&m.id.clock<u&&(l.splice(g+1,0,Xs(t,m,u-m.id.clock)),g++);g<l.length&&(m=l[g++],m.id.clock<f);)m.deleted||(f<m.id.clock+m.length&&l.splice(g,0,Xs(t,m,f-m.id.clock)),m.delete(t))}else Qn(s,o,u,f-u)}}if(s.clients.size>0){const i=new ze;return F(i.restEncoder,0),fe(i,s),i.toUint8Array()}return null},Nc=_c;class Ze extends gc{constructor({guid:t=vd(),collectionid:n=null,gc:s=!0,gcFilter:r=()=>!0,meta:i=null,autoLoad:o=!1,shouldLoad:c=!0}={}){super(),this.gc=s,this.gcFilter=r,this.clientID=Nc(),this.guid=t,this.collectionid=n,this.share=new Map,this.store=new Wc,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=c,this.autoLoad=o,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=_n(d=>{this.on("load",()=>{this.isLoaded=!0,d(this)})});const l=()=>_n(d=>{const a=u=>{(u===void 0||u===!0)&&(this.off("sync",a),d())};this.on("sync",a)});this.on("sync",d=>{d===!1&&this.isSynced&&(this.whenSynced=l()),this.isSynced=d===void 0||d===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=l()}load(){const t=this._item;t!==null&&!this.shouldLoad&&Y(t.parent.doc,n=>{n.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(de(this.subdocs).map(t=>t.guid))}transact(t,n=null){return Y(this,t,n)}get(t,n=lt){const s=ge(this.share,t,()=>{const i=new n;return i._integrate(this,null),i}),r=s.constructor;if(n!==lt&&r!==n)if(r===lt){const i=new n;i._map=s._map,s._map.forEach(o=>{for(;o!==null;o=o.left)o.parent=i}),i._start=s._start;for(let o=i._start;o!==null;o=o.right)o.parent=i;return i._length=s._length,this.share.set(t,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${t} has already been defined with a different constructor`);return s}getArray(t=""){return this.get(t,Ae)}getText(t=""){return this.get(t,En)}getMap(t=""){return this.get(t,We)}getXmlElement(t=""){return this.get(t,An)}getXmlFragment(t=""){return this.get(t,qe)}toJSON(){const t={};return this.share.forEach((n,s)=>{t[s]=n.toJSON()}),t}destroy(){this.isDestroyed=!0,de(this.subdocs).forEach(n=>n.destroy());const t=this._item;if(t!==null){this._item=null;const n=t.content;n.doc=new Ze({guid:this.guid,...n.opts,shouldLoad:!1}),n.doc._item=t,Y(t.parent.doc,s=>{const r=n.doc;t.deleted||s.subdocsAdded.add(r),s.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}class Ks{constructor(t){this.restDecoder=t}resetDsCurVal(){}readDsClock(){return $(this.restDecoder)}readDsLen(){return $(this.restDecoder)}}class Mc extends Ks{readLeftID(){return N($(this.restDecoder),$(this.restDecoder))}readRightID(){return N($(this.restDecoder),$(this.restDecoder))}readClient(){return $(this.restDecoder)}readInfo(){return Sn(this.restDecoder)}readString(){return He(this.restDecoder)}readParentInfo(){return $(this.restDecoder)===1}readTypeRef(){return $(this.restDecoder)}readLen(){return $(this.restDecoder)}readAny(){return Jn(this.restDecoder)}readBuf(){return Vd(It(this.restDecoder))}readJSON(){return JSON.parse(He(this.restDecoder))}readKey(){return He(this.restDecoder)}}class Qd{constructor(t){this.dsCurrVal=0,this.restDecoder=t}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=$(this.restDecoder),this.dsCurrVal}readDsLen(){const t=$(this.restDecoder)+1;return this.dsCurrVal+=t,t}}class In extends Qd{constructor(t){super(t),this.keys=[],$(t),this.keyClockDecoder=new kr(It(t)),this.clientDecoder=new Vs(It(t)),this.leftClockDecoder=new kr(It(t)),this.rightClockDecoder=new kr(It(t)),this.infoDecoder=new po(It(t),Sn),this.stringDecoder=new yd(It(t)),this.parentInfoDecoder=new po(It(t),Sn),this.typeRefDecoder=new Vs(It(t)),this.lenDecoder=new Vs(It(t))}readLeftID(){return new mn(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new mn(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return Jn(this.restDecoder)}readBuf(){return It(this.restDecoder)}readJSON(){return Jn(this.restDecoder)}readKey(){const t=this.keyClockDecoder.read();if(t<this.keys.length)return this.keys[t];{const n=this.stringDecoder.read();return this.keys.push(n),n}}}class es{constructor(){this.restEncoder=us()}toUint8Array(){return $t(this.restEncoder)}resetDsCurVal(){}writeDsClock(t){F(this.restEncoder,t)}writeDsLen(t){F(this.restEncoder,t)}}class hs extends es{writeLeftID(t){F(this.restEncoder,t.client),F(this.restEncoder,t.clock)}writeRightID(t){F(this.restEncoder,t.client),F(this.restEncoder,t.clock)}writeClient(t){F(this.restEncoder,t)}writeInfo(t){Gn(this.restEncoder,t)}writeString(t){je(this.restEncoder,t)}writeParentInfo(t){F(this.restEncoder,t?1:0)}writeTypeRef(t){F(this.restEncoder,t)}writeLen(t){F(this.restEncoder,t)}writeAny(t){Yn(this.restEncoder,t)}writeBuf(t){kt(this.restEncoder,t)}writeJSON(t){je(this.restEncoder,JSON.stringify(t))}writeKey(t){je(this.restEncoder,t)}}class Ii{constructor(){this.restEncoder=us(),this.dsCurrVal=0}toUint8Array(){return $t(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(t){const n=t-this.dsCurrVal;this.dsCurrVal=t,F(this.restEncoder,n)}writeDsLen(t){t===0&&Lt(),F(this.restEncoder,t-1),this.dsCurrVal+=t}}class ze extends Ii{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new _r,this.clientEncoder=new $s,this.leftClockEncoder=new _r,this.rightClockEncoder=new _r,this.infoEncoder=new uo(Gn),this.stringEncoder=new ld,this.parentInfoEncoder=new uo(Gn),this.typeRefEncoder=new $s,this.lenEncoder=new $s}toUint8Array(){const t=us();return F(t,0),kt(t,this.keyClockEncoder.toUint8Array()),kt(t,this.clientEncoder.toUint8Array()),kt(t,this.leftClockEncoder.toUint8Array()),kt(t,this.rightClockEncoder.toUint8Array()),kt(t,$t(this.infoEncoder)),kt(t,this.stringEncoder.toUint8Array()),kt(t,$t(this.parentInfoEncoder)),kt(t,this.typeRefEncoder.toUint8Array()),kt(t,this.lenEncoder.toUint8Array()),nr(t,$t(this.restEncoder)),$t(t)}writeLeftID(t){this.clientEncoder.write(t.client),this.leftClockEncoder.write(t.clock)}writeRightID(t){this.clientEncoder.write(t.client),this.rightClockEncoder.write(t.clock)}writeClient(t){this.clientEncoder.write(t)}writeInfo(t){this.infoEncoder.write(t)}writeString(t){this.stringEncoder.write(t)}writeParentInfo(t){this.parentInfoEncoder.write(t?1:0)}writeTypeRef(t){this.typeRefEncoder.write(t)}writeLen(t){this.lenEncoder.write(t)}writeAny(t){Yn(this.restEncoder,t)}writeBuf(t){kt(this.restEncoder,t)}writeJSON(t){Yn(this.restEncoder,t)}writeKey(t){const n=this.keyMap.get(t);n===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(t)):this.keyClockEncoder.write(n)}}const tu=(e,t,n,s)=>{s=Xe(s,t[0].id.clock);const r=Gt(t,s);F(e.restEncoder,t.length-r),e.writeClient(n),F(e.restEncoder,s);const i=t[r];i.write(e,s-i.id.clock);for(let o=r+1;o<t.length;o++)t[o].write(e,0)},Ei=(e,t,n)=>{const s=new Map;n.forEach((r,i)=>{et(t,i)>r&&s.set(i,r)}),fs(t).forEach((r,i)=>{n.has(i)||s.set(i,0)}),F(e.restEncoder,s.size),de(s.entries()).sort((r,i)=>i[0]-r[0]).forEach(([r,i])=>{tu(e,t.clients.get(r),r,i)})},eu=(e,t)=>{const n=_t(),s=$(e.restDecoder);for(let r=0;r<s;r++){const i=$(e.restDecoder),o=new Array(i),c=e.readClient();let l=$(e.restDecoder);n.set(c,{i:0,refs:o});for(let d=0;d<i;d++){const a=e.readInfo();switch(tr&a){case 0:{const u=e.readLen();o[d]=new Ot(N(c,l),u),l+=u;break}case 10:{const u=$(e.restDecoder);o[d]=new xt(N(c,l),u),l+=u;break}default:{const u=(a&(oe|Et))===0,f=new X(N(c,l),null,(a&Et)===Et?e.readLeftID():null,null,(a&oe)===oe?e.readRightID():null,u?e.readParentInfo()?t.get(e.readString()):e.readLeftID():null,u&&(a&Wn)===Wn?e.readString():null,ga(e,a));o[d]=f,l+=f.length}}}}return n},nu=(e,t,n)=>{const s=[];let r=de(n.keys()).sort((g,m)=>g-m);if(r.length===0)return null;const i=()=>{if(r.length===0)return null;let g=n.get(r[r.length-1]);for(;g.refs.length===g.i;)if(r.pop(),r.length>0)g=n.get(r[r.length-1]);else return null;return g};let o=i();if(o===null)return null;const c=new Wc,l=new Map,d=(g,m)=>{const v=l.get(g);(v==null||v>m)&&l.set(g,m)};let a=o.refs[o.i++];const u=new Map,f=()=>{for(const g of s){const m=g.id.client,v=n.get(m);v?(v.i--,c.clients.set(m,v.refs.slice(v.i)),n.delete(m),v.i=0,v.refs=[]):c.clients.set(m,[g]),r=r.filter(P=>P!==m)}s.length=0};for(;;){if(a.constructor!==xt){const m=ge(u,a.id.client,()=>et(t,a.id.client))-a.id.clock;if(m<0)s.push(a),d(a.id.client,a.id.clock-1),f();else{const v=a.getMissing(e,t);if(v!==null){s.push(a);const P=n.get(v)||{refs:[],i:0};if(P.refs.length===P.i)d(v,et(t,v)),f();else{a=P.refs[P.i++];continue}}else(m===0||m<a.length)&&(a.integrate(e,m),u.set(a.id.client,a.id.clock+a.length))}}if(s.length>0)a=s.pop();else if(o!==null&&o.i<o.refs.length)a=o.refs[o.i++];else{if(o=i(),o===null)break;a=o.refs[o.i++]}}if(c.clients.size>0){const g=new ze;return Ei(g,c,new Map),F(g.restEncoder,0),{missing:l,update:g.toUint8Array()}}return null},su=(e,t)=>Ei(e,t.doc.store,t.beforeState),ru=(e,t,n,s=new In(e))=>Y(t,r=>{r.local=!1;let i=!1;const o=r.doc,c=o.store,l=eu(s,o),d=nu(r,c,l),a=c.pendingStructs;if(a){for(const[f,g]of a.missing)if(g<et(c,f)){i=!0;break}if(d){for(const[f,g]of d.missing){const m=a.missing.get(f);(m==null||m>g)&&a.missing.set(f,g)}a.update=Ws([a.update,d.update])}}else c.pendingStructs=d;const u=yo(s,r,c);if(c.pendingDs){const f=new In(he(c.pendingDs));$(f.restDecoder);const g=yo(f,r,c);u&&g?c.pendingDs=Ws([u,g]):c.pendingDs=u||g}else c.pendingDs=u;if(i){const f=c.pendingStructs.update;c.pendingStructs=null,Ai(r.doc,f)}},n,!1),Ai=(e,t,n,s=In)=>{const r=he(t);ru(r,e,n,new s(r))},$c=(e,t,n)=>Ai(e,t,n,Mc),iu=(e,t,n=new Map)=>{Ei(e,t.store,n),fe(e,Uc(t.store))},Vc=(e,t=new Uint8Array([0]),n=new ze)=>{const s=Bc(t);iu(n,e,s);const r=[n.toUint8Array()];if(e.store.pendingDs&&r.push(e.store.pendingDs),e.store.pendingStructs&&r.push(Du(e.store.pendingStructs.update,t)),r.length>1){if(n.constructor===hs)return Ou(r.map((i,o)=>o===0?i:Lu(i)));if(n.constructor===ze)return Ws(r)}return r[0]},Ti=(e,t)=>Vc(e,t,new hs),ou=e=>{const t=new Map,n=$(e.restDecoder);for(let s=0;s<n;s++){const r=$(e.restDecoder),i=$(e.restDecoder);t.set(r,i)}return t},Bc=e=>ou(new Ks(he(e))),Ci=(e,t)=>(F(e.restEncoder,t.size),de(t.entries()).sort((n,s)=>s[0]-n[0]).forEach(([n,s])=>{F(e.restEncoder,n),F(e.restEncoder,s)}),e),cu=(e,t)=>Ci(e,fs(t.store)),au=(e,t=new Ii)=>(e instanceof Map?Ci(t,e):cu(t,e),t.toUint8Array()),lu=e=>au(e,new es);class du{constructor(){this.l=[]}}const wo=()=>new du,bo=(e,t)=>e.l.push(t),vo=(e,t)=>{const n=e.l,s=n.length;e.l=n.filter(r=>t!==r),s===e.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},Fc=(e,t,n)=>vi(e.l,[t,n]);class mn{constructor(t,n){this.client=t,this.clock=n}}const hn=(e,t)=>e===t||e!==null&&t!==null&&e.client===t.client&&e.clock===t.clock,N=(e,t)=>new mn(e,t),So=(e,t)=>{F(e,t.client),F(e,t.clock)},_o=e=>N($(e),$(e)),jc=e=>{for(const[t,n]of e.doc.share.entries())if(n===e)return t;throw Lt()},zs=(e,t)=>{for(;t!==null;){if(t.parent===e)return!0;t=t.parent._item}return!1};class uu{constructor(t,n=t.getMap("users")){const s=new Map;this.yusers=n,this.doc=t,this.clients=new Map,this.dss=s;const r=(i,o)=>{const c=i.get("ds"),l=i.get("ids"),d=a=>this.clients.set(a,o);c.observe(a=>{a.changes.added.forEach(u=>{u.content.getContent().forEach(f=>{f instanceof Uint8Array&&this.dss.set(o,Zn([this.dss.get(o)||Pc(),ts(new Ks(he(f)))]))})})}),this.dss.set(o,Zn(c.map(a=>ts(new Ks(he(a)))))),l.observe(a=>a.changes.added.forEach(u=>u.content.getContent().forEach(d))),l.forEach(d)};n.observe(i=>{i.keysChanged.forEach(o=>r(n.get(o),o))}),n.forEach(r)}setUserMapping(t,n,s,{filter:r=()=>!0}={}){const i=this.yusers;let o=i.get(s);o||(o=new We,o.set("ids",new Ae),o.set("ds",new Ae),i.set(s,o)),o.get("ids").push([n]),i.observe(c=>{setTimeout(()=>{const l=i.get(s);if(l!==o){o=l,this.clients.forEach((u,f)=>{s===u&&o.get("ids").push([f])});const d=new es,a=this.dss.get(s);a&&(fe(d,a),o.get("ds").push([d.toUint8Array()]))}},0)}),t.on("afterTransaction",c=>{setTimeout(()=>{const l=o.get("ds"),d=c.deleteSet;if(c.local&&d.clients.size>0&&r(c,d)){const a=new es;fe(a,d),l.push([a.toUint8Array()])}})})}getUserByClientId(t){return this.clients.get(t)||null}getUserByDeletedId(t){for(const[n,s]of this.dss.entries())if(On(s,t))return n;return null}}class Oi{constructor(t,n,s,r=0){this.type=t,this.tname=n,this.item=s,this.assoc=r}}const hu=e=>new Oi(e.type==null?null:N(e.type.client,e.type.clock),e.tname??null,e.item==null?null:N(e.item.client,e.item.clock),e.assoc==null?0:e.assoc);class fu{constructor(t,n,s=0){this.type=t,this.index=n,this.assoc=s}}const pu=(e,t,n=0)=>new fu(e,t,n),As=(e,t,n)=>{let s=null,r=null;return e._item===null?r=jc(e):s=N(e._item.id.client,e._item.id.clock),new Oi(s,r,t,n)},Hc=(e,t,n=0)=>{let s=e._start;if(n<0){if(t===0)return As(e,null,n);t--}for(;s!==null;){if(!s.deleted&&s.countable){if(s.length>t)return As(e,N(s.id.client,s.id.clock+t),n);t-=s.length}if(s.right===null&&n<0)return As(e,s.lastId,n);s=s.right}return As(e,null,n)},gu=(e,t)=>{const{type:n,tname:s,item:r,assoc:i}=t;if(r!==null)F(e,0),So(e,r);else if(s!==null)Gn(e,1),je(e,s);else if(n!==null)Gn(e,2),So(e,n);else throw Lt();return er(e,i),e},mu=e=>{const t=us();return gu(t,e),$t(t)},yu=e=>{let t=null,n=null,s=null;switch($(e)){case 0:s=_o(e);break;case 1:n=He(e);break;case 2:t=_o(e)}const r=Sc(e)?rr(e):0;return new Oi(t,n,s,r)},Kc=e=>yu(he(e)),wu=(e,t)=>{const n=yn(e,t),s=t.clock-n.id.clock;return{item:n,diff:s}},zc=(e,t,n=!0)=>{const s=t.store,r=e.item,i=e.type,o=e.tname,c=e.assoc;let l=null,d=0;if(r!==null){if(et(s,r.client)<=r.clock)return null;const a=n?Zr(s,r):wu(s,r),u=a.item;if(!(u instanceof X))return null;if(l=u.parent,l._item===null||!l._item.deleted){d=u.deleted||!u.countable?0:a.diff+(c>=0?0:1);let f=u.left;for(;f!==null;)!f.deleted&&f.countable&&(d+=f.length),f=f.left}}else{if(o!==null)l=t.get(o);else if(i!==null){if(et(s,i.client)<=i.clock)return null;const{item:a}=n?Zr(s,i):{item:yn(s,i)};if(a instanceof X&&a.content instanceof Xt)l=a.content.type;else return null}else throw Lt();c>=0?d=l._length:d=0}return pu(l,d,e.assoc)},vm=(e,t)=>e===t||e!==null&&t!==null&&e.tname===t.tname&&hn(e.item,t.item)&&hn(e.type,t.type)&&e.assoc===t.assoc;class bu{constructor(t,n){this.ds=t,this.sv=n}}const Gr=(e,t=new Ii)=>(fe(t,e.ds),Ci(t,e.sv),t.toUint8Array()),ko=e=>Gr(e,new es),vu=(e,t)=>new bu(e,t),Ts=e=>vu(Uc(e.store),fs(e.store)),ln=(e,t)=>t===void 0?!e.deleted:t.sv.has(e.id.client)&&(t.sv.get(e.id.client)||0)>e.id.clock&&!On(t.ds,e.id),Yr=(e,t)=>{const n=ge(e.meta,Yr,Ke),s=e.doc.store;n.has(t)||(t.sv.forEach((r,i)=>{r<et(s,i)&&St(e,N(i,r))}),kn(e,t.ds,r=>{}),n.add(t))};class Wc{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const fs=e=>{const t=new Map;return e.clients.forEach((n,s)=>{const r=n[n.length-1];t.set(s,r.id.clock+r.length)}),t},et=(e,t)=>{const n=e.clients.get(t);if(n===void 0)return 0;const s=n[n.length-1];return s.id.clock+s.length},qc=(e,t)=>{let n=e.clients.get(t.id.client);if(n===void 0)n=[],e.clients.set(t.id.client,n);else{const s=n[n.length-1];if(s.id.clock+s.length!==t.id.clock)throw Lt()}n.push(t)},Gt=(e,t)=>{let n=0,s=e.length-1,r=e[s],i=r.id.clock;if(i===t)return s;let o=Oe(t/(i+r.length-1)*s);for(;n<=s;){if(r=e[o],i=r.id.clock,i<=t){if(t<i+r.length)return o;n=o+1}else s=o-1;o=Oe((n+s)/2)}throw Lt()},Su=(e,t)=>{const n=e.clients.get(t.client);return n[Gt(n,t.clock)]},yn=Su,Jr=(e,t,n)=>{const s=Gt(t,n),r=t[s];return r.id.clock<n&&r instanceof X?(t.splice(s+1,0,Xs(e,r,n-r.id.clock)),s+1):s},St=(e,t)=>{const n=e.doc.store.clients.get(t.client);return n[Jr(e,n,t.clock)]},Io=(e,t,n)=>{const s=t.clients.get(n.client),r=Gt(s,n.clock),i=s[r];return n.clock!==i.id.clock+i.length-1&&i.constructor!==Ot&&s.splice(r+1,0,Xs(e,i,n.clock-i.id.clock+1)),i},_u=(e,t,n)=>{const s=e.clients.get(t.id.client);s[Gt(s,t.id.clock)]=n},Gc=(e,t,n,s,r)=>{if(s===0)return;const i=n+s;let o=Jr(e,t,n),c;do c=t[o++],i<c.id.clock+c.length&&Jr(e,t,i),r(c);while(o<t.length&&t[o].id.clock<i)};class ku{constructor(t,n,s){this.doc=t,this.deleteSet=new Cn,this.beforeState=fs(t.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=n,this.meta=new Map,this.local=s,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const Eo=(e,t)=>t.deleteSet.clients.size===0&&!Fl(t.afterState,(n,s)=>t.beforeState.get(s)!==n)?!1:(ki(t.deleteSet),su(e,t),fe(e,t.deleteSet),!0),Ao=(e,t,n)=>{const s=t._item;(s===null||s.id.clock<(e.beforeState.get(s.id.client)||0)&&!s.deleted)&&ge(e.changed,t,Ke).add(n)},Bs=(e,t)=>{let n=e[t],s=e[t-1],r=t;for(;r>0;n=s,s=e[--r-1]){if(s.deleted===n.deleted&&s.constructor===n.constructor&&s.mergeWith(n)){n instanceof X&&n.parentSub!==null&&n.parent._map.get(n.parentSub)===n&&n.parent._map.set(n.parentSub,s);continue}break}const i=t-r;return i&&e.splice(t+1-i,i),i},Iu=(e,t,n)=>{for(const[s,r]of e.clients.entries()){const i=t.clients.get(s);for(let o=r.length-1;o>=0;o--){const c=r[o],l=c.clock+c.len;for(let d=Gt(i,c.clock),a=i[d];d<i.length&&a.id.clock<l;a=i[++d]){const u=i[d];if(c.clock+c.len<=u.id.clock)break;u instanceof X&&u.deleted&&!u.keep&&n(u)&&u.gc(t,!1)}}}},Eu=(e,t)=>{e.clients.forEach((n,s)=>{const r=t.clients.get(s);for(let i=n.length-1;i>=0;i--){const o=n[i],c=mc(r.length-1,1+Gt(r,o.clock+o.len-1));for(let l=c,d=r[l];l>0&&d.id.clock>=o.clock;d=r[l])l-=1+Bs(r,l)}})},Yc=(e,t)=>{if(t<e.length){const n=e[t],s=n.doc,r=s.store,i=n.deleteSet,o=n._mergeStructs;try{ki(i),n.afterState=fs(n.doc.store),s.emit("beforeObserverCalls",[n,s]);const c=[];n.changed.forEach((l,d)=>c.push(()=>{(d._item===null||!d._item.deleted)&&d._callObserver(n,l)})),c.push(()=>{n.changedParentTypes.forEach((l,d)=>{d._dEH.l.length>0&&(d._item===null||!d._item.deleted)&&(l=l.filter(a=>a.target._item===null||!a.target._item.deleted),l.forEach(a=>{a.currentTarget=d,a._path=null}),l.sort((a,u)=>a.path.length-u.path.length),Fc(d._dEH,l,n))})}),c.push(()=>s.emit("afterTransaction",[n,s])),vi(c,[]),n._needFormattingCleanup&&qu(n)}finally{s.gc&&Iu(i,r,s.gcFilter),Eu(i,r),n.afterState.forEach((a,u)=>{const f=n.beforeState.get(u)||0;if(f!==a){const g=r.clients.get(u),m=Xe(Gt(g,f),1);for(let v=g.length-1;v>=m;)v-=1+Bs(g,v)}});for(let a=o.length-1;a>=0;a--){const{client:u,clock:f}=o[a].id,g=r.clients.get(u),m=Gt(g,f);m+1<g.length&&Bs(g,m+1)>1||m>0&&Bs(g,m)}if(!n.local&&n.afterState.get(s.clientID)!==n.beforeState.get(s.clientID)&&(Jd(Si,Tc,"[yjs] ",Cc,Oc,"Changed the client-id because another client seems to be using it."),s.clientID=Nc()),s.emit("afterTransactionCleanup",[n,s]),s._observers.has("update")){const a=new hs;Eo(a,n)&&s.emit("update",[a.toUint8Array(),n.origin,s,n])}if(s._observers.has("updateV2")){const a=new ze;Eo(a,n)&&s.emit("updateV2",[a.toUint8Array(),n.origin,s,n])}const{subdocsAdded:c,subdocsLoaded:l,subdocsRemoved:d}=n;(c.size>0||d.size>0||l.size>0)&&(c.forEach(a=>{a.clientID=s.clientID,a.collectionid==null&&(a.collectionid=s.collectionid),s.subdocs.add(a)}),d.forEach(a=>s.subdocs.delete(a)),s.emit("subdocs",[{loaded:l,added:c,removed:d},s,n]),d.forEach(a=>a.destroy())),e.length<=t+1?(s._transactionCleanups=[],s.emit("afterAllTransactions",[s,e])):Yc(e,t+1)}}},Y=(e,t,n=null,s=!0)=>{const r=e._transactionCleanups;let i=!1,o=null;e._transaction===null&&(i=!0,e._transaction=new ku(e,n,s),r.push(e._transaction),r.length===1&&e.emit("beforeAllTransactions",[e]),e.emit("beforeTransaction",[e._transaction,e]));try{o=t(e._transaction)}finally{if(i){const c=e._transaction===r[0];e._transaction=null,c&&Yc(r,0)}}return o};class Au{constructor(t,n){this.insertions=n,this.deletions=t,this.meta=new Map}}const To=(e,t,n)=>{kn(e,n.deletions,s=>{s instanceof X&&t.scope.some(r=>r===e.doc||zs(r,s))&&Mi(s,!1)})},Co=(e,t,n)=>{let s=null;const r=e.doc,i=e.scope;Y(r,c=>{for(;t.length>0&&e.currStackItem===null;){const l=r.store,d=t.pop(),a=new Set,u=[];let f=!1;kn(c,d.insertions,g=>{if(g instanceof X){if(g.redone!==null){let{item:m,diff:v}=Zr(l,g.id);v>0&&(m=St(c,N(m.id.client,m.id.clock+v))),g=m}!g.deleted&&i.some(m=>m===c.doc||zs(m,g))&&u.push(g)}}),kn(c,d.deletions,g=>{g instanceof X&&i.some(m=>m===c.doc||zs(m,g))&&!On(d.insertions,g.id)&&a.add(g)}),a.forEach(g=>{f=pa(c,g,a,d.insertions,e.ignoreRemoteMapChanges,e)!==null||f});for(let g=u.length-1;g>=0;g--){const m=u[g];e.deleteFilter(m)&&(m.delete(c),f=!0)}e.currStackItem=f?d:null}c.changed.forEach((l,d)=>{l.has(null)&&d._searchMarker&&(d._searchMarker.length=0)}),s=c},e);const o=e.currStackItem;if(o!=null){const c=s.changedParentTypes;e.emit("stack-item-popped",[{stackItem:o,type:n,changedParentTypes:c,origin:e},e]),e.currStackItem=null}return o};class Tu extends gc{constructor(t,{captureTimeout:n=500,captureTransaction:s=l=>!0,deleteFilter:r=()=>!0,trackedOrigins:i=new Set([null]),ignoreRemoteMapChanges:o=!1,doc:c=Kr(t)?t[0].doc:t instanceof Ze?t:t.doc}={}){super(),this.scope=[],this.doc=c,this.addToScope(t),this.deleteFilter=r,i.add(this),this.trackedOrigins=i,this.captureTransaction=s,this.undoStack=[],this.redoStack=[],this.undoing=!1,this.redoing=!1,this.currStackItem=null,this.lastChange=0,this.ignoreRemoteMapChanges=o,this.captureTimeout=n,this.afterTransactionHandler=l=>{if(!this.captureTransaction(l)||!this.scope.some(P=>l.changedParentTypes.has(P)||P===this.doc)||!this.trackedOrigins.has(l.origin)&&(!l.origin||!this.trackedOrigins.has(l.origin.constructor)))return;const d=this.undoing,a=this.redoing,u=d?this.redoStack:this.undoStack;d?this.stopCapturing():a||this.clear(!1,!0);const f=new Cn;l.afterState.forEach((P,L)=>{const I=l.beforeState.get(L)||0,U=P-I;U>0&&Qn(f,L,I,U)});const g=Sd();let m=!1;if(this.lastChange>0&&g-this.lastChange<this.captureTimeout&&u.length>0&&!d&&!a){const P=u[u.length-1];P.deletions=Zn([P.deletions,l.deleteSet]),P.insertions=Zn([P.insertions,f])}else u.push(new Au(l.deleteSet,f)),m=!0;!d&&!a&&(this.lastChange=g),kn(l,l.deleteSet,P=>{P instanceof X&&this.scope.some(L=>L===l.doc||zs(L,P))&&Mi(P,!0)});const v=[{stackItem:u[u.length-1],origin:l.origin,type:d?"redo":"undo",changedParentTypes:l.changedParentTypes},this];m?this.emit("stack-item-added",v):this.emit("stack-item-updated",v)},this.doc.on("afterTransaction",this.afterTransactionHandler),this.doc.on("destroy",()=>{this.destroy()})}addToScope(t){const n=new Set(this.scope);t=Kr(t)?t:[t],t.forEach(s=>{n.has(s)||(n.add(s),(s instanceof lt?s.doc!==this.doc:s!==this.doc)&&Dc("[yjs#509] Not same Y.Doc"),this.scope.push(s))})}addTrackedOrigin(t){this.trackedOrigins.add(t)}removeTrackedOrigin(t){this.trackedOrigins.delete(t)}clear(t=!0,n=!0){(t&&this.canUndo()||n&&this.canRedo())&&this.doc.transact(s=>{t&&(this.undoStack.forEach(r=>To(s,this,r)),this.undoStack=[]),n&&(this.redoStack.forEach(r=>To(s,this,r)),this.redoStack=[]),this.emit("stack-cleared",[{undoStackCleared:t,redoStackCleared:n}])})}stopCapturing(){this.lastChange=0}undo(){this.undoing=!0;let t;try{t=Co(this,this.undoStack,"undo")}finally{this.undoing=!1}return t}redo(){this.redoing=!0;let t;try{t=Co(this,this.redoStack,"redo")}finally{this.redoing=!1}return t}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}destroy(){this.trackedOrigins.delete(this),this.doc.off("afterTransaction",this.afterTransactionHandler),super.destroy()}}function*Cu(e){const t=$(e.restDecoder);for(let n=0;n<t;n++){const s=$(e.restDecoder),r=e.readClient();let i=$(e.restDecoder);for(let o=0;o<s;o++){const c=e.readInfo();if(c===10){const l=$(e.restDecoder);yield new xt(N(r,i),l),i+=l}else if((tr&c)!==0){const l=(c&(oe|Et))===0,d=new X(N(r,i),null,(c&Et)===Et?e.readLeftID():null,null,(c&oe)===oe?e.readRightID():null,l?e.readParentInfo()?e.readString():e.readLeftID():null,l&&(c&Wn)===Wn?e.readString():null,ga(e,c));yield d,i+=d.length}else{const l=e.readLen();yield new Ot(N(r,i),l),i+=l}}}}class xi{constructor(t,n){this.gen=Cu(t),this.curr=null,this.done=!1,this.filterSkips=n,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===xt);return this.curr}}class Di{constructor(t){this.currClient=0,this.startClock=0,this.written=0,this.encoder=t,this.clientStructs=[]}}const Ou=e=>Ws(e,Mc,hs),xu=(e,t)=>{if(e.constructor===Ot){const{client:n,clock:s}=e.id;return new Ot(N(n,s+t),e.length-t)}else if(e.constructor===xt){const{client:n,clock:s}=e.id;return new xt(N(n,s+t),e.length-t)}else{const n=e,{client:s,clock:r}=n.id;return new X(N(s,r+t),null,N(s,r+t-1),null,n.rightOrigin,n.parent,n.parentSub,n.content.splice(t))}},Ws=(e,t=In,n=ze)=>{if(e.length===1)return e[0];const s=e.map(a=>new t(he(a)));let r=s.map(a=>new xi(a,!0)),i=null;const o=new n,c=new Di(o);for(;r=r.filter(f=>f.curr!==null),r.sort((f,g)=>{if(f.curr.id.client===g.curr.id.client){const m=f.curr.id.clock-g.curr.id.clock;return m===0?f.curr.constructor===g.curr.constructor?0:f.curr.constructor===xt?1:-1:m}else return g.curr.id.client-f.curr.id.client}),r.length!==0;){const a=r[0],u=a.curr.id.client;if(i!==null){let f=a.curr,g=!1;for(;f!==null&&f.id.clock+f.length<=i.struct.id.clock+i.struct.length&&f.id.client>=i.struct.id.client;)f=a.next(),g=!0;if(f===null||f.id.client!==u||g&&f.id.clock>i.struct.id.clock+i.struct.length)continue;if(u!==i.struct.id.client)ke(c,i.struct,i.offset),i={struct:f,offset:0},a.next();else if(i.struct.id.clock+i.struct.length<f.id.clock)if(i.struct.constructor===xt)i.struct.length=f.id.clock+f.length-i.struct.id.clock;else{ke(c,i.struct,i.offset);const m=f.id.clock-i.struct.id.clock-i.struct.length;i={struct:new xt(N(u,i.struct.id.clock+i.struct.length),m),offset:0}}else{const m=i.struct.id.clock+i.struct.length-f.id.clock;m>0&&(i.struct.constructor===xt?i.struct.length-=m:f=xu(f,m)),i.struct.mergeWith(f)||(ke(c,i.struct,i.offset),i={struct:f,offset:0},a.next())}}else i={struct:a.curr,offset:0},a.next();for(let f=a.curr;f!==null&&f.id.client===u&&f.id.clock===i.struct.id.clock+i.struct.length&&f.constructor!==xt;f=a.next())ke(c,i.struct,i.offset),i={struct:f,offset:0}}i!==null&&(ke(c,i.struct,i.offset),i=null),Ri(c);const l=s.map(a=>ts(a)),d=Zn(l);return fe(o,d),o.toUint8Array()},Du=(e,t,n=In,s=ze)=>{const r=Bc(t),i=new s,o=new Di(i),c=new n(he(e)),l=new xi(c,!1);for(;l.curr;){const a=l.curr,u=a.id.client,f=r.get(u)||0;if(l.curr.constructor===xt){l.next();continue}if(a.id.clock+a.length>f)for(ke(o,a,Xe(f-a.id.clock,0)),l.next();l.curr&&l.curr.id.client===u;)ke(o,l.curr,0),l.next();else for(;l.curr&&l.curr.id.client===u&&l.curr.id.clock+l.curr.length<=f;)l.next()}Ri(o);const d=ts(c);return fe(i,d),i.toUint8Array()},Jc=e=>{e.written>0&&(e.clientStructs.push({written:e.written,restEncoder:$t(e.encoder.restEncoder)}),e.encoder.restEncoder=us(),e.written=0)},ke=(e,t,n)=>{e.written>0&&e.currClient!==t.id.client&&Jc(e),e.written===0&&(e.currClient=t.id.client,e.encoder.writeClient(t.id.client),F(e.encoder.restEncoder,t.id.clock+n)),t.write(e.encoder,n),e.written++},Ri=e=>{Jc(e);const t=e.encoder.restEncoder;F(t,e.clientStructs.length);for(let n=0;n<e.clientStructs.length;n++){const s=e.clientStructs[n];F(t,s.written),nr(t,s.restEncoder)}},Ru=(e,t,n,s)=>{const r=new n(he(e)),i=new xi(r,!1),o=new s,c=new Di(o);for(let d=i.curr;d!==null;d=i.next())ke(c,t(d),0);Ri(c);const l=ts(r);return fe(o,l),o.toUint8Array()},Lu=e=>Ru(e,Ld,In,hs),Oo="You must not compute changes after the event-handler fired.";class ir{constructor(t,n){this.target=t,this.currentTarget=t,this.transaction=n,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=Pu(this.currentTarget,this.target))}deletes(t){return On(this.transaction.deleteSet,t.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw ue(Oo);const t=new Map,n=this.target;this.transaction.changed.get(n).forEach(r=>{if(r!==null){const i=n._map.get(r);let o,c;if(this.adds(i)){let l=i.left;for(;l!==null&&this.adds(l);)l=l.left;if(this.deletes(i))if(l!==null&&this.deletes(l))o="delete",c=br(l.content.getContent());else return;else l!==null&&this.deletes(l)?(o="update",c=br(l.content.getContent())):(o="add",c=void 0)}else if(this.deletes(i))o="delete",c=br(i.content.getContent());else return;t.set(r,{action:o,oldValue:c})}}),this._keys=t}return this._keys}get delta(){return this.changes.delta}adds(t){return t.id.clock>=(this.transaction.beforeState.get(t.id.client)||0)}get changes(){let t=this._changes;if(t===null){if(this.transaction.doc._transactionCleanups.length===0)throw ue(Oo);const n=this.target,s=Ke(),r=Ke(),i=[];if(t={added:s,deleted:r,delta:i,keys:this.keys},this.transaction.changed.get(n).has(null)){let c=null;const l=()=>{c&&i.push(c)};for(let d=n._start;d!==null;d=d.right)d.deleted?this.deletes(d)&&!this.adds(d)&&((c===null||c.delete===void 0)&&(l(),c={delete:0}),c.delete+=d.length,r.add(d)):this.adds(d)?((c===null||c.insert===void 0)&&(l(),c={insert:[]}),c.insert=c.insert.concat(d.content.getContent()),s.add(d)):((c===null||c.retain===void 0)&&(l(),c={retain:0}),c.retain+=d.length);c!==null&&c.retain===void 0&&l()}this._changes=t}return t}}const Pu=(e,t)=>{const n=[];for(;t._item!==null&&t!==e;){if(t._item.parentSub!==null)n.unshift(t._item.parentSub);else{let s=0,r=t._item.parent._start;for(;r!==t._item&&r!==null;)!r.deleted&&r.countable&&(s+=r.length),r=r.right;n.unshift(s)}t=t._item.parent}return n},mt=()=>{Dc("Invalid access: Add Yjs type to a document before reading data.")},Xc=80;let Li=0;class Uu{constructor(t,n){t.marker=!0,this.p=t,this.index=n,this.timestamp=Li++}}const Nu=e=>{e.timestamp=Li++},Zc=(e,t,n)=>{e.p.marker=!1,e.p=t,t.marker=!0,e.index=n,e.timestamp=Li++},Mu=(e,t,n)=>{if(e.length>=Xc){const s=e.reduce((r,i)=>r.timestamp<i.timestamp?r:i);return Zc(s,t,n),s}else{const s=new Uu(t,n);return e.push(s),s}},or=(e,t)=>{if(e._start===null||t===0||e._searchMarker===null)return null;const n=e._searchMarker.length===0?null:e._searchMarker.reduce((i,o)=>Ms(t-i.index)<Ms(t-o.index)?i:o);let s=e._start,r=0;for(n!==null&&(s=n.p,r=n.index,Nu(n));s.right!==null&&r<t;){if(!s.deleted&&s.countable){if(t<r+s.length)break;r+=s.length}s=s.right}for(;s.left!==null&&r>t;)s=s.left,!s.deleted&&s.countable&&(r-=s.length);for(;s.left!==null&&s.left.id.client===s.id.client&&s.left.id.clock+s.left.length===s.id.clock;)s=s.left,!s.deleted&&s.countable&&(r-=s.length);return n!==null&&Ms(n.index-r)<s.parent.length/Xc?(Zc(n,s,r),n):Mu(e._searchMarker,s,r)},ns=(e,t,n)=>{for(let s=e.length-1;s>=0;s--){const r=e[s];if(n>0){let i=r.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(r.index-=i.length);if(i===null||i.marker===!0){e.splice(s,1);continue}r.p=i,i.marker=!0}(t<r.index||n>0&&t===r.index)&&(r.index=Xe(t,r.index+n))}},cr=(e,t,n)=>{const s=e,r=t.changedParentTypes;for(;ge(r,e,()=>[]).push(n),e._item!==null;)e=e._item.parent;Fc(s._eH,n,t)};class lt{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=wo(),this._dEH=wo(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(t,n){this.doc=t,this._item=n}_copy(){throw Wt()}clone(){throw Wt()}_write(t){}get _first(){let t=this._start;for(;t!==null&&t.deleted;)t=t.right;return t}_callObserver(t,n){!t.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(t){bo(this._eH,t)}observeDeep(t){bo(this._dEH,t)}unobserve(t){vo(this._eH,t)}unobserveDeep(t){vo(this._dEH,t)}toJSON(){}}const Qc=(e,t,n)=>{e.doc??mt(),t<0&&(t=e._length+t),n<0&&(n=e._length+n);let s=n-t;const r=[];let i=e._start;for(;i!==null&&s>0;){if(i.countable&&!i.deleted){const o=i.content.getContent();if(o.length<=t)t-=o.length;else{for(let c=t;c<o.length&&s>0;c++)r.push(o[c]),s--;t=0}}i=i.right}return r},ta=e=>{e.doc??mt();const t=[];let n=e._start;for(;n!==null;){if(n.countable&&!n.deleted){const s=n.content.getContent();for(let r=0;r<s.length;r++)t.push(s[r])}n=n.right}return t},ss=(e,t)=>{let n=0,s=e._start;for(e.doc??mt();s!==null;){if(s.countable&&!s.deleted){const r=s.content.getContent();for(let i=0;i<r.length;i++)t(r[i],n++,e)}s=s.right}},ea=(e,t)=>{const n=[];return ss(e,(s,r)=>{n.push(t(s,r,e))}),n},$u=e=>{let t=e._start,n=null,s=0;return{[Symbol.iterator](){return this},next:()=>{if(n===null){for(;t!==null&&t.deleted;)t=t.right;if(t===null)return{done:!0,value:void 0};n=t.content.getContent(),s=0,t=t.right}const r=n[s++];return n.length<=s&&(n=null),{done:!1,value:r}}}},na=(e,t)=>{e.doc??mt();const n=or(e,t);let s=e._start;for(n!==null&&(s=n.p,t-=n.index);s!==null;s=s.right)if(!s.deleted&&s.countable){if(t<s.length)return s.content.getContent()[t];t-=s.length}},qs=(e,t,n,s)=>{let r=n;const i=e.doc,o=i.clientID,c=i.store,l=n===null?t._start:n.right;let d=[];const a=()=>{d.length>0&&(r=new X(N(o,et(c,o)),r,r&&r.lastId,l,l&&l.id,t,null,new Ge(d)),r.integrate(e,0),d=[])};s.forEach(u=>{if(u===null)d.push(u);else switch(u.constructor){case Number:case Object:case Boolean:case Array:case String:d.push(u);break;default:switch(a(),u.constructor){case Uint8Array:case ArrayBuffer:r=new X(N(o,et(c,o)),r,r&&r.lastId,l,l&&l.id,t,null,new ps(new Uint8Array(u))),r.integrate(e,0);break;case Ze:r=new X(N(o,et(c,o)),r,r&&r.lastId,l,l&&l.id,t,null,new gs(u)),r.integrate(e,0);break;default:if(u instanceof lt)r=new X(N(o,et(c,o)),r,r&&r.lastId,l,l&&l.id,t,null,new Xt(u)),r.integrate(e,0);else throw new Error("Unexpected content type in insert operation")}}}),a()},sa=()=>ue("Length exceeded!"),ra=(e,t,n,s)=>{if(n>t._length)throw sa();if(n===0)return t._searchMarker&&ns(t._searchMarker,n,s.length),qs(e,t,null,s);const r=n,i=or(t,n);let o=t._start;for(i!==null&&(o=i.p,n-=i.index,n===0&&(o=o.prev,n+=o&&o.countable&&!o.deleted?o.length:0));o!==null;o=o.right)if(!o.deleted&&o.countable){if(n<=o.length){n<o.length&&St(e,N(o.id.client,o.id.clock+n));break}n-=o.length}return t._searchMarker&&ns(t._searchMarker,r,s.length),qs(e,t,o,s)},Vu=(e,t,n)=>{let r=(t._searchMarker||[]).reduce((i,o)=>o.index>i.index?o:i,{index:0,p:t._start}).p;if(r)for(;r.right;)r=r.right;return qs(e,t,r,n)},ia=(e,t,n,s)=>{if(s===0)return;const r=n,i=s,o=or(t,n);let c=t._start;for(o!==null&&(c=o.p,n-=o.index);c!==null&&n>0;c=c.right)!c.deleted&&c.countable&&(n<c.length&&St(e,N(c.id.client,c.id.clock+n)),n-=c.length);for(;s>0&&c!==null;)c.deleted||(s<c.length&&St(e,N(c.id.client,c.id.clock+s)),c.delete(e),s-=c.length),c=c.right;if(s>0)throw sa();t._searchMarker&&ns(t._searchMarker,r,-i+s)},Gs=(e,t,n)=>{const s=t._map.get(n);s!==void 0&&s.delete(e)},Pi=(e,t,n,s)=>{const r=t._map.get(n)||null,i=e.doc,o=i.clientID;let c;if(s==null)c=new Ge([s]);else switch(s.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:c=new Ge([s]);break;case Uint8Array:c=new ps(s);break;case Ze:c=new gs(s);break;default:if(s instanceof lt)c=new Xt(s);else throw new Error("Unexpected content type")}new X(N(o,et(i.store,o)),r,r&&r.lastId,null,null,t,n,c).integrate(e,0)},Ui=(e,t)=>{e.doc??mt();const n=e._map.get(t);return n!==void 0&&!n.deleted?n.content.getContent()[n.length-1]:void 0},oa=e=>{const t={};return e.doc??mt(),e._map.forEach((n,s)=>{n.deleted||(t[s]=n.content.getContent()[n.length-1])}),t},ca=(e,t)=>{e.doc??mt();const n=e._map.get(t);return n!==void 0&&!n.deleted},Bu=(e,t)=>{const n={};return e._map.forEach((s,r)=>{let i=s;for(;i!==null&&(!t.sv.has(i.id.client)||i.id.clock>=(t.sv.get(i.id.client)||0));)i=i.left;i!==null&&ln(i,t)&&(n[r]=i.content.getContent()[i.length-1])}),n},Cs=e=>(e.doc??mt(),Xd(e._map.entries(),t=>!t[1].deleted));class Fu extends ir{}class Ae extends lt{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(t){const n=new Ae;return n.push(t),n}_integrate(t,n){super._integrate(t,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Ae}clone(){const t=new Ae;return t.insert(0,this.toArray().map(n=>n instanceof lt?n.clone():n)),t}get length(){return this.doc??mt(),this._length}_callObserver(t,n){super._callObserver(t,n),cr(this,t,new Fu(this,t))}insert(t,n){this.doc!==null?Y(this.doc,s=>{ra(s,this,t,n)}):this._prelimContent.splice(t,0,...n)}push(t){this.doc!==null?Y(this.doc,n=>{Vu(n,this,t)}):this._prelimContent.push(...t)}unshift(t){this.insert(0,t)}delete(t,n=1){this.doc!==null?Y(this.doc,s=>{ia(s,this,t,n)}):this._prelimContent.splice(t,n)}get(t){return na(this,t)}toArray(){return ta(this)}slice(t=0,n=this.length){return Qc(this,t,n)}toJSON(){return this.map(t=>t instanceof lt?t.toJSON():t)}map(t){return ea(this,t)}forEach(t){ss(this,t)}[Symbol.iterator](){return $u(this)}_write(t){t.writeTypeRef(uh)}}const ju=e=>new Ae;class Hu extends ir{constructor(t,n,s){super(t,n),this.keysChanged=s}}class We extends lt{constructor(t){super(),this._prelimContent=null,t===void 0?this._prelimContent=new Map:this._prelimContent=new Map(t)}_integrate(t,n){super._integrate(t,n),this._prelimContent.forEach((s,r)=>{this.set(r,s)}),this._prelimContent=null}_copy(){return new We}clone(){const t=new We;return this.forEach((n,s)=>{t.set(s,n instanceof lt?n.clone():n)}),t}_callObserver(t,n){cr(this,t,new Hu(this,t,n))}toJSON(){this.doc??mt();const t={};return this._map.forEach((n,s)=>{if(!n.deleted){const r=n.content.getContent()[n.length-1];t[s]=r instanceof lt?r.toJSON():r}}),t}get size(){return[...Cs(this)].length}keys(){return Ir(Cs(this),t=>t[0])}values(){return Ir(Cs(this),t=>t[1].content.getContent()[t[1].length-1])}entries(){return Ir(Cs(this),t=>[t[0],t[1].content.getContent()[t[1].length-1]])}forEach(t){this.doc??mt(),this._map.forEach((n,s)=>{n.deleted||t(n.content.getContent()[n.length-1],s,this)})}[Symbol.iterator](){return this.entries()}delete(t){this.doc!==null?Y(this.doc,n=>{Gs(n,this,t)}):this._prelimContent.delete(t)}set(t,n){return this.doc!==null?Y(this.doc,s=>{Pi(s,this,t,n)}):this._prelimContent.set(t,n),n}get(t){return Ui(this,t)}has(t){return ca(this,t)}clear(){this.doc!==null?Y(this.doc,t=>{this.forEach(function(n,s,r){Gs(t,r,s)})}):this._prelimContent.clear()}_write(t){t.writeTypeRef(hh)}}const Ku=e=>new We,Ee=(e,t)=>e===t||typeof e=="object"&&typeof t=="object"&&e&&t&&Dd(e,t);class Xr{constructor(t,n,s,r){this.left=t,this.right=n,this.index=s,this.currentAttributes=r}forward(){switch(this.right===null&&Lt(),this.right.content.constructor){case it:this.right.deleted||xn(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const xo=(e,t,n)=>{for(;t.right!==null&&n>0;){switch(t.right.content.constructor){case it:t.right.deleted||xn(t.currentAttributes,t.right.content);break;default:t.right.deleted||(n<t.right.length&&St(e,N(t.right.id.client,t.right.id.clock+n)),t.index+=t.right.length,n-=t.right.length);break}t.left=t.right,t.right=t.right.right}return t},Os=(e,t,n,s)=>{const r=new Map,i=s?or(t,n):null;if(i){const o=new Xr(i.p.left,i.p,i.index,r);return xo(e,o,n-i.index)}else{const o=new Xr(null,t._start,0,r);return xo(e,o,n)}},aa=(e,t,n,s)=>{for(;n.right!==null&&(n.right.deleted===!0||n.right.content.constructor===it&&Ee(s.get(n.right.content.key),n.right.content.value));)n.right.deleted||s.delete(n.right.content.key),n.forward();const r=e.doc,i=r.clientID;s.forEach((o,c)=>{const l=n.left,d=n.right,a=new X(N(i,et(r.store,i)),l,l&&l.lastId,d,d&&d.id,t,null,new it(c,o));a.integrate(e,0),n.right=a,n.forward()})},xn=(e,t)=>{const{key:n,value:s}=t;s===null?e.delete(n):e.set(n,s)},la=(e,t)=>{for(;e.right!==null;){if(!(e.right.deleted||e.right.content.constructor===it&&Ee(t[e.right.content.key]??null,e.right.content.value)))break;e.forward()}},da=(e,t,n,s)=>{const r=e.doc,i=r.clientID,o=new Map;for(const c in s){const l=s[c],d=n.currentAttributes.get(c)??null;if(!Ee(d,l)){o.set(c,d);const{left:a,right:u}=n;n.right=new X(N(i,et(r.store,i)),a,a&&a.lastId,u,u&&u.id,t,null,new it(c,l)),n.right.integrate(e,0),n.forward()}}return o},Er=(e,t,n,s,r)=>{n.currentAttributes.forEach((f,g)=>{r[g]===void 0&&(r[g]=null)});const i=e.doc,o=i.clientID;la(n,r);const c=da(e,t,n,r),l=s.constructor===String?new Yt(s):s instanceof lt?new Xt(s):new Qe(s);let{left:d,right:a,index:u}=n;t._searchMarker&&ns(t._searchMarker,n.index,l.getLength()),a=new X(N(o,et(i.store,o)),d,d&&d.lastId,a,a&&a.id,t,null,l),a.integrate(e,0),n.right=a,n.index=u,n.forward(),aa(e,t,n,c)},Do=(e,t,n,s,r)=>{const i=e.doc,o=i.clientID;la(n,r);const c=da(e,t,n,r);t:for(;n.right!==null&&(s>0||c.size>0&&(n.right.deleted||n.right.content.constructor===it));){if(!n.right.deleted)switch(n.right.content.constructor){case it:{const{key:l,value:d}=n.right.content,a=r[l];if(a!==void 0){if(Ee(a,d))c.delete(l);else{if(s===0)break t;c.set(l,d)}n.right.delete(e)}else n.currentAttributes.set(l,d);break}default:s<n.right.length&&St(e,N(n.right.id.client,n.right.id.clock+s)),s-=n.right.length;break}n.forward()}if(s>0){let l="";for(;s>0;s--)l+=`
`;n.right=new X(N(o,et(i.store,o)),n.left,n.left&&n.left.lastId,n.right,n.right&&n.right.id,t,null,new Yt(l)),n.right.integrate(e,0),n.forward()}aa(e,t,n,c)},ua=(e,t,n,s,r)=>{let i=t;const o=_t();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===it){const d=i.content;o.set(d.key,d)}i=i.right}let c=0,l=!1;for(;t!==i;){if(n===t&&(l=!0),!t.deleted){const d=t.content;switch(d.constructor){case it:{const{key:a,value:u}=d,f=s.get(a)??null;(o.get(a)!==d||f===u)&&(t.delete(e),c++,!l&&(r.get(a)??null)===u&&f!==u&&(f===null?r.delete(a):r.set(a,f))),!l&&!t.deleted&&xn(r,d);break}}}t=t.right}return c},zu=(e,t)=>{for(;t&&t.right&&(t.right.deleted||!t.right.countable);)t=t.right;const n=new Set;for(;t&&(t.deleted||!t.countable);){if(!t.deleted&&t.content.constructor===it){const s=t.content.key;n.has(s)?t.delete(e):n.add(s)}t=t.left}},Wu=e=>{let t=0;return Y(e.doc,n=>{let s=e._start,r=e._start,i=_t();const o=Hr(i);for(;r;){if(r.deleted===!1)switch(r.content.constructor){case it:xn(o,r.content);break;default:t+=ua(n,s,r,i,o),i=Hr(o),s=r;break}r=r.right}}),t},qu=e=>{const t=new Set,n=e.doc;for(const[s,r]of e.afterState.entries()){const i=e.beforeState.get(s)||0;r!==i&&Gc(e,n.store.clients.get(s),i,r,o=>{!o.deleted&&o.content.constructor===it&&o.constructor!==Ot&&t.add(o.parent)})}Y(n,s=>{kn(e,e.deleteSet,r=>{if(r instanceof Ot||!r.parent._hasFormatting||t.has(r.parent))return;const i=r.parent;r.content.constructor===it?t.add(i):zu(s,r)});for(const r of t)Wu(r)})},Ro=(e,t,n)=>{const s=n,r=Hr(t.currentAttributes),i=t.right;for(;n>0&&t.right!==null;){if(t.right.deleted===!1)switch(t.right.content.constructor){case Xt:case Qe:case Yt:n<t.right.length&&St(e,N(t.right.id.client,t.right.id.clock+n)),n-=t.right.length,t.right.delete(e);break}t.forward()}i&&ua(e,i,t.right,r,t.currentAttributes);const o=(t.left||t.right).parent;return o._searchMarker&&ns(o._searchMarker,t.index,-s+n),t};class ha extends ir{constructor(t,n,s){super(t,n),this.childListChanged=!1,this.keysChanged=new Set,s.forEach(r=>{r===null?this.childListChanged=!0:this.keysChanged.add(r)})}get changes(){if(this._changes===null){const t={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=t}return this._changes}get delta(){if(this._delta===null){const t=this.target.doc,n=[];Y(t,s=>{const r=new Map,i=new Map;let o=this.target._start,c=null;const l={};let d="",a=0,u=0;const f=()=>{if(c!==null){let g=null;switch(c){case"delete":u>0&&(g={delete:u}),u=0;break;case"insert":(typeof d=="object"||d.length>0)&&(g={insert:d},r.size>0&&(g.attributes={},r.forEach((m,v)=>{m!==null&&(g.attributes[v]=m)}))),d="";break;case"retain":a>0&&(g={retain:a},Cd(l)||(g.attributes=Ed({},l))),a=0;break}g&&n.push(g),c=null}};for(;o!==null;){switch(o.content.constructor){case Xt:case Qe:this.adds(o)?this.deletes(o)||(f(),c="insert",d=o.content.getContent()[0],f()):this.deletes(o)?(c!=="delete"&&(f(),c="delete"),u+=1):o.deleted||(c!=="retain"&&(f(),c="retain"),a+=1);break;case Yt:this.adds(o)?this.deletes(o)||(c!=="insert"&&(f(),c="insert"),d+=o.content.str):this.deletes(o)?(c!=="delete"&&(f(),c="delete"),u+=o.length):o.deleted||(c!=="retain"&&(f(),c="retain"),a+=o.length);break;case it:{const{key:g,value:m}=o.content;if(this.adds(o)){if(!this.deletes(o)){const v=r.get(g)??null;Ee(v,m)?m!==null&&o.delete(s):(c==="retain"&&f(),Ee(m,i.get(g)??null)?delete l[g]:l[g]=m)}}else if(this.deletes(o)){i.set(g,m);const v=r.get(g)??null;Ee(v,m)||(c==="retain"&&f(),l[g]=v)}else if(!o.deleted){i.set(g,m);const v=l[g];v!==void 0&&(Ee(v,m)?v!==null&&o.delete(s):(c==="retain"&&f(),m===null?delete l[g]:l[g]=m))}o.deleted||(c==="insert"&&f(),xn(r,o.content));break}}o=o.right}for(f();n.length>0;){const g=n[n.length-1];if(g.retain!==void 0&&g.attributes===void 0)n.pop();else break}}),this._delta=n}return this._delta}}class En extends lt{constructor(t){super(),this._pending=t!==void 0?[()=>this.insert(0,t)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??mt(),this._length}_integrate(t,n){super._integrate(t,n);try{this._pending.forEach(s=>s())}catch(s){console.error(s)}this._pending=null}_copy(){return new En}clone(){const t=new En;return t.applyDelta(this.toDelta()),t}_callObserver(t,n){super._callObserver(t,n);const s=new ha(this,t,n);cr(this,t,s),!t.local&&this._hasFormatting&&(t._needFormattingCleanup=!0)}toString(){this.doc??mt();let t="",n=this._start;for(;n!==null;)!n.deleted&&n.countable&&n.content.constructor===Yt&&(t+=n.content.str),n=n.right;return t}toJSON(){return this.toString()}applyDelta(t,{sanitize:n=!0}={}){this.doc!==null?Y(this.doc,s=>{const r=new Xr(null,this._start,0,new Map);for(let i=0;i<t.length;i++){const o=t[i];if(o.insert!==void 0){const c=!n&&typeof o.insert=="string"&&i===t.length-1&&r.right===null&&o.insert.slice(-1)===`
`?o.insert.slice(0,-1):o.insert;(typeof c!="string"||c.length>0)&&Er(s,this,r,c,o.attributes||{})}else o.retain!==void 0?Do(s,this,r,o.retain,o.attributes||{}):o.delete!==void 0&&Ro(s,r,o.delete)}}):this._pending.push(()=>this.applyDelta(t))}toDelta(t,n,s){this.doc??mt();const r=[],i=new Map,o=this.doc;let c="",l=this._start;function d(){if(c.length>0){const u={};let f=!1;i.forEach((m,v)=>{f=!0,u[v]=m});const g={insert:c};f&&(g.attributes=u),r.push(g),c=""}}const a=()=>{for(;l!==null;){if(ln(l,t)||n!==void 0&&ln(l,n))switch(l.content.constructor){case Yt:{const u=i.get("ychange");t!==void 0&&!ln(l,t)?(u===void 0||u.user!==l.id.client||u.type!=="removed")&&(d(),i.set("ychange",s?s("removed",l.id):{type:"removed"})):n!==void 0&&!ln(l,n)?(u===void 0||u.user!==l.id.client||u.type!=="added")&&(d(),i.set("ychange",s?s("added",l.id):{type:"added"})):u!==void 0&&(d(),i.delete("ychange")),c+=l.content.str;break}case Xt:case Qe:{d();const u={insert:l.content.getContent()[0]};if(i.size>0){const f={};u.attributes=f,i.forEach((g,m)=>{f[m]=g})}r.push(u);break}case it:ln(l,t)&&(d(),xn(i,l.content));break}l=l.right}d()};return t||n?Y(o,u=>{t&&Yr(u,t),n&&Yr(u,n),a()},"cleanup"):a(),r}insert(t,n,s){if(n.length<=0)return;const r=this.doc;r!==null?Y(r,i=>{const o=Os(i,this,t,!s);s||(s={},o.currentAttributes.forEach((c,l)=>{s[l]=c})),Er(i,this,o,n,s)}):this._pending.push(()=>this.insert(t,n,s))}insertEmbed(t,n,s){const r=this.doc;r!==null?Y(r,i=>{const o=Os(i,this,t,!s);Er(i,this,o,n,s||{})}):this._pending.push(()=>this.insertEmbed(t,n,s||{}))}delete(t,n){if(n===0)return;const s=this.doc;s!==null?Y(s,r=>{Ro(r,Os(r,this,t,!0),n)}):this._pending.push(()=>this.delete(t,n))}format(t,n,s){if(n===0)return;const r=this.doc;r!==null?Y(r,i=>{const o=Os(i,this,t,!1);o.right!==null&&Do(i,this,o,n,s)}):this._pending.push(()=>this.format(t,n,s))}removeAttribute(t){this.doc!==null?Y(this.doc,n=>{Gs(n,this,t)}):this._pending.push(()=>this.removeAttribute(t))}setAttribute(t,n){this.doc!==null?Y(this.doc,s=>{Pi(s,this,t,n)}):this._pending.push(()=>this.setAttribute(t,n))}getAttribute(t){return Ui(this,t)}getAttributes(){return oa(this)}_write(t){t.writeTypeRef(fh)}}const Gu=e=>new En;class Ar{constructor(t,n=()=>!0){this._filter=n,this._root=t,this._currentNode=t._start,this._firstCall=!0,t.doc??mt()}[Symbol.iterator](){return this}next(){let t=this._currentNode,n=t&&t.content&&t.content.type;if(t!==null&&(!this._firstCall||t.deleted||!this._filter(n)))do if(n=t.content.type,!t.deleted&&(n.constructor===An||n.constructor===qe)&&n._start!==null)t=n._start;else for(;t!==null;){const s=t.next;if(s!==null){t=s;break}else t.parent===this._root?t=null:t=t.parent._item}while(t!==null&&(t.deleted||!this._filter(t.content.type)));return this._firstCall=!1,t===null?{value:void 0,done:!0}:(this._currentNode=t,{value:t.content.type,done:!1})}}class qe extends lt{constructor(){super(),this._prelimContent=[]}get firstChild(){const t=this._first;return t?t.content.getContent()[0]:null}_integrate(t,n){super._integrate(t,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new qe}clone(){const t=new qe;return t.insert(0,this.toArray().map(n=>n instanceof lt?n.clone():n)),t}get length(){return this.doc??mt(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(t){return new Ar(this,t)}querySelector(t){t=t.toUpperCase();const s=new Ar(this,r=>r.nodeName&&r.nodeName.toUpperCase()===t).next();return s.done?null:s.value}querySelectorAll(t){return t=t.toUpperCase(),de(new Ar(this,n=>n.nodeName&&n.nodeName.toUpperCase()===t))}_callObserver(t,n){cr(this,t,new Xu(this,n,t))}toString(){return ea(this,t=>t.toString()).join("")}toJSON(){return this.toString()}toDOM(t=document,n={},s){const r=t.createDocumentFragment();return s!==void 0&&s._createAssociation(r,this),ss(this,i=>{r.insertBefore(i.toDOM(t,n,s),null)}),r}insert(t,n){this.doc!==null?Y(this.doc,s=>{ra(s,this,t,n)}):this._prelimContent.splice(t,0,...n)}insertAfter(t,n){if(this.doc!==null)Y(this.doc,s=>{const r=t&&t instanceof lt?t._item:t;qs(s,this,r,n)});else{const s=this._prelimContent,r=t===null?0:s.findIndex(i=>i===t)+1;if(r===0&&t!==null)throw ue("Reference item not found");s.splice(r,0,...n)}}delete(t,n=1){this.doc!==null?Y(this.doc,s=>{ia(s,this,t,n)}):this._prelimContent.splice(t,n)}toArray(){return ta(this)}push(t){this.insert(this.length,t)}unshift(t){this.insert(0,t)}get(t){return na(this,t)}slice(t=0,n=this.length){return Qc(this,t,n)}forEach(t){ss(this,t)}_write(t){t.writeTypeRef(gh)}}const Yu=e=>new qe;class An extends qe{constructor(t="UNDEFINED"){super(),this.nodeName=t,this._prelimAttrs=new Map}get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}_integrate(t,n){super._integrate(t,n),this._prelimAttrs.forEach((s,r)=>{this.setAttribute(r,s)}),this._prelimAttrs=null}_copy(){return new An(this.nodeName)}clone(){const t=new An(this.nodeName),n=this.getAttributes();return Td(n,(s,r)=>{typeof s=="string"&&t.setAttribute(r,s)}),t.insert(0,this.toArray().map(s=>s instanceof lt?s.clone():s)),t}toString(){const t=this.getAttributes(),n=[],s=[];for(const c in t)s.push(c);s.sort();const r=s.length;for(let c=0;c<r;c++){const l=s[c];n.push(l+'="'+t[l]+'"')}const i=this.nodeName.toLocaleLowerCase(),o=n.length>0?" "+n.join(" "):"";return`<${i}${o}>${super.toString()}</${i}>`}removeAttribute(t){this.doc!==null?Y(this.doc,n=>{Gs(n,this,t)}):this._prelimAttrs.delete(t)}setAttribute(t,n){this.doc!==null?Y(this.doc,s=>{Pi(s,this,t,n)}):this._prelimAttrs.set(t,n)}getAttribute(t){return Ui(this,t)}hasAttribute(t){return ca(this,t)}getAttributes(t){return t?Bu(this,t):oa(this)}toDOM(t=document,n={},s){const r=t.createElement(this.nodeName),i=this.getAttributes();for(const o in i){const c=i[o];typeof c=="string"&&r.setAttribute(o,c)}return ss(this,o=>{r.appendChild(o.toDOM(t,n,s))}),s!==void 0&&s._createAssociation(r,this),r}_write(t){t.writeTypeRef(ph),t.writeKey(this.nodeName)}}const Ju=e=>new An(e.readKey());class Xu extends ir{constructor(t,n,s){super(t,s),this.childListChanged=!1,this.attributesChanged=new Set,n.forEach(r=>{r===null?this.childListChanged=!0:this.attributesChanged.add(r)})}}class Ys extends We{constructor(t){super(),this.hookName=t}_copy(){return new Ys(this.hookName)}clone(){const t=new Ys(this.hookName);return this.forEach((n,s)=>{t.set(s,n)}),t}toDOM(t=document,n={},s){const r=n[this.hookName];let i;return r!==void 0?i=r.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),s!==void 0&&s._createAssociation(i,this),i}_write(t){t.writeTypeRef(mh),t.writeKey(this.hookName)}}const Zu=e=>new Ys(e.readKey());class yt extends En{get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}_copy(){return new yt}clone(){const t=new yt;return t.applyDelta(this.toDelta()),t}toDOM(t=document,n,s){const r=t.createTextNode(this.toString());return s!==void 0&&s._createAssociation(r,this),r}toString(){return this.toDelta().map(t=>{const n=[];for(const r in t.attributes){const i=[];for(const o in t.attributes[r])i.push({key:o,value:t.attributes[r][o]});i.sort((o,c)=>o.key<c.key?-1:1),n.push({nodeName:r,attrs:i})}n.sort((r,i)=>r.nodeName<i.nodeName?-1:1);let s="";for(let r=0;r<n.length;r++){const i=n[r];s+=`<${i.nodeName}`;for(let o=0;o<i.attrs.length;o++){const c=i.attrs[o];s+=` ${c.key}="${c.value}"`}s+=">"}s+=t.insert;for(let r=n.length-1;r>=0;r--)s+=`</${n[r].nodeName}>`;return s}).join("")}toJSON(){return this.toString()}_write(t){t.writeTypeRef(yh)}}const Qu=e=>new yt;class Ni{constructor(t,n){this.id=t,this.length=n}get deleted(){throw Wt()}mergeWith(t){return!1}write(t,n,s){throw Wt()}integrate(t,n){throw Wt()}}const th=0;class Ot extends Ni{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,n){n>0&&(this.id.clock+=n,this.length-=n),qc(t.doc.store,this)}write(t,n){t.writeInfo(th),t.writeLen(this.length-n)}getMissing(t,n){return null}}class ps{constructor(t){this.content=t}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new ps(this.content)}splice(t){throw Wt()}mergeWith(t){return!1}integrate(t,n){}delete(t){}gc(t){}write(t,n){t.writeBuf(this.content)}getRef(){return 3}}const eh=e=>new ps(e.readBuf());class rs{constructor(t){this.len=t}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new rs(this.len)}splice(t){const n=new rs(this.len-t);return this.len=t,n}mergeWith(t){return this.len+=t.len,!0}integrate(t,n){Qn(t.deleteSet,n.id.client,n.id.clock,this.len),n.markDeleted()}delete(t){}gc(t){}write(t,n){t.writeLen(this.len-n)}getRef(){return 1}}const nh=e=>new rs(e.readLen()),fa=(e,t)=>new Ze({guid:e,...t,shouldLoad:t.shouldLoad||t.autoLoad||!1});class gs{constructor(t){t._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=t;const n={};this.opts=n,t.gc||(n.gc=!1),t.autoLoad&&(n.autoLoad=!0),t.meta!==null&&(n.meta=t.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new gs(fa(this.doc.guid,this.opts))}splice(t){throw Wt()}mergeWith(t){return!1}integrate(t,n){this.doc._item=n,t.subdocsAdded.add(this.doc),this.doc.shouldLoad&&t.subdocsLoaded.add(this.doc)}delete(t){t.subdocsAdded.has(this.doc)?t.subdocsAdded.delete(this.doc):t.subdocsRemoved.add(this.doc)}gc(t){}write(t,n){t.writeString(this.doc.guid),t.writeAny(this.opts)}getRef(){return 9}}const sh=e=>new gs(fa(e.readString(),e.readAny()));class Qe{constructor(t){this.embed=t}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new Qe(this.embed)}splice(t){throw Wt()}mergeWith(t){return!1}integrate(t,n){}delete(t){}gc(t){}write(t,n){t.writeJSON(this.embed)}getRef(){return 5}}const rh=e=>new Qe(e.readJSON());class it{constructor(t,n){this.key=t,this.value=n}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new it(this.key,this.value)}splice(t){throw Wt()}mergeWith(t){return!1}integrate(t,n){const s=n.parent;s._searchMarker=null,s._hasFormatting=!0}delete(t){}gc(t){}write(t,n){t.writeKey(this.key),t.writeJSON(this.value)}getRef(){return 6}}const ih=e=>new it(e.readKey(),e.readJSON());class Js{constructor(t){this.arr=t}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Js(this.arr)}splice(t){const n=new Js(this.arr.slice(t));return this.arr=this.arr.slice(0,t),n}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,n){}delete(t){}gc(t){}write(t,n){const s=this.arr.length;t.writeLen(s-n);for(let r=n;r<s;r++){const i=this.arr[r];t.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}}const oh=e=>{const t=e.readLen(),n=[];for(let s=0;s<t;s++){const r=e.readString();r==="undefined"?n.push(void 0):n.push(JSON.parse(r))}return new Js(n)},ch=Hs("node_env")==="development";class Ge{constructor(t){this.arr=t,ch&&Ic(t)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Ge(this.arr)}splice(t){const n=new Ge(this.arr.slice(t));return this.arr=this.arr.slice(0,t),n}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,n){}delete(t){}gc(t){}write(t,n){const s=this.arr.length;t.writeLen(s-n);for(let r=n;r<s;r++){const i=this.arr[r];t.writeAny(i)}}getRef(){return 8}}const ah=e=>{const t=e.readLen(),n=[];for(let s=0;s<t;s++)n.push(e.readAny());return new Ge(n)};class Yt{constructor(t){this.str=t}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new Yt(this.str)}splice(t){const n=new Yt(this.str.slice(t));this.str=this.str.slice(0,t);const s=this.str.charCodeAt(t-1);return s>=55296&&s<=56319&&(this.str=this.str.slice(0,t-1)+"�",n.str="�"+n.str.slice(1)),n}mergeWith(t){return this.str+=t.str,!0}integrate(t,n){}delete(t){}gc(t){}write(t,n){t.writeString(n===0?this.str:this.str.slice(n))}getRef(){return 4}}const lh=e=>new Yt(e.readString()),dh=[ju,Ku,Gu,Ju,Yu,Zu,Qu],uh=0,hh=1,fh=2,ph=3,gh=4,mh=5,yh=6;class Xt{constructor(t){this.type=t}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new Xt(this.type._copy())}splice(t){throw Wt()}mergeWith(t){return!1}integrate(t,n){this.type._integrate(t.doc,n)}delete(t){let n=this.type._start;for(;n!==null;)n.deleted?n.id.clock<(t.beforeState.get(n.id.client)||0)&&t._mergeStructs.push(n):n.delete(t),n=n.right;this.type._map.forEach(s=>{s.deleted?s.id.clock<(t.beforeState.get(s.id.client)||0)&&t._mergeStructs.push(s):s.delete(t)}),t.changed.delete(this.type)}gc(t){let n=this.type._start;for(;n!==null;)n.gc(t,!0),n=n.right;this.type._start=null,this.type._map.forEach(s=>{for(;s!==null;)s.gc(t,!0),s=s.left}),this.type._map=new Map}write(t,n){this.type._write(t)}getRef(){return 7}}const wh=e=>new Xt(dh[e.readTypeRef()](e)),Zr=(e,t)=>{let n=t,s=0,r;do s>0&&(n=N(n.client,n.clock+s)),r=yn(e,n),s=n.clock-r.id.clock,n=r.redone;while(n!==null&&r instanceof X);return{item:r,diff:s}},Mi=(e,t)=>{for(;e!==null&&e.keep!==t;)e.keep=t,e=e.parent._item},Xs=(e,t,n)=>{const{client:s,clock:r}=t.id,i=new X(N(s,r+n),t,N(s,r+n-1),t.right,t.rightOrigin,t.parent,t.parentSub,t.content.splice(n));return t.deleted&&i.markDeleted(),t.keep&&(i.keep=!0),t.redone!==null&&(i.redone=N(t.redone.client,t.redone.clock+n)),t.right=i,i.right!==null&&(i.right.left=i),e._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),t.length=n,i},Lo=(e,t)=>Hl(e,n=>On(n.deletions,t)),pa=(e,t,n,s,r,i)=>{const o=e.doc,c=o.store,l=o.clientID,d=t.redone;if(d!==null)return St(e,d);let a=t.parent._item,u=null,f;if(a!==null&&a.deleted===!0){if(a.redone===null&&(!n.has(a)||pa(e,a,n,s,r,i)===null))return null;for(;a.redone!==null;)a=St(e,a.redone)}const g=a===null?t.parent:a.content.type;if(t.parentSub===null){for(u=t.left,f=t;u!==null;){let L=u;for(;L!==null&&L.parent._item!==a;)L=L.redone===null?null:St(e,L.redone);if(L!==null&&L.parent._item===a){u=L;break}u=u.left}for(;f!==null;){let L=f;for(;L!==null&&L.parent._item!==a;)L=L.redone===null?null:St(e,L.redone);if(L!==null&&L.parent._item===a){f=L;break}f=f.right}}else if(f=null,t.right&&!r){for(u=t;u!==null&&u.right!==null&&(u.right.redone||On(s,u.right.id)||Lo(i.undoStack,u.right.id)||Lo(i.redoStack,u.right.id));)for(u=u.right;u.redone;)u=St(e,u.redone);if(u&&u.right!==null)return null}else u=g._map.get(t.parentSub)||null;const m=et(c,l),v=N(l,m),P=new X(v,u,u&&u.lastId,f,f&&f.id,g,t.parentSub,t.content.copy());return t.redone=v,Mi(P,!0),P.integrate(e,0),P};class X extends Ni{constructor(t,n,s,r,i,o,c,l){super(t,l.getLength()),this.origin=s,this.left=n,this.right=r,this.rightOrigin=i,this.parent=o,this.parentSub=c,this.redone=null,this.content=l,this.info=this.content.isCountable()?co:0}set marker(t){(this.info&Sr)>0!==t&&(this.info^=Sr)}get marker(){return(this.info&Sr)>0}get keep(){return(this.info&oo)>0}set keep(t){this.keep!==t&&(this.info^=oo)}get countable(){return(this.info&co)>0}get deleted(){return(this.info&vr)>0}set deleted(t){this.deleted!==t&&(this.info^=vr)}markDeleted(){this.info|=vr}getMissing(t,n){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=et(n,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=et(n,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===mn&&this.id.client!==this.parent.client&&this.parent.clock>=et(n,this.parent.client))return this.parent.client;if(this.origin&&(this.left=Io(t,n,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=St(t,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===Ot||this.right&&this.right.constructor===Ot)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===X?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===X&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===mn){const s=yn(n,this.parent);s.constructor===Ot?this.parent=null:this.parent=s.content.type}return null}integrate(t,n){if(n>0&&(this.id.clock+=n,this.left=Io(t,t.doc.store,N(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(n),this.length-=n),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let s=this.left,r;if(s!==null)r=s.right;else if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start;const i=new Set,o=new Set;for(;r!==null&&r!==this.right;){if(o.add(r),i.add(r),hn(this.origin,r.origin)){if(r.id.client<this.id.client)s=r,i.clear();else if(hn(this.rightOrigin,r.rightOrigin))break}else if(r.origin!==null&&o.has(yn(t.doc.store,r.origin)))i.has(yn(t.doc.store,r.origin))||(s=r,i.clear());else break;r=r.right}this.left=s}if(this.left!==null){const s=this.left.right;this.right=s,this.left.right=this}else{let s;if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start,this.parent._start=this;this.right=s}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(t)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),qc(t.doc.store,this),this.content.integrate(t,this),Ao(t,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(t)}else new Ot(this.id,this.length).integrate(t,0)}get next(){let t=this.right;for(;t!==null&&t.deleted;)t=t.right;return t}get prev(){let t=this.left;for(;t!==null&&t.deleted;)t=t.left;return t}get lastId(){return this.length===1?this.id:N(this.id.client,this.id.clock+this.length-1)}mergeWith(t){if(this.constructor===t.constructor&&hn(t.origin,this.lastId)&&this.right===t&&hn(this.rightOrigin,t.rightOrigin)&&this.id.client===t.id.client&&this.id.clock+this.length===t.id.clock&&this.deleted===t.deleted&&this.redone===null&&t.redone===null&&this.content.constructor===t.content.constructor&&this.content.mergeWith(t.content)){const n=this.parent._searchMarker;return n&&n.forEach(s=>{s.p===t&&(s.p=this,!this.deleted&&this.countable&&(s.index-=this.length))}),t.keep&&(this.keep=!0),this.right=t.right,this.right!==null&&(this.right.left=this),this.length+=t.length,!0}return!1}delete(t){if(!this.deleted){const n=this.parent;this.countable&&this.parentSub===null&&(n._length-=this.length),this.markDeleted(),Qn(t.deleteSet,this.id.client,this.id.clock,this.length),Ao(t,n,this.parentSub),this.content.delete(t)}}gc(t,n){if(!this.deleted)throw Lt();this.content.gc(t),n?_u(t,this,new Ot(this.id,this.length)):this.content=new rs(this.length)}write(t,n){const s=n>0?N(this.id.client,this.id.clock+n-1):this.origin,r=this.rightOrigin,i=this.parentSub,o=this.content.getRef()&tr|(s===null?0:Et)|(r===null?0:oe)|(i===null?0:Wn);if(t.writeInfo(o),s!==null&&t.writeLeftID(s),r!==null&&t.writeRightID(r),s===null&&r===null){const c=this.parent;if(c._item!==void 0){const l=c._item;if(l===null){const d=jc(c);t.writeParentInfo(!0),t.writeString(d)}else t.writeParentInfo(!1),t.writeLeftID(l.id)}else c.constructor===String?(t.writeParentInfo(!0),t.writeString(c)):c.constructor===mn?(t.writeParentInfo(!1),t.writeLeftID(c)):Lt();i!==null&&t.writeString(i)}this.content.write(t,n)}}const ga=(e,t)=>bh[t&tr](e),bh=[()=>{Lt()},nh,oh,eh,lh,rh,ih,wh,ah,sh,()=>{Lt()}],vh=10;class xt extends Ni{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,n){Lt()}write(t,n){t.writeInfo(vh),F(t.restEncoder,this.length-n)}getMissing(t,n){return null}}const ma=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:{},ya="__ $YJS$ __";ma[ya]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");ma[ya]=!0;function $i(e,t){for(const n in e){const s=e[n],r=t[n];if(io(s)&&io(r)){if(!$i(s,r))return!1}else if(Array.isArray(s)&&Array.isArray(r)){if(s.length!==r.length)return!1;for(let i=0;i<s.length;i++)if(s[i]!==r[i])return!1}else if(s!==r)return!1}for(const n in t)if(e[n]===void 0&&t[n]!==void 0)return!1;return!0}function Sh(e,...t){return Object.fromEntries(Object.entries(e).filter(([n])=>t.includes(n)))}function _h(e,...t){return Object.fromEntries(Object.entries(e).filter(([n])=>!t.includes(n)))}function kh(e){return Object.fromEntries(Object.entries(e).filter(([,t])=>t!==null))}function Ih(e){const t=[];for(const n of e){if(typeof n.insert=="string"&&n.insert.length===0)continue;const s=t[t.length-1];if(!s||typeof s.insert!="string"||typeof n.insert!="string"){t.push(n);continue}if(s.attributes===n.attributes||!s.attributes==!n.attributes&&$i(s.attributes??{},n.attributes??{})){s.insert+=n.insert;continue}t.push(n)}return t}function ye(e){return Ih(e.toDelta())}function wa({insert:e}){return typeof e=="string"?e.length:1}function ba(e){return e.reduce((t,n)=>t+wa(n),0)}function va(e,t,n){if(n<1)return[];let s=0;const r=[],i=t+n;for(let o=0;o<e.length&&!(s>=i);o++){const c=e[o],l=wa(c);if(s+l<=t){s+=l;continue}if(typeof c.insert!="string"){s+=l,r.push(c);continue}const d=Math.max(0,t-s),a=Math.min(l,l-(s+l-i));r.push({...c,insert:c.insert.slice(d,a)}),s+=l}return r}function ie(e){return _h(e,rt.isText(e)?"text":"children")}function Sa(e){const t=ye(e),n=t.length>0?t.map(Qr):[{text:""}];return{...e.getAttributes(),children:n}}function Qr(e){return typeof e.insert=="string"?{...e.attributes,text:e.insert}:Sa(e.insert)}function Eh(e){return e.map(t=>rt.isText(t)?{insert:t.text,attributes:ie(t)}:{insert:_a(t)})}function _a({children:e,...t}){const n=new yt;return Object.entries(t).forEach(([s,r])=>{n.setAttribute(s,r)}),n.applyDelta(Eh(e),{sanitize:!1}),n}function is(e){return e?rt.isText(e)?e.text.length:1:0}function Ah(e,t){return e.children.slice(0,t).reduce((n,s)=>n+is(s),0)}function At(e,t,n){if(n.length===0)throw new Error("Path has to a have a length >= 1");if(rt.isText(t))throw new Error("Cannot descent into slate text");const[s,...r]=n,i=Ah(t,s),o=t.children[s],c=ye(e),l=is(o),d=va(c,i,l);if(d.length>1)throw new Error("Path doesn't match yText, yTarget spans multiple nodes");const a=d[0]?.insert;if(r.length>0){if(!(a instanceof yt))throw new Error("Path doesn't match yText, cannot descent into non-yText");return At(a,o,r)}return{yParent:e,textRange:{start:i,end:i+l},yTarget:a instanceof yt?a:void 0,slateParent:t,slateTarget:o,targetDelta:d}}function Ve(e,t,n={}){const{assoc:s=0,insert:r=!1}=n;let i=0,o=0;for(let d=0;d<e.children.length;d++){const a=e.children[d],u=rt.isText(a)?a.text.length:1;u>0&&(o=d);const f=i+u;if(u>0&&(s>=0?f>t:f>=t))return[d,t-i];i+=u}if(t>i+(r?1:0))throw new Error("yOffset out of bounds");if(r)return[e.children.length,0];const c=e.children[o],l=rt.isText(c)?c.text.length:1;return[o,l]}function ka(e,t,n){const s=[n];for(;s[0]!==e;){const{parent:i}=s[0];if(!i)throw new Error("yText isn't a descendant of root element");if(!(i instanceof yt))throw new Error("Unexpected y parent type");s.unshift(i)}if(s.length<2)return[];let r=t;return s.reduce((i,o,c)=>{const l=s[c+1];if(!l)return i;let d=0;const a=ye(o);for(const f of a){if(f.insert===l)break;d+=typeof f.insert=="string"?f.insert.length:1}if(rt.isText(r))throw new Error("Cannot descent into slate text");const[u]=Ve(r,d);return r=r.children[u],i.concat(u)},[])}function Th(e,t,n){const s=[];let r=n.reduce((i,o)=>"retain"in o?i+o.retain:"delete"in o?i+o.delete:i,0);return n.reverse().forEach(i=>{if("attributes"in i&&"retain"in i){const[o,c]=Ve(e,r-i.retain),[l,d]=Ve(e,r,{assoc:-1});for(let a=l;a>=o;a--){const u=e.children[a],f=[...t,a];if(!rt.isText(u))continue;const g=i.attributes,m=Sh(e,...Object.keys(i.attributes));if(a===o||a===l){const v=a===o?c:0,P=a===l?d:u.text.length;if(P!==u.text.length&&s.push({type:"split_node",path:f,position:P,properties:ie(u)}),v!==0){s.push({type:"split_node",path:f,position:v,properties:kh({...ie(u),...g})});continue}}s.push({type:"set_node",newProperties:g,path:f,properties:m})}}if("retain"in i&&(r-=i.retain),"delete"in i){const[o,c]=Ve(e,r-i.delete),[l,d]=Ve(e,r,{assoc:-1});for(let a=d===0?l-1:l;a>=o;a--){const u=e.children[a],f=[...t,a];if(rt.isText(u)&&(a===o||a===l)){const g=a===o?c:0,m=a===l?d:u.text.length;s.push({type:"remove_text",offset:g,text:u.text.slice(g,m),path:f}),r-=m-g;continue}s.push({type:"remove_node",node:u,path:f}),r-=is(u)}return}if("insert"in i){const[o,c]=Ve(e,r,{insert:!0}),l=e.children[o],d=[...t,o];if(rt.isText(l)){const a=s[s.length-1],u=a!=null&&a.type==="insert_node"?a.node:ie(l);let f=[];if(a!=null&&(a.type==="insert_node"||a.type==="insert_text"||a.type==="split_node"||a.type==="set_node")&&(f=a.path),typeof i.insert=="string"&&$i(i.attributes??{},u)&&zn.equals(d,f))return s.push({type:"insert_text",offset:c,text:i.insert,path:d});const g=Qr(i);return c===0?s.push({type:"insert_node",path:d,node:g}):(c<l.text.length&&s.push({type:"split_node",path:d,position:c,properties:ie(l)}),s.push({type:"insert_node",path:zn.next(d),node:g}))}return s.push({type:"insert_node",path:d,node:Qr(i)})}}),s}function Ch(e,t,n){const{target:s,changes:r}=n,i=n.delta;if(!(s instanceof yt))throw new Error("Unexpected target node type");const o=[],c=ka(e,t,s),l=ls.get(t,c);if(rt.isText(l))throw new Error("Cannot apply yTextEvent to text node");const d=Array.from(r.keys.entries());if(c.length>0&&d.length>0){const a=Object.fromEntries(d.map(([f,g])=>[f,g.action==="delete"?null:s.getAttribute(f)])),u=Object.fromEntries(d.map(([f])=>[f,l[f]]));o.push({type:"set_node",newProperties:a,properties:u,path:c})}return i.length>0&&o.push(...Th(l,c,i)),o}function Oh(e,t,n){if(n instanceof ha)return Ch(e,t,n);throw new Error("Unexpected Y event type")}function xh(e,t,n){js.withoutNormalizing(t,()=>{n.forEach(s=>{Oh(e,t,s).forEach(r=>{t.apply(r)})})})}function Dh(e,t,n){const{yParent:s,textRange:r}=At(e,t,n.path);if(rt.isText(n.node))return s.insert(r.start,n.node.text,ie(n.node));s.insertEmbed(r.start,_a(n.node))}function ar(e){return e.map(t=>typeof t.insert=="string"?t:{...t,insert:Rh(t.insert)})}function Rh(e){const t=new yt,n=e.getAttributes();return Object.entries(n).forEach(([s,r])=>{t.setAttribute(s,r)}),t.applyDelta(ar(ye(e)),{sanitize:!1}),t}function os(e){if(!e.doc)throw new Error("shared type isn't attached to a document")}const Ye="__slateYjsStoredPosition_";function ti(e,t,n){const{yTarget:s,yParent:r,textRange:i}=At(e,t,n.path);if(s)throw new Error("Slate point points to a non-text element inside sharedRoot");const o=i.start+n.offset;return Hc(r,o,o===i.end?-1:0)}function Lh(e,t,{type:n,index:s,assoc:r}){if(!(n instanceof yt))throw new Error("Absolute position points to a non-XMLText");const i=ka(e,t,n),o=ls.get(t,i);if(rt.isText(o))throw new Error("Absolute position doesn't match slateRoot, cannot descent into text");const[c,l]=Ve(o,s,{assoc:r}),d=o.children[c];return rt.isText(d)?{path:[...i,c],offset:l}:null}function ei(e,t,n){if(!e.doc)throw new Error("sharedRoot isn't attach to a yDoc");const s=zc(n,e.doc);return s&&Lh(e,t,s)}function Ph(e,t){const n=e.getAttribute(Ye+t);return n?Kc(n):null}function Uh(e){return Object.fromEntries(Object.entries(e.getAttributes()).filter(([t])=>t.startsWith(Ye)).map(([t,n])=>[t.slice(Ye.length),hu(n)]))}function Nh(e){return os(e),Object.fromEntries(Object.entries(e.getAttributes()).filter(([t])=>t.startsWith(Ye)).map(([t,n])=>[t.slice(Ye.length),zc(Kc(n),e.doc)]).filter(([,t])=>t))}function Mh(e,t){e.removeAttribute(Ye+t)}function Ia(e,t,n){e.setAttribute(Ye+t,mu(n))}function Ea(e,t,n){return Object.fromEntries(Object.entries(e).filter(([,s])=>s.type!==t?!1:n?s.assoc>=0?s.index>=n.start&&s.index<n.end:s.index>n.start&&s.index>=n.end:!0))}function Aa(e,t,n=""){const s={[n]:Ea(e,t)};return ye(t).forEach(({insert:i},o)=>{i instanceof yt&&Object.assign(s,Aa(e,i,n?`${n}.${o}`:o.toString()))}),s}function Vi(e,t,n,s=0){const r=Nh(e),i={"":Ea(r,t,{start:s,end:s+ba(n)})};return n.forEach(({insert:o},c)=>{o instanceof yt&&Object.assign(i,Aa(r,o,c.toString()))}),i}function lr(e,t,n,s,r=0,i=0,o=""){const c=n[o];c&&Object.entries(c).forEach(([l,d])=>{Ia(e,l,Hc(t,d.index-i+r,d.assoc))}),s.forEach(({insert:l},d)=>{l instanceof yt&&lr(e,l,n,ye(l),0,0,o?`${o}.${d}`:d.toString())})}function Tr(e,t,n){return{anchor:ti(e,t,n.anchor),focus:ti(e,t,n.focus)}}function $h(e,t,n){const s=ei(e,t,n.anchor);if(!s)return null;const r=ei(e,t,n.focus);return r?{anchor:s,focus:r}:null}function Vh(e,t,n){const s=At(e,t,n.path),r=At(s.yParent,s.slateParent,zn.previous(n.path.slice(-1)));if(!s.yTarget!=!r.yTarget)throw new Error("Cannot merge y text with y element");if(!r.yTarget||!s.yTarget){const{yParent:a,textRange:u,slateTarget:f}=s;if(!f)throw new Error("Expected Slate target node for merge op.");const g=ls.get(t,zn.previous(n.path));if(!rt.isText(g))throw new Error("Path points to Y.Text but not a Slate text node.");const m=ie(f),v=ie(g),P=Object.keys(m).reduce((L,I)=>I in v?L:{...L,[I]:null},{});return a.format(u.start,u.end-u.start,{...P,...v})}const i=r.yTarget.length,o=ye(s.yTarget),c=ar(o),l=Vi(e,s.yTarget,o,i),d=[{retain:i},...c];r.yTarget.applyDelta(d,{sanitize:!1}),s.yParent.delete(s.textRange.start,s.textRange.end-s.textRange.start),lr(e,r.yTarget,l,c,i)}function Bh(e,t,n){const s=zn.parent(n.newPath),r=n.newPath[n.newPath.length-1],i=ls.get(t,s);if(rt.isText(i))throw new Error("Cannot move slate node into text element");const o=[...s,Math.min(r,i.children.length)],c=At(e,t,n.path),l=At(e,t,o),d=ar(c.targetDelta),a=Vi(e,c.yParent,c.targetDelta);c.yParent.delete(c.textRange.start,c.textRange.end-c.textRange.start);const u=ba(ye(l.yParent)),f=Math.min(l.textRange.start,u),g=[{retain:f},...d];l.yParent.applyDelta(g,{sanitize:!1}),lr(e,l.yParent,a,d,f,c.textRange.start)}function Fh(e,t,n){const{yParent:s,textRange:r}=At(e,t,n.path);s.delete(r.start,r.end-r.start)}function jh(e,t,n){const{yTarget:s,textRange:r,yParent:i}=At(e,t,n.path);if(s)return Object.entries(n.newProperties).forEach(([l,d])=>{if(d===null)return s.removeAttribute(l);s.setAttribute(l,d)}),Object.entries(n.properties).forEach(([l])=>{Object.prototype.hasOwnProperty.call(n.newProperties,l)||s.removeAttribute(l)});const c={...Object.fromEntries(Object.keys(n.properties).map(l=>[l,null])),...n.newProperties};i.format(r.start,r.end-r.start,c)}function Hh(e,t,n){const s=At(e,t,n.path);if(!s.slateTarget)throw new Error("Y target without corresponding slate node");if(!s.yTarget){if(!rt.isText(s.slateTarget))throw new Error("Mismatch node type between y target and slate node");const u={};return s.targetDelta.forEach(f=>{f.attributes&&Object.keys(f.attributes).forEach(g=>{u[g]=null})}),s.yParent.format(s.textRange.start,s.textRange.end-s.textRange.start,{...u,...n.properties})}if(rt.isText(s.slateTarget))throw new Error("Mismatch node type between y target and slate node");const r=At(s.yTarget,s.slateTarget,[n.position]),i=s.slateTarget.children.slice(0,n.position).reduce((u,f)=>u+is(f),0),o=s.slateTarget.children.reduce((u,f)=>u+is(f),0),c=va(ye(s.yTarget),i,o-i),l=ar(c),d=Vi(e,s.yTarget,c,i),a=new yt;a.applyDelta(l,{sanitize:!1}),Object.entries(n.properties).forEach(([u,f])=>{a.setAttribute(u,f)}),s.yTarget.delete(r.textRange.start,s.yTarget.length-r.textRange.start),s.yParent.insertEmbed(s.textRange.end,a),lr(e,a,d,l,0,i)}const Kh={insert_node:Dh,remove_node:Fh,set_node:jh,merge_node:Vh,move_node:Bh,split_node:Hh};function zh(e,t,n){const{yParent:s,textRange:r}=At(e,t,n.path),i=ls.get(t,n.path);if(!rt.isText(i))throw new Error("Cannot insert text into non-text node");s.insert(r.start+n.offset,n.text,ie(i))}function Wh(e,t,n){const{yParent:s,textRange:r}=At(e,t,n.path);s.delete(r.start+n.offset,n.text.length)}const qh={insert_text:zh,remove_text:Wh},Gh=()=>{},Yh={...qh,...Kh,set_selection:Gh};function Jh(e,t,n){const s=Yh[n.type];if(!s)throw new Error(`Unknown operation: ${n.type}`);s(e,t,n)}const Xh=Symbol("slate-yjs-operation"),Zh=Symbol("slate-yjs-position-storage"),Cr=new WeakMap,ni=new WeakSet,Mt={isYjsEditor(e){return js.isEditor(e)&&e.sharedRoot instanceof yt&&"localOrigin"in e&&"positionStorageOrigin"in e&&typeof e.applyRemoteEvents=="function"&&typeof e.isLocalOrigin=="function"&&typeof e.connect=="function"&&typeof e.disconnect=="function"},applyRemoteEvents(e,t,n){e.applyRemoteEvents(t,n)},connected(e){return ni.has(e)},connect(e){e.connect()},disconnect(e){e.disconnect()},isLocal(e){return e.isLocalOrigin(Mt.origin(e))},origin(e){const t=Cr.get(e);return t!==void 0?t:e.localOrigin},withOrigin(e,t,n){const s=Mt.origin(e);Cr.set(e,t),n(),Cr.set(e,s)},storePosition(e,t,n){const{sharedRoot:s,positionStorageOrigin:r}=e;os(s);const i=ti(s,e,n);s.doc.transact(()=>{Ia(s,t,i)},r)},removeStoredPosition(e,t){const{sharedRoot:n,positionStorageOrigin:s}=e;os(n),n.doc.transact(()=>{Mh(n,t)},s)},position(e,t){const n=Ph(e.sharedRoot,t);if(n)return ei(e.sharedRoot,e,n)},storedPositionsRelative(e){return Uh(e.sharedRoot)}};function Sm(e,t,{localOrigin:n,positionStorageOrigin:s,autoConnect:r=!1}={}){const i=e;i.sharedRoot=t,i.localOrigin=n??Xh,i.positionStorageOrigin=s??Zh,i.applyRemoteEvents=(d,a)=>{js.withoutNormalizing(i,()=>{Mt.withOrigin(i,a,()=>{xh(i.sharedRoot,i,d)})})},i.isLocalOrigin=d=>d===i.localOrigin;const o=(d,a)=>{i.isLocalOrigin(a.origin)||Mt.applyRemoteEvents(i,d,a.origin)};let c=null;r&&(c=setTimeout(()=>{c=null,Mt.connect(i)})),i.connect=()=>{if(Mt.connected(i))throw new Error("already connected");i.sharedRoot.observeDeep(o);const d=Sa(i.sharedRoot);i.children=d.children,ni.add(i),js.normalize(e,{force:!0}),e.operations.length||e.onChange()},i.disconnect=()=>{c&&clearTimeout(c),i.sharedRoot.unobserveDeep(o),ni.delete(i)};const{apply:l}=i;return i.apply=d=>{Mt.connected(i)&&Mt.isLocal(i)&&(os(i.sharedRoot),i.sharedRoot.doc.transact(()=>{os(i.sharedRoot),Jh(i.sharedRoot,e,d)},Mt.origin(i))),l(d)},i}const Po=new WeakMap,Qh=Symbol("slate-yjs-history-without-saving");function _m(e,{withoutSavingOrigin:t=Qh,trackedOrigins:n=new Set([e.localOrigin]),...s}={}){const r=e,i=new Tu(r.sharedRoot,{trackedOrigins:n,...s});r.undoManager=i,r.withoutSavingOrigin=t;const{onChange:o,isLocalOrigin:c}=r;r.onChange=()=>{o(),Po.set(r,r.selection&&Tr(r.sharedRoot,r,r.selection))},r.isLocalOrigin=g=>g===r.withoutSavingOrigin||c(g);const l=({stackItem:g})=>{setTimeout(()=>{g.meta.set("selection",r.selection&&Tr(r.sharedRoot,r,r.selection)),g.meta.set("selectionBefore",Po.get(r))})},d=({stackItem:g})=>{setTimeout(()=>{g.meta.set("selection",r.selection&&Tr(r.sharedRoot,r,r.selection))})},a=({stackItem:g,type:m})=>{const v=m==="undo"?r.undoManager.redoStack:r.undoManager.undoStack,P=v[v.length-1];P&&(P.meta.set("selection",g.meta.get("selectionBefore")),P.meta.set("selectionBefore",g.meta.get("selection")));const L=g.meta.get("selectionBefore");if(!L)return;const I=$h(r.sharedRoot,r,L);I&&$l.isLocation(I)&&Vl.select(r,I)},{connect:u,disconnect:f}=r;return r.connect=()=>{u(),r.undoManager.on("stack-item-added",l),r.undoManager.on("stack-item-popped",a),r.undoManager.on("stack-item-updated",d)},r.disconnect=()=>{r.undoManager.off("stack-item-added",l),r.undoManager.off("stack-item-popped",a),r.undoManager.off("stack-item-updated",d),f()},r.undo=()=>{Mt.connected(r)&&r.undoManager.undo()},r.redo=()=>{Mt.connected(r)&&r.undoManager.redo()},r}var tf=Object.defineProperty,ef=(e,t)=>{for(var n in t)tf(e,n,{get:t[n],enumerable:!0})},nf="@liveblocks/core",dr="3.9.2",sf="esm",xs=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:{},rf="https://liveblocks.io/docs/errors/dupes",of=" ";function cf(e){console.error(e)}function Bi(e,t,n){const s=Symbol.for(e),r=`${t} (${n})`;if(!xs[s])xs[s]=r;else if(xs[s]!==r){const i=[`Multiple copies of Liveblocks are being loaded in your project. This will cause issues! See ${rf+of}`,"","Conflicts:",`- ${e} ${xs[s]} (already loaded)`,`- ${e} ${r} (trying to load this now)`].join(`
`);cf(i)}}function J(){const e=new Set;function t(o){return e.add(o),()=>e.delete(o)}function n(o){const c=t(l=>(c(),o(l)));return c}async function s(o){let c;return new Promise(l=>{c=t(d=>{(o===void 0||o(d))&&l(d)})}).finally(()=>c?.())}function r(o){let c=!1;for(const l of e)l(o),c=!0;return c}function i(){return e.size}return{notify:r,subscribe:t,subscribeOnce:n,count:i,waitUntil:s,dispose(){e.clear()},observable:{subscribe:t,subscribeOnce:n,waitUntil:s}}}function af(){const e=J();let t=null;function n(){t=[]}function s(){if(t!==null){for(const i of t)e.notify(i);t=null}}function r(i){return t!==null?(t.push(i),!1):e.notify(i)}return{...e,notify:r,pause:n,unpause:s,dispose(){e.dispose(),t!==null&&(t.length=0)}}}var Te=(e=>e);function Bt(e){throw new Error(e)}function Ta(e){return Object.entries(e)}function lf(e,t){return typeof t<"u"?Object.create(e,t):Object.create(e)}function ce(e){try{return JSON.parse(e)}catch{return}}function cs(e){return JSON.parse(JSON.stringify(e))}function df(e){try{const t=e.replace(/-/g,"+").replace(/_/g,"/");return decodeURIComponent(atob(t).split("").map(function(s){return"%"+("00"+s.charCodeAt(0).toString(16)).slice(-2)}).join(""))}catch{return atob(e)}}function si(e){return e.filter(t=>t!=null)}function ur(e){const t={...e};return Object.keys(e).forEach(n=>{const s=n;t[s]===void 0&&delete t[s]}),t}function uf(e){return new Promise(t=>setTimeout(t,e))}async function Uo(e,t,n){let s;const r=new Promise((i,o)=>{s=setTimeout(()=>{o(new Error(n))},t)});return Promise.race([e,r]).finally(()=>clearTimeout(s))}function No(e){let t=null;return()=>(t===null&&(t=e().catch(n=>{throw setTimeout(()=>{t=null},5e3),n})),t)}function hf(e,t){for(let n=e.length-1;n>=0;n--)if(t(e[n],n,e))return n;return-1}var Ne=Symbol("kSinks"),Zs=Symbol("kTrigger"),fn=null,Be=null;function Ce(e){if(fn!==null){e();return}fn=new Set;try{e()}finally{for(const t of fn)t[Zs]();fn=null}}function Fi(e){fn||Bt("Expected to be in an active batch"),fn.add(e)}function Ca(e,t){let n=!1;const s={...e};return Object.keys(t).forEach(r=>{const i=r,o=t[i];s[i]!==o&&(o===void 0?delete s[i]:s[i]=o,n=!0)}),n?s:e}var ji=class{equals;#t;[Ne];constructor(e){this.equals=e??Object.is,this.#t=J(),this[Ne]=new Set,this.get=this.get.bind(this),this.subscribe=this.subscribe.bind(this),this.subscribeOnce=this.subscribeOnce.bind(this)}dispose(){this.#t.dispose(),this.#t="(disposed)",this.equals="(disposed)"}get hasWatchers(){if(this.#t.count()>0)return!0;for(const e of this[Ne])if(e.hasWatchers)return!0;return!1}[Zs](){this.#t.notify();for(const e of this[Ne])Fi(e)}subscribe(e){return this.#t.count()===0&&this.get(),this.#t.subscribe(e)}subscribeOnce(e){const t=this.subscribe(()=>(t(),e()));return t}waitUntil(){throw new Error("waitUntil not supported on Signals")}markSinksDirty(){for(const e of this[Ne])e.markDirty()}addSink(e){this[Ne].add(e)}removeSink(e){this[Ne].delete(e)}asReadonly(){return this}},Dt=class extends ji{#t;constructor(e,t){super(t),this.#t=Te(e)}dispose(){super.dispose(),this.#t="(disposed)"}get(){return Be?.add(this),this.#t}set(e){Ce(()=>{typeof e=="function"&&(e=e(this.#t)),this.equals(this.#t,e)||(this.#t=Te(e),this.markSinksDirty(),Fi(this))})}},ff=class extends Dt{constructor(e){super(Te(ur(e)))}set(){throw new Error("Don't call .set() directly, use .patch()")}patch(e){super.set(t=>Ca(t,e))}},pf=Symbol(),ae=class ri extends ji{#t;#e;#n;#s;#i;static from(...t){const n=t.pop();if(typeof n!="function"&&Bt("Invalid .from() call, last argument expected to be a function"),typeof t[t.length-1]=="function"){const s=n,r=t.pop();return new ri(t,r,s)}else{const s=n;return new ri(t,s)}}constructor(t,n,s){super(s),this.#e=!0,this.#t=pf,this.#s=t,this.#n=new Set,this.#i=n}dispose(){for(const t of this.#n)t.removeSink(this);this.#t="(disposed)",this.#n="(disposed)",this.#s="(disposed)",this.#i="(disposed)"}get isDirty(){return this.#e}#r(){const t=Be;let n;Be=new Set;try{n=this.#i(...this.#s.map(s=>s.get()))}finally{const s=this.#n;this.#n=new Set;for(const r of Be)this.#n.add(r),s.delete(r);for(const r of s)r.removeSink(this);for(const r of this.#n)r.addSink(this);Be=t}return this.#e=!1,this.equals(this.#t,n)?!1:(this.#t=n,!0)}markDirty(){this.#e||(this.#e=!0,this.markSinksDirty())}get(){return this.#e&&this.#r(),Be?.add(this),this.#t}[Zs](){if(!this.hasWatchers)return;this.#r()&&super[Zs]()}},Tn=class extends ji{#t;constructor(e){super(),this.#t=e}dispose(){super.dispose(),this.#t="(disposed)"}get(){return Be?.add(this),this.#t}mutate(e){Ce(()=>{const t=e?e(this.#t):!0;t!==null&&typeof t=="object"&&"then"in t&&Bt("MutableSignal.mutate() does not support async callbacks"),t!==!1&&(this.markSinksDirty(),Fi(this))})}};function gf(e,t,n){let s=0,r=e.length;for(;s<r;){const i=s+(r-s>>1);n(t,e[i])?r=i:s=i+1}return s}var $n=class Vn{#t;#e;constructor(t,n){this.#e=n,this.#t=t}static with(t){return Vn.fromAlreadySorted([],t)}static from(t,n){const s=new Vn([],n);for(const r of t)s.add(r);return s}static fromAlreadySorted(t,n){return new Vn(t,n)}clone(){return new Vn(this.#t.slice(),this.#e)}add(t){const n=gf(this.#t,t,this.#e);this.#t.splice(n,0,t)}clear(){const t=this.#t.length>0;return this.#t.length=0,t}removeBy(t,n=Number.POSITIVE_INFINITY){let s=0;for(let r=0;r<this.#t.length;r++)if(t(this.#t[r])){if(this.#t.splice(r,1),s++,s>=n)break;r--}return s>0}remove(t){const n=this.#t.indexOf(t);return n>=0?(this.#t.splice(n,1),!0):!1}at(t){return this.#t[t]}get length(){return this.#t.length}*filter(t){for(const n of this.#t)t(n)&&(yield n)}*findAllRight(t){for(let n=this.#t.length-1;n>=0;n--){const s=this.#t[n];t(s,n)&&(yield s)}}[Symbol.iterator](){return this.#t[Symbol.iterator]()}*iterReversed(){for(let t=this.#t.length-1;t>=0;t--)yield this.#t[t]}find(t,n){const s=this.findIndex(t,n);return s>-1?this.#t.at(s):void 0}findIndex(t,n=0){for(let s=Math.max(0,n);s<this.#t.length;s++)if(t(this.#t[s],s))return s;return-1}findRight(t,n){const s=this.findIndexRight(t,n);return s>-1?this.#t.at(s):void 0}findIndexRight(t,n=this.#t.length-1){for(let s=Math.min(n,this.#t.length-1);s>=0;s--)if(t(this.#t[s],s))return s;return-1}get rawArray(){return this.#t}},mf=class{#t;#e;signal;constructor(){this.#t=new Map,this.#e=$n.from([],(e,t)=>{const n=t.lastMessageAt??t.createdAt,s=e.lastMessageAt??e.createdAt;return n<s?!0:n===s?t.id<e.id:!1}),this.signal=new Tn(this)}getEvenIfDeleted(e){return this.signal.get(),this.#t.get(e)}markDeleted(e){const t=this.#t.get(e);t===void 0||t.deletedAt!==void 0||this.upsert({...t,deletedAt:new Date().toISOString()})}upsert(e){this.signal.mutate(()=>{const t=this.#t.get(e.id);if(t!==void 0){if(t.deletedAt!==void 0)return!1;this.#e.remove(t),this.#t.delete(t.id)}return e.deletedAt===void 0&&this.#e.add(e),this.#t.set(e.id,e),!0})}findMany(e){return Array.from(this.#e.filter(t=>{if(e.metadata===void 0)return!0;for(const[n,s]of Object.entries(e.metadata))if(s===null){if(n in t.metadata)return!1}else if(typeof s=="string"){if(t.metadata[n]!==s)return!1}else{const r=t.metadata[n];if(!Array.isArray(r)||!s.every(i=>r.includes(i)))return!1}return!0}))}};function ii(e){const t=e.editedAt?new Date(e.editedAt):void 0,n=new Date(e.createdAt),s=e.reactions.map(r=>({...r,createdAt:new Date(r.createdAt)}));if(e.body)return{...e,reactions:s,createdAt:n,editedAt:t};{const r=new Date(e.deletedAt);return{...e,reactions:s,createdAt:n,editedAt:t,deletedAt:r}}}function be(e){const t=new Date(e.createdAt),n=new Date(e.updatedAt),s=e.comments.map(r=>ii(r));return{...e,createdAt:t,updatedAt:n,comments:s}}function yf(e){return{...e,createdAt:new Date(e.createdAt)}}function Me(e){const t=new Date(e.notifiedAt),n=e.readAt?new Date(e.readAt):null;if("activities"in e){const s=e.activities.map(r=>({...r,createdAt:new Date(r.createdAt)}));return{...e,notifiedAt:t,readAt:n,activities:s}}return{...e,notifiedAt:t,readAt:n}}function ve(e){const t=new Date(e.createdAt);return{...e,createdAt:t}}function Or(e){const t=new Date(e.deletedAt);return{...e,deletedAt:t}}function xr(e){const t=new Date(e.deletedAt);return{...e,deletedAt:t}}function Dr(e){const t=new Date(e.deletedAt);return{...e,deletedAt:t}}function Mo(e){const t=new Date(e.createdAt),n=new Date(e.updatedAt),s=e.members.map(r=>({...r,addedAt:new Date(r.addedAt)}));return{...e,createdAt:t,updatedAt:n,members:s}}function gt(e,t){throw new Error(t)}function M(e,t="Expected value to be non-nullable"){return e}var wf={};ef(wf,{error:()=>pe,errorWithTitle:()=>Sf,warn:()=>bt,warnWithTitle:()=>vf});var Oa="background:#0e0d12;border-radius:9999px;color:#fff;padding:3px 7px;font-family:sans-serif;font-weight:600;",bf="font-weight:600";function xa(e){return typeof window>"u"?console[e]:((t,...n)=>console[e]("%cLiveblocks",Oa,t,...n))}var bt=xa("warn"),pe=xa("error");function Da(e){return typeof window>"u"?console[e]:((t,n,...s)=>console[e](`%cLiveblocks%c ${t}`,Oa,bf,n,...s))}var vf=Da("warn"),Sf=Da("error");function _f(e){return e!=null}function Jt(e){return e!==null&&typeof e=="object"&&Object.prototype.toString.call(e)==="[object Object]"}function $o(e){return Jt(e)&&typeof e.startsWith=="string"}function Vo(e){return Jt(e)&&(typeof e.lt=="number"||typeof e.gt=="number"||typeof e.lte=="number"||typeof e.gte=="number")}var Qs=class Ra extends Error{response;details;constructor(t,n,s){super(t),this.name="HttpError",this.response=n,this.details=s}static async fromResponse(t){let n;try{n=await t.text()}catch{}const s=n?ce(n):void 0;let r;Jt(s)&&(r=s);let i="";i||=typeof r?.message=="string"?r.message:"",i||=typeof r?.error=="string"?r.error:"",s===void 0&&(i||=n||""),i||=t.statusText;let o;try{o=new URL(t.url).pathname}catch{}i+=o!==void 0?` (got status ${t.status} from ${o})`:` (got status ${t.status})`;const c=r;return new Ra(i,t,c)}get status(){return this.response.status}},kf=e=>e instanceof Qs&&e.status>=400&&e.status<500;async function Rr(e,t,n,s=kf){const r=n.length>0?n[n.length-1]:0;let i=0;for(;;){i++;try{return await e()}catch(c){if(s(c))throw c;if(i>=t)throw new Error(`Failed after ${t} attempts: ${String(c)}`)}const o=n[i-1]??r;bt(`Attempt ${i} was unsuccessful. Retrying in ${o} milliseconds.`),await uf(o)}}function La(){let e,t;return[new Promise((s,r)=>{e=s,t=r}),e,t]}function Hi(){const[e,t,n]=La();return{promise:e,resolve:t,reject:n}}function If(e,t){return t!==null&&typeof t=="object"&&!Array.isArray(t)?Object.keys(t).sort().reduce((n,s)=>(n[s]=t[s],n),{}):t}function oi(e){return JSON.stringify(e,If)}function le(e){try{return JSON.stringify(e)}catch(t){throw console.error(`Could not stringify: ${t.message}`),console.error(e),t}}var Ef=50,Af=class{input;resolve;reject;promise;constructor(e){this.input=e;const{promise:t,resolve:n,reject:s}=Hi();this.promise=t,this.resolve=n,this.reject=s}},Ie=class{#t=[];#e;#n;#s;#i;error=!1;constructor(e,t){this.#e=e,this.#n=t.size??Ef,this.#s=t.delay}#r(){this.#i!==void 0&&(clearTimeout(this.#i),this.#i=void 0)}#o(){this.#t.length===this.#n?this.#c():this.#t.length===1&&(this.#r(),this.#i=setTimeout(()=>void this.#c(),this.#s))}async#c(){if(this.#t.length===0)return;const e=this.#t.splice(0),t=e.map(n=>n.input);try{const n=await this.#e(t);this.error=!1,e.forEach((s,r)=>{const i=n?.[r];Array.isArray(n)?e.length!==n.length?s.reject(new Error(`Callback must return an array of the same length as the number of provided items. Expected ${e.length}, but got ${n.length}.`)):i instanceof Error?s.reject(i):s.resolve(i):s.reject(new Error("Callback must return an array."))})}catch(n){this.error=!0,e.forEach(s=>{s.reject(n)})}}get(e){const t=this.#t.find(s=>oi(s.input)===oi(e));if(t)return t.promise;const n=new Af(e);return this.#t.push(n),this.#o(),n.promise}clear(){this.#t=[],this.error=!1,this.#r()}};function wn(e){const t=new Tn(new Map);function n(a){return oi(a)}function s(a){t.mutate(u=>{if(Array.isArray(a))for(const f of a)u.set(f.key,f.state);else u.set(a.key,a.state)})}function r(a){t.mutate(u=>{if(Array.isArray(a))for(const f of a)u.delete(n(f));else u.clear()})}async function i(a){const u=n(a);if(!t.get().has(u))try{s({key:u,state:{isLoading:!0}});const g=await e.get(a);s({key:u,state:{isLoading:!1,data:g}})}catch(g){s({key:u,state:{isLoading:!1,error:g}})}}function o(a){s(a.map(u=>({key:n(u[0]),state:{isLoading:!1,data:u[1]}})))}function c(a){const u=n(a);return t.get().get(u)}function l(a){const u=n(a);return t.get().get(u)?.data}function d(){return[...t.get().keys()]}return{subscribe:t.subscribe,enqueue:i,setData:o,getItemState:c,getData:l,invalidate:r,batch:e,_cacheKeys:d}}function Tf(e,t){const n=[];for(let s=0,r=e.length;s<r;s+=t)n.push(e.slice(s,s+t));return n}var xe=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,n)=>t+=(n&=63)<36?n.toString(36):n<62?(n-26).toString(36).toUpperCase():n<63?"_":"-",""),Cf="th",Of="cm",xf="at";function Ki(e){return`${e}_${xe()}`}function Df(){return Ki(Cf)}function Bo(){return Ki(Of)}function Rf(){return Ki(xf)}var Rt=class extends Map{#t;constructor(e,t){super(t),this.#t=e}getOrCreate(e,t){if(super.has(e))return super.get(e);{const s=(t??this.#t??Bt("DefaultMap used without a factory function"))(e);return this.set(e,s),s}}},Lf=/^[a-zA-Z_][a-zA-Z0-9_]*$/;function Mn(e){let t=[];const n=Object.entries(e),s=[],r=[],i=[];return n.forEach(([o,c])=>{if(!Lf.test(o))throw new Error("Key must only contain letters, numbers, _");Ho(c)?s.push([o,c]):Jt(c)&&($o(c)||Vo(c)?r.push([o,c]):i.push([o,c]))}),t=[...Fo(s),...jo(r)],i.forEach(([o,c])=>{const l=Object.entries(c),d=[],a=[];l.forEach(([u,f])=>{if(Pf(u))throw new Error("Key cannot be empty");Ho(f)?d.push([Ko(o,u),f]):($o(f)||Vo(f))&&a.push([Ko(o,u),f])}),t=[...t,...Fo(d),...jo(a)]}),t.map(({key:o,operator:c,value:l})=>`${o}${c}${Pa(l)}`).join(" ")}var Fo=e=>{const t=[];return e.forEach(([n,s])=>{t.push({key:n,operator:":",value:s})}),t},jo=e=>{const t=[];return e.forEach(([n,s])=>{"startsWith"in s&&typeof s.startsWith=="string"&&t.push({key:n,operator:"^",value:s.startsWith}),"lt"in s&&typeof s.lt=="number"&&t.push({key:n,operator:"<",value:s.lt}),"gt"in s&&typeof s.gt=="number"&&t.push({key:n,operator:">",value:s.gt}),"gte"in s&&typeof s.gte=="number"&&t.push({key:n,operator:">=",value:s.gte}),"lte"in s&&typeof s.lte=="number"&&t.push({key:n,operator:"<=",value:s.lte})}),t},Ho=e=>typeof e=="string"||typeof e=="number"||typeof e=="boolean"||e===null,Ko=(e,t)=>t?`${e}[${Pa(t)}]`:e,Pf=e=>!e||e.toString().trim()==="";function Pa(e){const t=JSON.stringify(e);return typeof e!="string"||t.includes("'")?t:`'${t.slice(1,-1).replace(/\\"/g,'"')}'`}function Uf(e){const t=new URLSearchParams;for(const[n,s]of Object.entries(e))s!=null&&t.set(n,s.toString());return t}function Nf(e,t,n){const s=new URL(t,e);return n!==void 0&&(s.search=(n instanceof URLSearchParams?n:Uf(n)).toString()),s.toString()}function D(e,...t){return e.reduce((n,s,r)=>n+encodeURIComponent(t[r-1]??"")+s)}function Mf({baseUrl:e,authManager:t,currentUserId:n,fetchPolyfill:s}){const r=new $f(e,s);async function i(p){const S=await r.get(D`/v2/c/rooms/${p.roomId}/threads/delta`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}),{since:p.since.toISOString()},{signal:p.signal});return{threads:{updated:S.data.map(be),deleted:S.deletedThreads.map(Or)},inboxNotifications:{updated:S.inboxNotifications.map(Me),deleted:S.deletedInboxNotifications.map(xr)},subscriptions:{updated:S.subscriptions.map(ve),deleted:S.deletedSubscriptions.map(Dr)},requestedAt:new Date(S.meta.requestedAt),permissionHints:S.meta.permissionHints}}async function o(p){let S;p.query&&(S=Mn(p.query));const T=50;try{const C=await r.get(D`/v2/c/rooms/${p.roomId}/threads`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}),{cursor:p.cursor,query:S,limit:T});return{threads:C.data.map(be),inboxNotifications:C.inboxNotifications.map(Me),subscriptions:C.subscriptions.map(ve),nextCursor:C.meta.nextCursor,requestedAt:new Date(C.meta.requestedAt),permissionHints:C.meta.permissionHints}}catch(C){if(C instanceof Qs&&C.status===404)return{threads:[],inboxNotifications:[],subscriptions:[],nextCursor:null,requestedAt:new Date(Date.now()-360*60*1e3),permissionHints:{}};throw C}}async function c(p){const S=p.commentId??Bo(),T=p.threadId??Df(),C=await r.post(D`/v2/c/rooms/${p.roomId}/threads`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}),{id:T,comment:{id:S,body:p.body,attachmentIds:p.attachmentIds},metadata:p.metadata});return be(C)}async function l(p){await r.delete(D`/v2/c/rooms/${p.roomId}/threads/${p.threadId}`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}))}async function d(p){const S=await r.rawGet(D`/v2/c/rooms/${p.roomId}/thread-with-notification/${p.threadId}`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}));if(S.ok){const T=await S.json();return{thread:be(T.thread),inboxNotification:T.inboxNotification?Me(T.inboxNotification):void 0,subscription:T.subscription?ve(T.subscription):void 0}}else{if(S.status===404)return{thread:void 0,inboxNotification:void 0,subscription:void 0};throw new Error(`There was an error while getting thread ${p.threadId}.`)}}async function a(p){return await r.post(D`/v2/c/rooms/${p.roomId}/threads/${p.threadId}/metadata`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}),p.metadata)}async function u(p){const S=p.commentId??Bo(),T=await r.post(D`/v2/c/rooms/${p.roomId}/threads/${p.threadId}/comments`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}),{id:S,body:p.body,attachmentIds:p.attachmentIds});return ii(T)}async function f(p){const S=await r.post(D`/v2/c/rooms/${p.roomId}/threads/${p.threadId}/comments/${p.commentId}`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}),{body:p.body,attachmentIds:p.attachmentIds});return ii(S)}async function g(p){await r.delete(D`/v2/c/rooms/${p.roomId}/threads/${p.threadId}/comments/${p.commentId}`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}))}async function m(p){const S=await r.post(D`/v2/c/rooms/${p.roomId}/threads/${p.threadId}/comments/${p.commentId}/reactions`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}),{emoji:p.emoji});return yf(S)}async function v(p){await r.delete(D`/v2/c/rooms/${p.roomId}/threads/${p.threadId}/comments/${p.commentId}/reactions/${p.emoji}`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}))}async function P(p){await r.post(D`/v2/c/rooms/${p.roomId}/threads/${p.threadId}/mark-as-resolved`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}))}async function L(p){await r.post(D`/v2/c/rooms/${p.roomId}/threads/${p.threadId}/mark-as-unresolved`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}))}async function I(p){const S=await r.post(D`/v2/c/rooms/${p.roomId}/threads/${p.threadId}/subscribe`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}));return ve(S)}async function U(p){await r.post(D`/v2/c/rooms/${p.roomId}/threads/${p.threadId}/unsubscribe`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}))}async function w(p){const S=p.roomId,T=p.signal,C=p.attachment,st=T?new DOMException(`Upload of attachment ${p.attachment.id} was aborted.`,"AbortError"):void 0;if(T?.aborted)throw st;const pt=tt=>{if(T?.aborted)throw st;if(tt instanceof Qs&&tt.status===413)throw tt;return!1},we=5*1024*1024,Pt=10,Ut=[2e3,2e3,2e3,2e3,2e3,2e3,2e3,2e3,2e3,2e3];function Qt(tt){const Ct=[];let te=0;for(;te<tt.size;){const Nt=Math.min(te+we,tt.size);Ct.push({partNumber:Ct.length+1,part:tt.slice(te,Nt)}),te=Nt}return Ct}if(C.size<=we)return Rr(async()=>r.putBlob(D`/v2/c/rooms/${S}/attachments/${C.id}/upload/${encodeURIComponent(C.name)}`,await t.getAuthValue({requestedScope:"comments:read",roomId:S}),C.file,{fileSize:C.size},{signal:T}),Pt,Ut,pt);{let tt;const Ct=[],te=await Rr(async()=>r.post(D`/v2/c/rooms/${S}/attachments/${C.id}/multipart/${encodeURIComponent(C.name)}`,await t.getAuthValue({requestedScope:"comments:read",roomId:S}),void 0,{signal:T},{fileSize:C.size}),Pt,Ut,pt);try{tt=te.uploadId;const Nt=Qt(C.file);if(T?.aborted)throw st;const _s=Tf(Nt,5);for(const Nn of _s){const rn=[];for(const{part:ks,partNumber:on}of Nn)rn.push(Rr(async()=>r.putBlob(D`/v2/c/rooms/${S}/attachments/${C.id}/multipart/${te.uploadId}/${String(on)}`,await t.getAuthValue({requestedScope:"comments:read",roomId:S}),ks,void 0,{signal:T}),Pt,Ut,pt));Ct.push(...await Promise.all(rn))}if(T?.aborted)throw st;const yr=Ct.sort((Nn,rn)=>Nn.partNumber-rn.partNumber);return r.post(D`/v2/c/rooms/${S}/attachments/${C.id}/multipart/${tt}/complete`,await t.getAuthValue({requestedScope:"comments:read",roomId:S}),{parts:yr},{signal:T})}catch(Nt){if(tt&&Nt?.name&&(Nt.name==="AbortError"||Nt.name==="TimeoutError"))try{await r.rawDelete(D`/v2/c/rooms/${S}/attachments/${C.id}/multipart/${tt}`,await t.getAuthValue({requestedScope:"comments:read",roomId:S}))}catch{}throw Nt}}}const E=new Rt(p=>{const S=new Ie(async T=>{const C=T.flat(),{urls:st}=await r.post(D`/v2/c/rooms/${p}/attachments/presigned-urls`,await t.getAuthValue({requestedScope:"comments:read",roomId:p}),{attachmentIds:C});return st.map(pt=>pt??new Error("There was an error while getting this attachment's URL"))},{delay:50});return wn(S)});function R(p){return E.getOrCreate(p)}function x(p){return R(p.roomId).batch.get(p.attachmentId)}async function K(p){const{chatId:S,attachment:T,signal:C}=p;if(n.get()===void 0)throw new Error("Attachment upload requires an authenticated user.");const pt=5*1024*1024;if(p.attachment.file.size<=pt)await r.putBlob(D`/v2/c/chats/${S}/attachments/${T.id}/upload/${encodeURIComponent(T.file.name)}`,await t.getAuthValue({requestedScope:"comments:read"}),T.file,{fileSize:T.file.size},{signal:C});else{const we=await r.post(D`/v2/c/chats/${S}/attachments/${T.id}/multipart/${encodeURIComponent(T.file.name)}`,await t.getAuthValue({requestedScope:"comments:read"}),void 0,{signal:C},{fileSize:T.file.size});try{const Pt=[],Ut=[];let Qt=0;for(;Qt<T.file.size;){const tt=Math.min(Qt+pt,T.file.size);Ut.push({number:Ut.length+1,part:T.file.slice(Qt,tt)}),Qt=tt}Pt.push(...await Promise.all(Ut.map(async({number:tt,part:Ct})=>await r.putBlob(D`/v2/c/chats/${S}/attachments/${T.id}/multipart/${we.uploadId}/${String(tt)}`,await t.getAuthValue({requestedScope:"comments:read"}),Ct,void 0,{signal:C})))),await r.post(D`/v2/c/chats/${S}/attachments/${T.id}/multipart/${we.uploadId}/complete`,await t.getAuthValue({requestedScope:"comments:read"}),{parts:Pt.sort((tt,Ct)=>tt.number-Ct.number)},{signal:C})}catch(Pt){try{await r.delete(D`/v2/c/chats/${S}/attachments/${T.id}/multipart/${we.uploadId}`,await t.getAuthValue({requestedScope:"comments:read"}))}catch{}throw Pt}}}const z=new Rt(p=>{const S=new Ie(async T=>{const C=T.flat(),{urls:st}=await r.post(D`/v2/c/chats/${p}/attachments/presigned-urls`,await t.getAuthValue({requestedScope:"comments:read"}),{attachmentIds:C});return st.map(pt=>pt??new Error("There was an error while getting this attachment's URL"))},{delay:50});return wn(S)});function G(p){return z.getOrCreate(p)}function ot(p){return G(p.chatId).batch.get(p.attachmentId)}async function dt(p){return r.get(D`/v2/c/rooms/${p.roomId}/subscription-settings`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}),void 0,{signal:p.signal})}async function O(p){return r.post(D`/v2/c/rooms/${p.roomId}/subscription-settings`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}),p.settings)}const k=new Rt(p=>new Ie(async S=>{const T=S.flat();return await r.post(D`/v2/c/rooms/${p}/inbox-notifications/read`,await t.getAuthValue({requestedScope:"comments:read",roomId:p}),{inboxNotificationIds:T}),T},{delay:50}));async function H(p){return k.getOrCreate(p.roomId).get(p.inboxNotificationId)}async function B(p){if(p.mention.kind!=="user"&&p.mention.kind!=="group")return gt(p.mention,"Unexpected mention kind");await r.rawPost(D`/v2/c/rooms/${p.roomId}/text-mentions`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}),{userId:p.mention.kind==="user"?p.mention.id:void 0,groupId:p.mention.kind==="group"?p.mention.id:void 0,userIds:p.mention.kind==="group"?p.mention.userIds:void 0,mentionId:p.mentionId})}async function W(p){await r.rawDelete(D`/v2/c/rooms/${p.roomId}/text-mentions/${p.mentionId}`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}))}async function ut(p){return r.rawGet(D`/v2/c/rooms/${p.roomId}/y-version/${p.versionId}`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}))}async function ht(p){await r.rawPost(D`/v2/c/rooms/${p.roomId}/version`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}))}async function Tt(p){await r.rawPost(D`/v2/c/rooms/${p.roomId}/text-metadata`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}),{type:p.type,rootKey:p.rootKey})}async function nn(p){const S=await r.post(D`/v2/c/rooms/${p.roomId}/ai/contextual-prompt`,await t.getAuthValue({requestedScope:"room:read",roomId:p.roomId}),{prompt:p.prompt,context:{beforeSelection:p.context.beforeSelection,selection:p.context.selection,afterSelection:p.context.afterSelection},previous:p.previous},{signal:p.signal});if(!S||S.content.length===0)throw new Error("No content returned from server");return S.content[0].text}async function Pn(p){const S=await r.get(D`/v2/c/rooms/${p.roomId}/versions`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}));return{versions:S.versions.map(({createdAt:T,...C})=>({createdAt:new Date(T),...C})),requestedAt:new Date(S.meta.requestedAt)}}async function Le(p){const S=await r.get(D`/v2/c/rooms/${p.roomId}/versions/delta`,await t.getAuthValue({requestedScope:"comments:read",roomId:p.roomId}),{since:p.since.toISOString()},{signal:p.signal});return{versions:S.versions.map(({createdAt:T,...C})=>({createdAt:new Date(T),...C})),requestedAt:new Date(S.meta.requestedAt)}}async function A(p){return await(await r.rawGet(D`/v2/c/rooms/${p.roomId}/storage`,await t.getAuthValue({requestedScope:"room:read",roomId:p.roomId}))).json()}async function V(p){return r.rawPost(D`/v2/c/rooms/${p.roomId}/send-message`,await t.getAuthValue({requestedScope:"room:read",roomId:p.roomId}),{nonce:p.nonce,messages:p.messages})}async function Q(p){let T;p?.query&&(T=Mn(p.query));const C=await r.get(D`/v2/c/inbox-notifications`,await t.getAuthValue({requestedScope:"comments:read"}),{cursor:p?.cursor,limit:50,query:T}),st=C.groups.map(Mo);return Ss.setData(st.map(pt=>[pt.id,pt])),{inboxNotifications:C.inboxNotifications.map(Me),threads:C.threads.map(be),subscriptions:C.subscriptions.map(ve),nextCursor:C.meta.nextCursor,requestedAt:new Date(C.meta.requestedAt)}}async function ct(p){let S;p?.query&&(S=Mn(p.query));const T=await r.get(D`/v2/c/inbox-notifications/delta`,await t.getAuthValue({requestedScope:"comments:read"}),{since:p.since.toISOString(),query:S},{signal:p.signal});return{inboxNotifications:{updated:T.inboxNotifications.map(Me),deleted:T.deletedInboxNotifications.map(xr)},threads:{updated:T.threads.map(be),deleted:T.deletedThreads.map(Or)},subscriptions:{updated:T.subscriptions.map(ve),deleted:T.deletedSubscriptions.map(Dr)},requestedAt:new Date(T.meta.requestedAt)}}async function Ft(p){let S;p?.query&&(S=Mn(p.query));const{count:T}=await r.get(D`/v2/c/inbox-notifications/count`,await t.getAuthValue({requestedScope:"comments:read"}),{query:S},{signal:p?.signal});return T}async function Zt(){await r.post(D`/v2/c/inbox-notifications/read`,await t.getAuthValue({requestedScope:"comments:read"}),{inboxNotificationIds:"all"})}async function Pe(p){await r.post(D`/v2/c/inbox-notifications/read`,await t.getAuthValue({requestedScope:"comments:read"}),{inboxNotificationIds:p})}const sn=new Ie(async p=>{const S=p.flat();return await Pe(S),S},{delay:50});async function ms(p){await sn.get(p)}async function ys(){await r.delete(D`/v2/c/inbox-notifications`,await t.getAuthValue({requestedScope:"comments:read"}))}async function ws(p){await r.delete(D`/v2/c/inbox-notifications/${p}`,await t.getAuthValue({requestedScope:"comments:read"}))}async function Un(p){return r.get(D`/v2/c/notification-settings`,await t.getAuthValue({requestedScope:"comments:read"}),void 0,{signal:p?.signal})}async function pr(p){return r.post(D`/v2/c/notification-settings`,await t.getAuthValue({requestedScope:"comments:read"}),p)}async function bs(p){let S;p?.query&&(S=Mn(p.query));const C=await r.get(D`/v2/c/threads`,await t.getAuthValue({requestedScope:"comments:read"}),{cursor:p?.cursor,query:S,limit:50});return{threads:C.threads.map(be),inboxNotifications:C.inboxNotifications.map(Me),subscriptions:C.subscriptions.map(ve),nextCursor:C.meta.nextCursor,requestedAt:new Date(C.meta.requestedAt),permissionHints:C.meta.permissionHints}}async function gr(p){const S=await r.get(D`/v2/c/threads/delta`,await t.getAuthValue({requestedScope:"comments:read"}),{since:p.since.toISOString()},{signal:p.signal});return{threads:{updated:S.threads.map(be),deleted:S.deletedThreads.map(Or)},inboxNotifications:{updated:S.inboxNotifications.map(Me),deleted:S.deletedInboxNotifications.map(xr)},subscriptions:{updated:S.subscriptions.map(ve),deleted:S.deletedSubscriptions.map(Dr)},requestedAt:new Date(S.meta.requestedAt),permissionHints:S.meta.permissionHints}}const vs=new Ie(async p=>{const S=p.flat(),{groups:T}=await r.post(D`/v2/c/groups/find`,await t.getAuthValue({requestedScope:"comments:read"}),{groupIds:S}),C=new Map;for(const st of T)C.set(st.id,Mo(st));return S.map(st=>C.get(st))},{delay:50}),Ss=wn(vs);function vt(p){return vs.get(p)}async function mr(p){const{metadata:S}=await r.get(D`/v2/c/urls/metadata`,await t.getAuthValue({requestedScope:"comments:read"}),{url:p});return S}return{getThreads:o,getThreadsSince:i,createThread:c,getThread:d,deleteThread:l,editThreadMetadata:a,createComment:u,editComment:f,deleteComment:g,addReaction:m,removeReaction:v,markThreadAsResolved:P,markThreadAsUnresolved:L,subscribeToThread:I,unsubscribeFromThread:U,markRoomInboxNotificationAsRead:H,getSubscriptionSettings:dt,updateSubscriptionSettings:O,createTextMention:B,deleteTextMention:W,getTextVersion:ut,createTextVersion:ht,reportTextEditor:Tt,listTextVersions:Pn,listTextVersionsSince:Le,getAttachmentUrl:x,uploadAttachment:w,getOrCreateAttachmentUrlsStore:R,uploadChatAttachment:K,getOrCreateChatAttachmentUrlsStore:G,getChatAttachmentUrl:ot,streamStorage:A,sendMessagesOverHTTP:V,getInboxNotifications:Q,getInboxNotificationsSince:ct,getUnreadInboxNotificationsCount:Ft,markAllInboxNotificationsAsRead:Zt,markInboxNotificationAsRead:ms,deleteAllInboxNotifications:ys,deleteInboxNotification:ws,getNotificationSettings:Un,updateNotificationSettings:pr,getUserThreads_experimental:bs,getUserThreadsSince_experimental:gr,groupsStore:Ss,getGroup:vt,executeContextualPrompt:nn,getUrlMetadata:mr}}function zi(e){return e.type==="public"?e.publicApiKey:e.token.raw}var $f=class{#t;#e;constructor(e,t){this.#t=e,this.#e=t}async#n(e,t,n,s){e.startsWith("/v2/c/")||Bt("This client can only be used to make /v2/c/* requests");const r=Nf(this.#t,e,s);return await this.#e(r,{...n,headers:{"Content-Type":"application/json; charset=utf-8",...n?.headers,Authorization:`Bearer ${zi(t)}`,"X-LB-Client":dr}})}async#s(e,t,n,s){const r=await this.#n(e,t,n,s);if(!r.ok)throw await Qs.fromResponse(r);let i;try{i=await r.json()}catch{i={}}return i}async rawGet(e,t,n,s){return await this.#n(e,t,s,n)}async rawPost(e,t,n){return await this.#n(e,t,{method:"POST",body:le(n)})}async rawDelete(e,t){return await this.#n(e,t,{method:"DELETE"})}async get(e,t,n,s){return await this.#s(e,t,s,n)}async post(e,t,n,s,r){return await this.#s(e,t,{...s,method:"POST",body:le(n)},r)}async delete(e,t){return await this.#s(e,t,{method:"DELETE"})}async putBlob(e,t,n,s,r){return await this.#s(e,t,{...r,method:"PUT",headers:{"Content-Type":"application/octet-stream"},body:n},s)}};function Vf(e,t){if(e===t)return[0,0];const n=e.split("."),s=t.split("."),r=Math.min(n.length,s.length);let i=0;for(;i<r&&n[i]===s[i];i++);const o=n.length-i,c=s.length-i;return[o,c]}function Bf(e,t){const n=e.split(".");if(t<1||t>n.length+1)throw new Error("Invalid number of levels");const s=[];t>n.length&&s.push("*");for(let r=n.length-t+1;r<n.length;r++){const i=n.slice(0,r);i.length>0&&s.push(i.join(".")+".*")}return s.push(e),s}var Ff=class{#t;constructor(e){this.#t=e}get current(){return this.#t}allowPatching(e){const t=this;let n=!0;const s={...this.#t,patch(r){if(n){t.#t=Object.assign({},t.#t,r);for(const i of Object.entries(r)){const[o,c]=i;o!=="patch"&&(this[o]=c)}}else throw new Error("Can no longer patch stale context")}};e(s),n=!1}},jf=1,Hf=class{id;#t;#e;#n;#s;#i;#r;events;#o;#c;#l;get#u(){const e=this.#n.values()[Symbol.iterator]().next();if(e.done)throw new Error("No states defined yet");return e.value}get currentState(){if(this.#s===null)throw this.#t===0?new Error("Not started yet"):new Error("Already stopped");return this.#s}start(){if(this.#t!==0)throw new Error("State machine has already started");return this.#t=1,this.#s=this.#u,this.#d(null),this}stop(){if(this.#t!==1)throw new Error("Cannot stop a state machine that hasn't started yet");this.#f(null),this.#t=2,this.#s=null}constructor(e){this.id=jf++,this.#t=0,this.#s=null,this.#n=new Set,this.#c=new Map,this.#o=[],this.#l=new Set,this.#i=new Map,this.#e=new Ff(e),this.#r={didReceiveEvent:J(),willTransition:J(),didIgnoreEvent:J(),willExitState:J(),didEnterState:J()},this.events={didReceiveEvent:this.#r.didReceiveEvent.observable,willTransition:this.#r.willTransition.observable,didIgnoreEvent:this.#r.didIgnoreEvent.observable,willExitState:this.#r.willExitState.observable,didEnterState:this.#r.didEnterState.observable}}get context(){return this.#e.current}addState(e){if(this.#t!==0)throw new Error("Already started");return this.#n.add(e),this}onEnter(e,t){if(this.#t!==0)throw new Error("Already started");if(this.#c.has(e))throw new Error(`enter/exit function for ${e} already exists`);return this.#c.set(e,t),this}onEnterAsync(e,t,n,s,r){return this.onEnter(e,()=>{const i=new AbortController,o=i.signal,c=r?setTimeout(()=>{const d=new Error("Timed out");this.#a({type:"ASYNC_ERROR",reason:d},s)},r):void 0;let l=!1;return t(this.#e.current,o).then(d=>{o.aborted||(l=!0,this.#a({type:"ASYNC_OK",data:d},n))},d=>{o.aborted||(l=!0,this.#a({type:"ASYNC_ERROR",reason:d},s))}),()=>{clearTimeout(c),l||i.abort()}})}#h(e){const t=[];if(e==="*")for(const n of this.#n)t.push(n);else if(e.endsWith(".*")){const n=e.slice(0,-1);for(const s of this.#n)s.startsWith(n)&&t.push(s)}else{const n=e;this.#n.has(n)&&t.push(n)}if(t.length===0)throw new Error(`No states match ${JSON.stringify(e)}`);return t}addTransitions(e,t){if(this.#t!==0)throw new Error("Already started");for(const n of this.#h(e)){let s=this.#i.get(n);s===void 0&&(s=new Map,this.#i.set(n,s));for(const[r,i]of Object.entries(t)){if(s.has(r))throw new Error(`Trying to set transition "${r}" on "${n}" (via "${e}"), but a transition already exists there.`);const o=i;if(this.#l.add(r),o!==void 0){const c=typeof o=="function"?o:()=>o;s.set(r,c)}}}return this}addTimedTransition(e,t,n){return this.onEnter(e,()=>{const s=typeof t=="function"?t(this.#e.current):t,r=setTimeout(()=>{this.#a({type:"TIMER"},n)},s);return()=>{clearTimeout(r)}})}#p(e){return this.#i.get(this.currentState)?.get(e)}#f(e){this.#r.willExitState.notify(this.currentState),this.#e.allowPatching(t=>{e=e??this.#o.length;for(let n=0;n<e;n++)this.#o.pop()?.(t)})}#d(e){const t=Bf(this.currentState,e??this.currentState.split(".").length+1);this.#e.allowPatching(n=>{for(const s of t){const i=this.#c.get(s)?.(n);typeof i=="function"?this.#o.push(i):this.#o.push(null)}}),this.#r.didEnterState.notify(this.currentState)}send(e){if(!this.#l.has(e.type))throw new Error(`Invalid event ${JSON.stringify(e.type)}`);if(this.#t===2)return;const t=this.#p(e.type);if(t!==void 0)return this.#a(e,t);this.#r.didIgnoreEvent.notify(e)}#a(e,t){this.#r.didReceiveEvent.notify(e);const n=this.currentState,r=(typeof t=="function"?t:()=>t)(e,this.#e.current);let i,o;if(r===null){this.#r.didIgnoreEvent.notify(e);return}if(typeof r=="string"?i=r:(i=r.target,o=Array.isArray(r.effect)?r.effect:[r.effect]),!this.#n.has(i))throw new Error(`Invalid next state name: ${JSON.stringify(i)}`);this.#r.willTransition.notify({from:n,to:i});const[c,l]=Vf(this.currentState,i);if(c>0&&this.#f(c),this.#s=i,o!==void 0){const d=o;this.#e.allowPatching(a=>{for(const u of d)typeof u=="function"?u(a,e):a.patch(u)})}l>0&&this.#d(l)}};function zo(e){return e===4999||e>=4e3&&e<4100}function Kf(e){return e>=4100&&e<4200}function Wo(e){return e===1013||e>=4200&&e<4300}function zf(e){return e==="initial"||e==="disconnected"}function Ua(e){const t=e.currentState;switch(t){case"@ok.connected":case"@ok.awaiting-pong":return"connected";case"@idle.initial":return"initial";case"@auth.busy":case"@auth.backoff":case"@connecting.busy":case"@connecting.backoff":case"@idle.zombie":return e.context.successCount>0?"reconnecting":"connecting";case"@idle.failed":return"disconnected";default:return gt(t,"Unknown state")}}var Na=[250,500,1e3,2e3,4e3,8e3,1e4],Ds=Na[0]-1,Wf=[2e3,3e4,6e4,3e5],qf=3e4,Gf=2e3,Yf=1e4,Jf=1e4,qt=class extends Error{constructor(e){super(e)}};function Ma(e,t){return t.find(n=>n>e)??t[t.length-1]}function cn(e){e.patch({backoffDelay:Ma(e.backoffDelay,Na)})}function qo(e){e.patch({backoffDelay:Ma(e.backoffDelay,Wf)})}function Go(e){e.patch({successCount:0})}function dn(e,t){const n=e===2?pe:e===1?bt:(()=>{});return()=>{n(t)}}function Yo(e){const t="Connection to Liveblocks websocket server";return n=>{e instanceof Error?bt(`${t} could not be established. ${String(e)}`):bt($a(e)?`${t} closed prematurely (code: ${e.code}). Retrying in ${n.backoffDelay}ms.`:`${t} could not be established.`)}}function Lr(e){const t=[`code: ${e.code}`];return e.reason&&t.push(`reason: ${e.reason}`),n=>{bt(`Connection to Liveblocks websocket server closed (${t.join(", ")}). Retrying in ${n.backoffDelay}ms.`)}}var Xf=dn(1,"Connection to WebSocket closed permanently. Won't retry.");function $a(e){return!(e instanceof Error)&&e.type==="close"}function Zf(e){const t=new Date().getTime();function n(...r){bt(`${((new Date().getTime()-t)/1e3).toFixed(2)} [FSM #${e.id}]`,...r)}const s=[e.events.didReceiveEvent.subscribe(r=>n(`Event ${r.type}`)),e.events.willTransition.subscribe(({from:r,to:i})=>n("Transitioning",r,"→",i)),e.events.didIgnoreEvent.subscribe(r=>n("Ignored event",r.type,r,"(current state won't handle it)"))];return()=>{for(const r of s)r()}}function Qf(e){const t=J(),n=J(),s=J();let r=null;const i=e.events.didEnterState.subscribe(()=>{const o=Ua(e);o!==r&&t.notify(o),r==="connected"&&o!=="connected"?s.notify():r!=="connected"&&o==="connected"&&n.notify(),r=o});return{statusDidChange:t.observable,didConnect:n.observable,didDisconnect:s.observable,unsubscribe:i}}var Rs=e=>t=>t.patch(e);function tp(e,t){const n=af();n.pause();const s=J();function r(I,U){return()=>{s.notify({message:I,code:U})}}const i={successCount:0,authValue:null,socket:null,backoffDelay:Ds},o=new Hf(i).addState("@idle.initial").addState("@idle.failed").addState("@idle.zombie").addState("@auth.busy").addState("@auth.backoff").addState("@connecting.busy").addState("@connecting.backoff").addState("@ok.connected").addState("@ok.awaiting-pong");o.addTransitions("*",{RECONNECT:{target:"@auth.backoff",effect:[cn,Go]},DISCONNECT:"@idle.initial"}),o.onEnter("@idle.*",Go).addTransitions("@idle.*",{CONNECT:(I,U)=>U.authValue!==null?"@connecting.busy":"@auth.busy"}),o.addTransitions("@auth.backoff",{NAVIGATOR_ONLINE:{target:"@auth.busy",effect:Rs({backoffDelay:Ds})}}).addTimedTransition("@auth.backoff",I=>I.backoffDelay,"@auth.busy").onEnterAsync("@auth.busy",()=>Uo(e.authenticate(),Yf,"Timed out during auth"),I=>({target:"@connecting.busy",effect:Rs({authValue:I.data})}),I=>I.reason instanceof qt?{target:"@idle.failed",effect:[dn(2,I.reason.message),r(I.reason.message,-1)]}:{target:"@auth.backoff",effect:[cn,dn(2,`Authentication failed: ${I.reason instanceof Error?I.reason.message:String(I.reason)}`)]});const c=I=>o.send({type:"EXPLICIT_SOCKET_ERROR",event:I}),l=I=>o.send({type:"EXPLICIT_SOCKET_CLOSE",event:I}),d=I=>I.data==="pong"?o.send({type:"PONG"}):n.notify(I);function a(I){I&&(I.removeEventListener("error",c),I.removeEventListener("close",l),I.removeEventListener("message",d),I.close())}o.addTransitions("@connecting.backoff",{NAVIGATOR_ONLINE:{target:"@connecting.busy",effect:Rs({backoffDelay:Ds})}}).addTimedTransition("@connecting.backoff",I=>I.backoffDelay,"@connecting.busy").onEnterAsync("@connecting.busy",async(I,U)=>{let w=null,E=null;const R=new Promise((x,K)=>{if(I.authValue===null)throw new Error("No auth authValue");const z=e.createSocket(I.authValue);E=z;function G(k){w=k,z.removeEventListener("message",d),K(k)}const[ot,dt]=La();t.waitForActorId||dt();function O(k){ce(k.data)?.type===104&&dt()}z.addEventListener("message",d),t.waitForActorId&&z.addEventListener("message",O),z.addEventListener("error",G),z.addEventListener("close",G),z.addEventListener("open",()=>{z.addEventListener("error",c),z.addEventListener("close",l);const k=()=>{z.removeEventListener("error",G),z.removeEventListener("close",G),z.removeEventListener("message",O)};ot.then(()=>{x([z,k])})})});return Uo(R,Jf,"Timed out during websocket connection").then(([x,K])=>{if(K(),U.aborted)throw new Error("Aborted");if(w)throw w;return x}).catch(x=>{throw a(E),x})},I=>({target:"@ok.connected",effect:Rs({socket:I.data,backoffDelay:Ds})}),I=>{const U=I.reason;if(U instanceof qt)return{target:"@idle.failed",effect:[dn(2,U.message),r(U.message,-1)]};if($a(U)){if(U.code===4109)return"@auth.busy";if(Wo(U.code))return{target:"@connecting.backoff",effect:[qo,Yo(U)]};if(zo(U.code))return{target:"@idle.failed",effect:[dn(2,U.reason),r(U.reason,U.code)]}}return{target:"@auth.backoff",effect:[cn,Yo(U)]}});const u={target:"@ok.awaiting-pong",effect:I=>{I.socket?.send("ping")}},f=()=>(typeof document<"u"?document:void 0)?.visibilityState==="hidden"&&e.canZombie()?"@idle.zombie":u;if(o.addTimedTransition("@ok.connected",qf,f).addTransitions("@ok.connected",{NAVIGATOR_OFFLINE:f,WINDOW_GOT_FOCUS:u}),o.addTransitions("@idle.zombie",{WINDOW_GOT_FOCUS:"@connecting.backoff"}),o.onEnter("@ok.*",I=>{I.patch({successCount:I.successCount+1});const U=setTimeout(n.unpause,0);return w=>{a(w.socket),w.patch({socket:null}),clearTimeout(U),n.pause()}}).addTransitions("@ok.awaiting-pong",{PONG:"@ok.connected"}).addTimedTransition("@ok.awaiting-pong",Gf,{target:"@connecting.busy",effect:dn(1,"Received no pong from server, assume implicit connection loss.")}).addTransitions("@ok.*",{EXPLICIT_SOCKET_ERROR:(I,U)=>U.socket?.readyState===1?null:{target:"@connecting.backoff",effect:cn},EXPLICIT_SOCKET_CLOSE:I=>zo(I.event.code)?{target:"@idle.failed",effect:[Xf,r(I.event.reason,I.event.code)]}:Kf(I.event.code)?I.event.code===4109?"@auth.busy":{target:"@auth.backoff",effect:[cn,Lr(I.event)]}:Wo(I.event.code)?{target:"@connecting.backoff",effect:[qo,Lr(I.event)]}:{target:"@connecting.backoff",effect:[cn,Lr(I.event)]}}),typeof document<"u"){const I=typeof document<"u"?document:void 0,U=typeof window<"u"?window:void 0,w=U??I;o.onEnter("*",E=>{function R(){o.send({type:"NAVIGATOR_OFFLINE"})}function x(){o.send({type:"NAVIGATOR_ONLINE"})}function K(){I?.visibilityState==="visible"&&o.send({type:"WINDOW_GOT_FOCUS"})}return U?.addEventListener("online",x),U?.addEventListener("offline",R),w?.addEventListener("visibilitychange",K),()=>{w?.removeEventListener("visibilitychange",K),U?.removeEventListener("online",x),U?.removeEventListener("offline",R),a(E.socket)}})}const g=[],{statusDidChange:m,didConnect:v,didDisconnect:P,unsubscribe:L}=Qf(o);return g.push(L),t.enableDebugLogging&&g.push(Zf(o)),o.start(),{machine:o,cleanups:g,events:{statusDidChange:m,didConnect:v,didDisconnect:P,onMessage:n.observable,onConnectionError:s.observable}}}var Va=class{#t;#e;events;constructor(e,t=!1,n=!0){const{machine:s,events:r,cleanups:i}=tp(e,{waitForActorId:n,enableDebugLogging:t});this.#t=s,this.events=r,this.#e=i}getStatus(){try{return Ua(this.#t)}catch{return"initial"}}get authValue(){return this.#t.context.authValue}connect(){this.#t.send({type:"CONNECT"})}reconnect(){this.#t.send({type:"RECONNECT"})}disconnect(){this.#t.send({type:"DISCONNECT"})}destroy(){this.#t.stop();let e;for(;e=this.#e.pop();)e()}send(e){const t=this.#t.context?.socket;t===null?bt("Cannot send: not connected yet",e):t.readyState!==1?bt("Cannot send: WebSocket no longer open",e):t.send(e)}_privateSendMachineEvent(e){this.#t.send(e)}},Je=Symbol(),Jo=Object.freeze({}),ep=Array.from(new Set("null")),np=Array.from(new Set("true")),sp=Array.from(new Set("false")),rp=Array.from(new Set("nulltruefalse"));function Pr(e,t){const n=e[e.length-1];return t.includes(n)?e.slice(0,-1):e}var ip=class{#t="";#e;#n=0;#s=!1;#i=-1;#r=-1;#o=[];constructor(e=""){this.append(e)}get source(){return this.#t}get json(){return this.#e===void 0&&(this.#e=this.#h()),this.#e}get#c(){return this.#i>=0}append(e){e&&(this.#t===""&&(e=e.trimStart()),this.#t+=e,this.#e=void 0)}#l(e){if(this.#c)return"";const t=e.charAt(e.length-1);if(t==="")return"";if(t==="-")return"0";if(!rp.includes(t))return"";if(ep.includes(t)){if(e.endsWith("nul"))return"l";if(e.endsWith("nu"))return"ll";if(e.endsWith("n"))return"ull"}if(np.includes(t)){if(e.endsWith("tru"))return"e";if(e.endsWith("tr"))return"ue";if(e.endsWith("t"))return"rue"}if(sp.includes(t)){if(e.endsWith("fals"))return"e";if(e.endsWith("fal"))return"se";if(e.endsWith("fa"))return"lse";if(e.endsWith("f"))return"alse"}return""}#u(){const e=this.#t.slice(this.#n);for(let t=0;t<e.length;t++){const n=e[t],s=this.#n+t;this.#c?this.#s?this.#s=!1:n==="\\"?this.#s=!0:n==='"'&&(this.#r=this.#i,this.#i=-1):n==='"'?this.#i=s:n==="{"?this.#o.push("}"):n==="["?this.#o.push("]"):n==="}"&&this.#o.length>0&&this.#o[this.#o.length-1]==="}"?this.#o.pop():n==="]"&&this.#o.length>0&&this.#o[this.#o.length-1]==="]"&&this.#o.pop()}this.#n=this.#t.length}#h(){this.#u();let e=this.#t;if(e.charAt(0)!=="{")return Jo;if(e.endsWith("}")){const n=ce(e);if(n)return n}this.#c&&(this.#s&&(e=e.slice(0,-1)),e+='"'),e=e.trimEnd(),e=Pr(e,",."),e=e+this.#l(e);const t=this.#o.reduceRight((n,s)=>n+s,"");{const n=ce(e+t);if(n)return n}return this.#c?e=e.slice(0,this.#i):(e=Pr(e,":"),e.endsWith('"')&&(e=e.slice(0,this.#r))),e=Pr(e,","),e+=t,ce(e)??Jo}};function op(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!Object.is(e[n],t[n]))return!1;return!0}function cp(e,t){if(!Jt(e)||!Jt(t))return!1;const n=Object.keys(e);return n.length!==Object.keys(t).length?!1:n.every(s=>Object.prototype.hasOwnProperty.call(t,s)&&Object.is(e[s],t[s]))}function ci(e,t){if(Object.is(e,t))return!0;const n=Array.isArray(e),s=Array.isArray(t);return n||s?!n||!s?!1:op(e,t):cp(e,t)}function ap(e,t){if(!Jt(e)||!Jt(t))return ci(e,t);const n=Object.keys(e);return n.length!==Object.keys(t).length?!1:n.every(s=>Object.prototype.hasOwnProperty.call(t,s)&&ci(e[s],t[s]))}var lp=class{#t;#e;#n;#s;#i;#r;constructor(e,t,n){this.#s=e,this.#i=t,this.#r=n,this.#t=new Map,this.#e=new Rt(()=>new Set),this.#n=$n.with(n)}get(e){return this.#t.get(e)}getOrThrow(e){return this.get(e)??Bt(`Item with id ${e} not found`)}get sorted(){return this.#n}getParentId(e){const t=this.getOrThrow(e);return this.#i(t)}getParent(e){const t=this.getParentId(e);return t?this.getOrThrow(t):null}getChildren(e){const t=this.#e.get(e);return t?Array.from(t).map(n=>this.#t.get(n)):[]}*walkUp(e,t){let n=e;do{const s=this.getOrThrow(n);(!t||t(s))&&(yield s),n=this.#i(s)}while(n!==null)}*walkLeft(e,t){const n=this.getOrThrow(e),s=$n.from(this.getSiblings(e),this.#r);for(const r of s.iterReversed())this.#r(n,r)||(!t||t(r))&&(yield r)}*walkRight(e,t){const n=this.getOrThrow(e),s=$n.from(this.getSiblings(e),this.#r);for(const r of s)this.#r(r,n)||(!t||t(r))&&(yield r)}*walkDown(e,t){const n=$n.from(this.getChildren(e),this.#r).rawArray;for(let s=n.length-1;s>=0;s--){const r=n[s];yield*this.walkDown(this.#s(r),t),(!t||t(r))&&(yield r)}}getSiblings(e){const t=this.getOrThrow(e),n=this.getParentId(e);return this.getChildren(n).filter(s=>s!==t)}[Symbol.iterator](){return this.#n[Symbol.iterator]()}upsert(e){const t=this.#s(e),n=this.#t.get(t);if(n){if(this.#i(n)!==this.#i(e))throw new Error("Cannot upsert parent ID changes that change the tree structure. Remove the entry first, and recreate it");this.#n.remove(n)}this.#t.set(t,e),this.#n.add(e);const s=this.#i(e);this.#e.getOrCreate(s).add(t)}remove(e){const t=this.#t.get(e);if(!t)return!1;if(this.#e.get(e))throw new Error(`Cannot remove item '${e}' while it still has children. Remove children first.`);const s=this.#i(t),r=this.#e.get(s);return r&&(r.delete(e),r.size===0&&this.#e.delete(s)),this.#n.remove(t),this.#e.delete(e),this.#t.delete(e),!0}clear(){return this.#t.size===0?!1:(this.#e.clear(),this.#t.clear(),this.#n.clear(),!0)}};function ai(e){return e.includes("room:write")}function Ba(e){return e.includes("comments:write")||e.includes("room:write")}function dp(e){return Jt(e)&&(e.k==="acc"||e.k==="id"||e.k==="sec-legacy")}function Xo(e){const t=e.split(".");if(t.length!==3)throw new Error("Authentication error: invalid JWT token");const n=ce(df(t[1]));if(!(n&&dp(n)))throw new Error("Authentication error: expected a valid token but did not get one. Hint: if you are using a callback, ensure the room is passed when creating the token. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientCallback");return{raw:e,parsed:n}}var up=4e3,hp=class{#t;#e;#n;constructor(){this.#t=new Set,this.#e=new Rt(()=>new Map),this.#n=void 0}registerLayer(e){const t=e;return this.#t.has(t)&&Bt(`Layer '${t}' already exists, provide a unique layer id`),this.#t.add(t),t}deregisterLayer(e){this.#t.delete(e);let t=!1;for(const[n,s]of this.#e)s.delete(e)&&(t=!0),s.size===0&&this.#e.delete(n);t&&this.invalidate()}get(){return this.#n??=this.#s()}invalidate(){this.#n=void 0}#s(){return Array.from(this.#e.values()).flatMap(e=>Array.from(e.values()).slice(-1).filter(_f))}updateKnowledge(e,t,n){this.#t.has(e)||Bt(`Unknown layer key: ${e}`),this.#e.getOrCreate(t).set(e,n),this.invalidate()}};function fp(){const e=new Rt(s=>new hp);function t(s){return e.getOrCreate(s??Kn)}function n(s){const r=e.getOrCreate(Kn).get(),i=e.get(s)?.get()??[];return[...r,...i]}return{getKnowledgeStack:t,getKnowledgeForChat:n}}function Ur(){return new Date().toISOString()}var Kn=Symbol("*");function pp(){const e=new Rt(o=>new Rt(c=>new Dt(void 0))),t=new Rt(o=>{const[c,l]=ce(o);return ae.from(()=>(l!==void 0?e.getOrCreate(l).getOrCreate(c):void 0)?.get()??e.getOrCreate(Kn).getOrCreate(c).get())});function n(o,c){const l=JSON.stringify(c!==void 0?[o,c]:[o]);return t.getOrCreate(l)}function s(o,c,l){if(!c.execute&&!c.render)throw new Error("A tool definition must have an execute() function, a render() function, or both.");const d=l??Kn;return e.getOrCreate(d).getOrCreate(o).set(c),()=>r(d,o)}function r(o,c){const l=e.get(o);if(l===void 0)return;const d=l.get(c);d!==void 0&&d.set(void 0)}function i(o){const c=e.get(Kn),l=e.get(o);return Array.from([...c?.entries()??[],...l?.entries()??[]]).flatMap(([d,a])=>{const u=a.get();return u&&(u.enabled??!0)?[{name:d,description:u.description,parameters:u.parameters}]:[]})}return{getToolDescriptions:i,getToolΣ:n,registerTool:s}}function gp(e,t){const n=new Set,s=new Set,r=new Rt(w=>new Tn(new lp(E=>E.id,E=>E.parentId,(E,R)=>E.createdAt<R.createdAt))),i=new Tn(new Map);function o(w,E,R,x){const K=`ms_${xe()}`,z=Ur();return a(E==="user"?{id:K,chatId:w,role:E,parentId:R,createdAt:z,content:x,_optimistic:!0}:{id:K,chatId:w,role:E,parentId:R,createdAt:z,status:"generating",contentSoFar:[],copilotId:x,_optimistic:!0}),K}function c(w){Ce(()=>{for(const E of w)a(E)})}function l(w,E){const R=r.get(w);if(!R)return;const x=R.get().get(E);!x||x.deletedAt||(x.role==="assistant"&&x.status!=="completed"?a({...x,deletedAt:Ur(),contentSoFar:[]}):a({...x,deletedAt:Ur(),content:[]}))}function d(w){const E=r.get(w);E!==void 0&&E.mutate(R=>R.clear())}function a(w){Ce(()=>{if(r.getOrCreate(w.chatId).mutate(R=>R.upsert(w)),w.role==="assistant"&&w.status==="generating"?i.mutate(R=>{R.set(w.id,structuredClone(w))}):i.mutate(R=>{R.delete(w.id)}),w.role==="assistant"&&w.status==="awaiting-tool"){if(n.has(w.id))for(const R of w.contentSoFar.filter(x=>x.type==="tool-invocation"&&x.stage==="executing")){if(!s.has(R.invocationId))s.add(R.invocationId);else continue;const x=e.getToolΣ(R.name,w.chatId).get()?.execute;x&&(async()=>{const K=await x(R.args,{name:R.name,invocationId:R.invocationId});return await t(w.chatId,w.id,R.invocationId,K??{data:{}},{copilotId:w.copilotId})})().catch(K=>{pe(`Error trying to respond to tool-call: ${String(K)} (in execute())`)})}}else w.role==="assistant"&&w.status==="generating"||n.delete(w.id)})}function u(w,E){i.mutate(R=>{const x=R.get(w);return x===void 0?!1:(bp(x.contentSoFar,E),R.set(w,x),!0)})}function*f(){for(const w of r.values())for(const E of w.get())E.role==="assistant"&&E.status==="generating"&&!E._optimistic&&(yield E)}function g(){Ce(()=>{i.mutate(w=>{let E=!1;for(const[R,x]of w)x._optimistic||(w.delete(R),E=!0);return E}),c(Array.from(f()).map(w=>({...w,status:"failed",errorReason:"Lost connection"})))})}function m(w){for(const E of r.values()){const R=E.get().get(w);if(R)return R}}function v(w){const E=w.next();return E.done?void 0:E.value}function P(w,E){function R(G){if(!G.deletedAt)return!0;for(const ot of w.walkDown(G.id,dt=>!dt.deletedAt))return!0;return!1}function x(G){const ot=[];let dt=null;for(const O of w.walkUp(G.id)){const k=v(w.walkLeft(O.id,R))?.id??null,H=v(w.walkRight(O.id,R))?.id??null;if(!O.deletedAt||k||H){const B={...O,navigation:{parent:null,prev:k,next:H}};dt!==null&&(dt.navigation.parent=B.id),dt=B,ot.push(B)}}return ot.reverse()}function K(){const G=w.sorted.findRight(ot=>!ot.deletedAt);return G?x(G):[]}if(E===null)return K();const z=w.get(E);if(!z)return K();for(const G of w.walkUp(z.id)){for(const ot of w.walkDown(G.id,dt=>!dt.deletedAt))return x(ot);if(!G.deletedAt)return x(G)}return K()}const L=new Rt(w=>new Rt(E=>{const R=ae.from(()=>{const x=r.getOrCreate(w).get();return P(x,E)},ap);return ae.from(()=>{const x=i.get();return R.get().map(K=>{if(K.role!=="assistant"||K.status!=="generating")return K;const z=x.get(K.id);return z===void 0?K:{...K,contentSoFar:z.contentSoFar}})},ci)}));function I(w,E){return L.getOrCreate(w).getOrCreate(E||null)}function U(w){return r.getOrCreate(w).get().sorted.findRight(x=>x.role==="assistant"&&!x.deletedAt)?.copilotId}return{getMessageById:m,getChatMessagesForBranchΣ:I,getLastUsedCopilotId:U,createOptimistically:o,upsert:a,upsertMany:c,remove:l,removeByChatId:d,addDelta:u,failAllPending:g,markMine(w){n.add(w)},*getAutoExecutingMessageIds(){for(const w of n){const E=m(w);E?.role==="assistant"&&E.status==="awaiting-tool"&&E.contentSoFar.some(x=>x.type==="tool-invocation"&&x.stage==="executing"?typeof e.getToolΣ(x.name,E.chatId).get()?.execute=="function":!1)&&(yield E.id)}}}}function mp(){const e=new mf;function t(o){Ce(()=>{for(const c of o)e.upsert(c)})}function n(o){e.upsert(o)}function s(o){e.markDeleted(o)}function r(o){return e.getEvenIfDeleted(o)}function i(o){return e.signal.get().findMany(o)}return{getChatById:r,findMany:i,upsert:n,upsertMany:t,markDeleted:s}}function yp(e){const t=new Va(e.delegates,e.enableDebugLogging,!1),n=mp(),s=pp(),r=fp(),i=gp(s,G),o={staticSessionInfoSig:new Dt(null),dynamicSessionInfoSig:new Dt(null),pendingCmds:new Map,chatsStore:n,messagesStore:i,toolsStore:s,knowledgeStore:r},c=new Dt("initial"),l=25;let d=[],a=null;function u(){const O=d;d=[],a!==null&&(clearTimeout(a),a=null),Ce(()=>{for(const{id:k,delta:H}of O)o.messagesStore.addDelta(k,H)})}function f(O,k){d.push({id:O,delta:k}),a===null&&(a=setTimeout(u,l))}let g;function m(O){const k=t.authValue;if(k!==null){const H=zi(k);if(H!==g)if(g=H,k.type==="secret"){const B=k.token.parsed;o.staticSessionInfoSig.set({userId:B.k==="sec-legacy"?B.id:B.uid,userInfo:B.k==="sec-legacy"?B.info:B.ui})}else o.staticSessionInfoSig.set({userId:void 0,userInfo:void 0})}c.set(O)}let v;function P(O){O==="reconnecting"?v=setTimeout(()=>{},e.lostConnectionTimeout):clearTimeout(v)}function L(){}function I(){u()}function U(O){if(typeof O.data!="string")return;const k=ce(O.data);if(!k)return;const H="cmdId"in k?k.cmdId:k.event==="cmd-failed"?k.failedCmdId:void 0,B=o.pendingCmds.get(H);if(H&&!B){bt("Ignoring unexpected command response. Already timed out, or not for us?",k);return}if("event"in k)if(k.event==="delta"){const{id:W,delta:ut}=k;f(W,ut)}else Ce(()=>{switch(u(),k.event){case"cmd-failed":B?.reject(new Error(k.error));break;case"settle":{o.messagesStore.upsert(k.message);break}case"warning":bt(k.message);break;case"error":pe(k.error);break;case"rebooted":o.messagesStore.failAllPending();break;case"sync":for(const W of k["-messages"]??[])o.messagesStore.remove(W.chatId,W.id);for(const W of k["-chats"]??[])o.chatsStore.markDeleted(W),o.messagesStore.removeByChatId(W);for(const W of k.clear??[])o.messagesStore.removeByChatId(W);k.chats&&o.chatsStore.upsertMany(k.chats),k.messages&&o.messagesStore.upsertMany(k.messages);break;default:return gt(k,"Unhandled case")}});else switch(k.cmd){case"get-chats":o.chatsStore.upsertMany(k.chats);break;case"get-or-create-chat":o.chatsStore.upsert(k.chat);break;case"delete-chat":o.chatsStore.markDeleted(k.chatId),o.messagesStore.removeByChatId(k.chatId);break;case"get-message-tree":o.chatsStore.upsert(k.chat),o.messagesStore.upsertMany(k.messages);break;case"delete-message":o.messagesStore.remove(k.chatId,k.messageId);break;case"clear-chat":o.messagesStore.removeByChatId(k.chatId);break;case"ask-in-chat":k.sourceMessage&&o.messagesStore.upsert(k.sourceMessage),o.messagesStore.upsert(k.targetMessage);break;case"abort-ai":break;case"set-tool-result":k.ok&&o.messagesStore.upsert(k.message);break;default:return gt(k,"Unhandled case")}B?.resolve(k)}t.events.onMessage.subscribe(U),t.events.statusDidChange.subscribe(m),t.events.statusDidChange.subscribe(P),t.events.didConnect.subscribe(L),t.events.didDisconnect.subscribe(I),t.events.onConnectionError.subscribe(({message:O,code:k})=>{});function w(){t.getStatus()==="initial"&&t.connect()}async function E(O){w(),t.getStatus()!=="connected"&&await t.events.didConnect.waitUntil();const{promise:k,resolve:H,reject:B}=Hi(),W=AbortSignal.timeout(up);W.addEventListener("abort",()=>B(W.reason),{once:!0});const ut=xe(7);return o.pendingCmds.set(ut,{resolve:H,reject:B}),R({...O,cmdId:ut}),k.finally(()=>{o.pendingCmds.delete(ut)}).catch(ht=>{throw pe(ht.message),ht})}function R(O){t.send(JSON.stringify({...O}))}function x(O={}){return E({cmd:"get-chats",cursor:O.cursor,query:O.query})}function K(O,k){return E({cmd:"get-or-create-chat",id:O,options:k})}function z(O){return E({cmd:"get-message-tree",chatId:O})}async function G(O,k,H,B,W){const ut=o.knowledgeStore.getKnowledgeForChat(O),ht=o.toolsStore.getToolDescriptions(O),Tt=await E({cmd:"set-tool-result",chatId:O,messageId:k,invocationId:H,result:B,generationOptions:{copilotId:W?.copilotId,stream:W?.stream,timeout:W?.timeout,knowledge:ut.length>0?ut:void 0,tools:ht.length>0?ht:void 0}});Tt.ok&&i.markMine(Tt.message.id)}function ot(){for(const O of o.messagesStore.getAutoExecutingMessageIds())E({cmd:"abort-ai",messageId:O}).catch(()=>{})}return(typeof window<"u"?window:void 0)?.addEventListener("beforeunload",ot,{once:!0}),Object.defineProperty({[Je]:{context:o},connectInitially:w,disconnect:()=>t.disconnect(),getChats:x,getOrCreateChat:K,deleteChat:O=>E({cmd:"delete-chat",chatId:O}),getMessageTree:z,deleteMessage:(O,k)=>E({cmd:"delete-message",chatId:O,messageId:k}),clearChat:O=>E({cmd:"clear-chat",chatId:O}),askUserMessageInChat:async(O,k,H,B)=>{const W=o.knowledgeStore.getKnowledgeForChat(O),ut=B?.knowledge||[],ht=[...W,...ut],Tt=o.toolsStore.getToolDescriptions(O);return i.markMine(H),await E({cmd:"ask-in-chat",chatId:O,sourceMessage:k,targetMessageId:H,generationOptions:{copilotId:B?.copilotId,stream:B?.stream,timeout:B?.timeout,knowledge:ht.length>0?ht:void 0,tools:Tt.length>0?Tt:void 0}})},abort:O=>E({cmd:"abort-ai",messageId:O}),setToolResult:G,getStatus:()=>t.getStatus(),signals:{getChatMessagesForBranchΣ:o.messagesStore.getChatMessagesForBranchΣ,getToolΣ:o.toolsStore.getToolΣ,statusΣ:c},getChatById:o.chatsStore.getChatById,queryChats:o.chatsStore.findMany,getLastUsedCopilotId:o.messagesStore.getLastUsedCopilotId,registerKnowledgeLayer:(O,k)=>{const H=o.knowledgeStore.getKnowledgeStack(k),B=H.registerLayer(O);return{layerKey:B,deregister:()=>H.deregisterLayer(B)}},updateKnowledge:(O,k,H,B)=>{o.knowledgeStore.getKnowledgeStack(B).updateKnowledge(O,H??xe(),k)},registerTool:o.toolsStore.registerTool},Je,{enumerable:!1})}function wp(e,t){return n=>{const s=t??(typeof WebSocket>"u"?void 0:WebSocket);if(s===void 0)throw new qt("To use Liveblocks client in a non-DOM environment, you need to provide a WebSocket polyfill.");const r=new URL(e);if(r.protocol=r.protocol==="http:"?"ws":"wss",r.pathname="/ai/v7",n.type==="secret")r.searchParams.set("tok",n.token.raw);else{if(n.type==="public")throw new Error("Public key not supported with AI Copilots");return gt(n,"Unhandled case")}return r.searchParams.set("version",dr),new s(r.toString())}}function Zo(e,t,n,s){const r=hf(e,i=>i.type===t.type&&n(i)===n(t));r>-1?e[r]=t:(li(e[e.length-1],s),e.push(t))}function li(e,t){e?.type==="reasoning"&&(e.endedAt??=t)}function bp(e,t){if(t===null)return;const n=e.filter(o=>o.type!=="sources"),s=e.filter(o=>o.type==="sources").flatMap(o=>o.sources),r=new Date().toISOString(),i=n[n.length-1];switch(t.type){case"text-delta":i?.type==="text"?i.text+=t.textDelta:(li(i,r),n.push({type:"text",text:t.textDelta}));break;case"reasoning-delta":i?.type==="reasoning"?i.text+=t.textDelta:(li(i,r),n.push({type:"reasoning",text:t.textDelta,startedAt:r}));break;case"tool-stream":{const o=vp(t.invocationId,t.name);n.push(o);break}case"tool-delta":{i?.type==="tool-invocation"&&i.stage==="receiving"&&i.__appendDelta?.(t.delta);break}case"tool-invocation":Zo(n,t,o=>o.invocationId,r);break;case"retrieval":Zo(n,t,o=>o.id,r);break;case"source":{s.push(t);break}default:return gt(t,"Unhandled case")}s.length>0&&n.push({type:"sources",sources:s}),e.length=0,e.push(...n)}function vp(e,t,n=""){const s=new ip(n);return{type:"tool-invocation",stage:"receiving",invocationId:e,name:t,get partialArgsText(){return s.source},get partialArgs(){return s.json},__appendDelta(r){s.append(r)}}}function Sp(e,t){const n=_p(e),s=new Set,r=[],i=[],o=new Map;function c(){s.clear(),r.length=0,i.length=0,o.clear()}function l(f,g){return f==="comments:read"?g.includes("comments:read")||g.includes("comments:write")||g.includes("room:read")||g.includes("room:write"):f==="room:read"?g.includes("room:read")||g.includes("room:write"):!1}function d(f){const g=Math.ceil(Date.now()/1e3);for(let m=r.length-1;m>=0;m--){const v=r[m];if(i[m]<=g){r.splice(m,1),i.splice(m,1);continue}if(v.parsed.k==="id")return v;if(v.parsed.k==="acc"){if(!f.roomId&&Object.entries(v.parsed.perms).length===0)return v;for(const[L,I]of Object.entries(v.parsed.perms))if(f.roomId){if(L.includes("*")&&f.roomId.startsWith(L.replace("*",""))||f.roomId===L&&l(f.requestedScope,I))return v}else if(L.includes("*")&&l(f.requestedScope,I))return v}}}async function a(f){const g=e.polyfills?.fetch??(typeof window>"u"?void 0:window.fetch);if(n.type==="private"){if(g===void 0)throw new qt("To use Liveblocks client in a non-DOM environment with a url as auth endpoint, you need to provide a fetch polyfill.");const m=await kp(g,n.url,{room:f.roomId}),v=Xo(m.token);if(s.has(v.raw))throw new qt("The same Liveblocks auth token was issued from the backend before. Caching Liveblocks tokens is not supported.");return t?.(v.parsed),v}if(n.type==="custom"){const m=await n.callback(f.roomId);if(m&&typeof m=="object"){if(typeof m.token=="string"){const v=Xo(m.token);return t?.(v.parsed),v}else if(typeof m.error=="string"){const v=`Authentication failed: ${"reason"in m&&typeof m.reason=="string"?m.reason:"Forbidden"}`;throw m.error==="forbidden"?new qt(v):new Error(v)}}throw new Error('Your authentication callback function should return a token, but it did not. Hint: the return value should look like: { token: "..." }')}throw new Error("Unexpected authentication type. Must be private or custom.")}async function u(f){if(n.type==="public")return{type:"public",publicApiKey:n.publicApiKey};const g=d(f);if(g!==void 0)return{type:"secret",token:g};let m;f.roomId?(m=o.get(f.roomId),m===void 0&&(m=a(f),o.set(f.roomId,m))):(m=o.get("liveblocks-user-token"),m===void 0&&(m=a(f),o.set("liveblocks-user-token",m)));try{const v=await m,L=Math.floor(Date.now()/1e3)+(v.parsed.exp-v.parsed.iat)-30;return s.add(v.raw),v.parsed.k!=="sec-legacy"&&(r.push(v),i.push(L)),{type:"secret",token:v}}finally{f.roomId?o.delete(f.roomId):o.delete("liveblocks-user-token")}}return{reset:c,getAuthValue:u}}function _p(e){const{publicApiKey:t,authEndpoint:n}=e;if(n!==void 0&&t!==void 0)throw new Error("You cannot simultaneously use `publicApiKey` and `authEndpoint` options. Please pick one and leave the other option unspecified. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClient");if(typeof t=="string"){if(t.startsWith("sk_"))throw new Error("Invalid `publicApiKey` option. The value you passed is a secret key, which should not be used from the client. Please only ever pass a public key here. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientPublicKey");if(!t.startsWith("pk_"))throw new Error("Invalid key. Please use the public key format: pk_<public key>. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientPublicKey");return{type:"public",publicApiKey:t}}if(typeof n=="string")return{type:"private",url:n};if(typeof n=="function")return{type:"custom",callback:n};throw n!==void 0?new Error("The `authEndpoint` option must be a string or a function. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientAuthEndpoint"):new Error("Invalid Liveblocks client options. Please provide either a `publicApiKey` or `authEndpoint` option. They cannot both be empty. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClient")}async function kp(e,t,n){const s=await e(t,{method:"POST",headers:{"Content-Type":"application/json"},body:le(n)});if(!s.ok){const o=`${(await s.text()).trim()||"reason not provided in auth response"} (${s.status} returned by POST ${t})`;throw s.status===401||s.status===403?new qt(`Unauthorized: ${o}`):new Error(`Failed to authenticate: ${o}`)}let r;try{r=await s.json()}catch(o){throw new Error(`Expected a JSON response when doing a POST request on "${t}". ${String(o)}`)}if(!Jt(r)||typeof r.token!="string")throw new Error(`Expected a JSON response of the form \`{ token: "..." }\` when doing a POST request on "${t}", but got ${le(r)}`);const{token:i}=r;return{token:i}}var Ip="https://api.liveblocks.io",Ep=J();Ep.observable;function Nr(e,t,n=t){typeof e=="function"&&e()}var Qo=Symbol("notification-settings-plain");function tc(e){const t=["email","slack","teams","webPush"],n={[Qo]:{value:e,enumerable:!1}};for(const s of t)n[s]={enumerable:!0,get(){const r=this[Qo][s];return typeof r>"u"?(pe(`In order to use the '${s}' channel, please set up your project first. For more information: https://liveblocks.io/docs/errors/enable-a-notification-channel`),null):r}};return lf(null,n)}var Vt=32,De=126,Ap=De-Vt+1,Wi=qi(0),hr=qi(1),Tp=Wi+qi(-1);function qi(e){const t=Vt+(e<0?Ap+e:e);if(t<Vt||t>De)throw new Error(`Invalid n value: ${e}`);return String.fromCharCode(t)}function ne(e,t){return e!==void 0&&t!==void 0?xp(e,t):e!==void 0?Op(e):t!==void 0?Cp(t):hr}function Cp(e){const t=e.length-1;for(let n=0;n<=t;n++){const s=e.charCodeAt(n);if(!(s<=Vt))return n===t?s===Vt+1?e.substring(0,n)+Tp:e.substring(0,n)+String.fromCharCode(s-1):e.substring(0,n+1)}return hr}function Op(e){for(let t=0;t<=e.length-1;t++){const n=e.charCodeAt(t);if(!(n>=De))return e.substring(0,t)+String.fromCharCode(n+1)}return e+hr}function xp(e,t){if(e<t)return di(e,t);if(e>t)return di(t,e);throw new Error("Cannot compute value between two equal positions")}function di(e,t){let n=0;const s=e.length,r=t.length;for(;;){const i=n<s?e.charCodeAt(n):Vt,o=n<r?t.charCodeAt(n):De;if(i===o){n++;continue}if(o-i===1){const c=n+1;let l=e.substring(0,c);l.length<c&&(l+=Wi.repeat(c-l.length));const d=e.substring(c);return l+di(d,"")}else return Dp(e,n)+String.fromCharCode(o+i>>1)}}function Dp(e,t){return t<e.length?e.substring(0,t):e+Wi.repeat(t-e.length)}var Rp=Vt+1;function Lp(e){if(e==="")return!1;const t=e.length-1,n=e.charCodeAt(t);if(n<Rp||n>De)return!1;for(let s=0;s<t;s++){const r=e.charCodeAt(s);if(r<Vt||r>De)return!1}return!0}function Pp(e){const t=[];for(let n=0;n<e.length;n++){const s=e.charCodeAt(n);t.push(s<Vt?Vt:s>De?De:s)}for(;t.length>0&&t[t.length-1]===Vt;)t.length--;return t.length>0?String.fromCharCode(...t):hr}function as(e){return Lp(e)?e:Pp(e)}function Up(e){return e.type===5&&e.id==="ACK"}function Np(e,t){const{getCurrentConnectionId:n,onDispatch:s,isStorageWritable:r=()=>!0}=t;let i=0,o=0;const c=new Map;return{roomId:e,nodes:c,getNode:l=>c.get(l),addNode:(l,d)=>void c.set(l,d),deleteNode:l=>void c.delete(l),generateId:()=>`${n()}:${i++}`,generateOpId:()=>`${n()}:${o++}`,dispatch(l,d,a){s?.(l,d,a)},assertStorageIsWritable:()=>{if(!r())throw new Error("Cannot write to storage with a read only user, please ensure the user has write permissions")}}}function ec(e,t,n=as(t)){return Object.freeze({type:"HasParent",node:e,key:t,pos:n})}var nc=Object.freeze({type:"NoParent"});function Mp(e,t=as(e)){return Object.freeze({type:"Orphaned",oldKey:e,oldPos:t})}var fr=class{#t;#e;#n=nc;_getParentKeyOrThrow(){switch(this.parent.type){case"HasParent":return this.parent.key;case"NoParent":throw new Error("Parent key is missing");case"Orphaned":return this.parent.oldKey;default:return gt(this.parent,"Unknown state")}}get _parentPos(){switch(this.parent.type){case"HasParent":return this.parent.pos;case"NoParent":throw new Error("Parent key is missing");case"Orphaned":return this.parent.oldPos;default:return gt(this.parent,"Unknown state")}}get _pool(){return this.#t}get roomId(){return this.#t?this.#t.roomId:null}get _id(){return this.#e}get parent(){return this.#n}get _parentKey(){switch(this.parent.type){case"HasParent":return this.parent.key;case"NoParent":return null;case"Orphaned":return this.parent.oldKey;default:return gt(this.parent,"Unknown state")}}_apply(e,t){switch(e.type){case 5:return this.parent.type==="HasParent"?this.parent.node._detachChild(this):{modified:!1}}return{modified:!1}}_setParentLink(e,t){switch(this.parent.type){case"HasParent":if(this.parent.node!==e)throw new Error("Cannot set parent: node already has a parent");this.#n=ec(e,t);return;case"Orphaned":case"NoParent":{this.#n=ec(e,t);return}default:return gt(this.parent,"Unknown state")}}_attach(e,t){if(this.#e||this.#t)throw new Error("Cannot attach node: already attached");t.addNode(e,this),this.#e=e,this.#t=t}_detach(){switch(this.#t&&this.#e&&this.#t.deleteNode(this.#e),this.parent.type){case"HasParent":{this.#n=Mp(this.parent.key,this.parent.pos);break}case"NoParent":{this.#n=nc;break}case"Orphaned":break;default:gt(this.parent,"Unknown state")}this.#t=void 0}#s;#i;#r;invalidate(){(this.#s!==void 0||this.#r!==void 0)&&(this.#s=void 0,this.#r=void 0,this.parent.type==="HasParent"&&this.parent.node.invalidate())}toTreeNode(e){return(this.#r===void 0||this.#i!==e)&&(this.#i=e,this.#r=this._toTreeNode(e)),this.#r}toImmutable(){return this.#s===void 0&&(this.#s=this._toImmutable()),this.#s}};function $p(e){return e.type===0&&!Vp(e)}function Vp(e){return e.parentId!==void 0&&e.parentKey!==void 0}var Re=class Fa extends fr{#t;constructor(t){super(),this.#t=t}get data(){return this.#t}static _deserialize([t,n],s,r){const i=new Fa(n.data);return i._attach(t,r),i}_toOps(t,n,s){if(this._id===void 0)throw new Error("Cannot serialize register if parentId or parentKey is undefined");return[{type:8,opId:s?.generateOpId(),id:this._id,parentId:t,parentKey:n,data:this.data}]}_serialize(){if(this.parent.type!=="HasParent")throw new Error("Cannot serialize LiveRegister if parent is missing");return{type:3,parentId:M(this.parent.node._id,"Parent node expected to have ID"),parentKey:this.parent.key,data:this.data}}_attachChild(t){throw new Error("Method not implemented.")}_detachChild(t){throw new Error("Method not implemented.")}_apply(t,n){return super._apply(t,n)}_toTreeNode(t){return{type:"Json",id:this._id??xe(),key:t,payload:this.#t}}_toImmutable(){return this.#t}clone(){return cs(this.data)}};function Bp(e,t){const n=e._parentPos,s=t._parentPos;return n===s?0:n<s?-1:1}var Dn=class ui extends fr{#t;#e;#n;constructor(t){super(),this.#t=[],this.#e=new WeakSet,this.#n=new Map;let n;for(const s of t){const r=ne(n),i=bn(s);i._setParentLink(this,r),this.#t.push(i),n=r}}static _deserialize([t],n,s){const r=new ui([]);r._attach(t,s);const i=n.get(t);if(i===void 0)return r;for(const[o,c]of i){const l=Ka([o,c],n,s);l._setParentLink(r,c.parentKey),r._insertAndSort(l)}return r}_toOps(t,n,s){if(this._id===void 0)throw new Error("Cannot serialize item is not attached");const r=[],i={id:this._id,opId:s?.generateOpId(),type:2,parentId:t,parentKey:n};r.push(i);for(const o of this.#t){const c=o._getParentKeyOrThrow(),l=Ps(o._toOps(this._id,c,s),void 0),d=l[0].opId;d!==void 0&&this.#n.set(c,d),r.push(...l)}return r}_insertAndSort(t){this.#t.push(t),this._sortItems()}_sortItems(){this.#t.sort(Bp),this.invalidate()}_indexOfPosition(t){return this.#t.findIndex(n=>n._getParentKeyOrThrow()===t)}_attach(t,n){super._attach(t,n);for(const s of this.#t)s._attach(n.generateId(),n)}_detach(){super._detach();for(const t of this.#t)t._detach()}#s(t){if(this._pool===void 0)throw new Error("Can't attach child if managed pool is not present");const{id:n,parentKey:s}=t,r=Bn(t);r._attach(n,this._pool),r._setParentLink(this,s);const i=t.deletedId,o=this._indexOfPosition(s);if(o!==-1){const c=this.#t[o];if(c._id===i)return c._detach(),this.#t[o]=r,{modified:Z(this,[an(o,r)]),reverse:[]};{this.#e.add(c),this.#t[o]=r;const l=[an(o,r)],d=this.#r(t.deletedId);return d&&l.push(d),{modified:Z(this,l),reverse:[]}}}else{const c=[],l=this.#r(t.deletedId);return l&&c.push(l),this._insertAndSort(r),c.push(Kt(this._indexOfPosition(s),r)),{reverse:[],modified:Z(this,c)}}}#i(t){if(this._pool===void 0)throw new Error("Can't attach child if managed pool is not present");const n=[],s=this.#r(t.deletedId);s&&n.push(s);const r=this.#n.get(t.parentKey);if(r!==void 0){if(r!==t.opId)return n.length===0?{modified:!1}:{modified:Z(this,n),reverse:[]};this.#n.delete(t.parentKey)}const i=this._indexOfPosition(t.parentKey),o=this.#t.find(c=>c._id===t.id);if(o!==void 0){if(o._parentKey===t.parentKey)return{modified:n.length>0?Z(this,n):!1,reverse:[]};if(i!==-1){this.#e.add(this.#t[i]);const[d]=this.#t.splice(i,1);n.push(Ls(i,d))}const c=this.#t.indexOf(o);o._setParentLink(this,t.parentKey),this._sortItems();const l=this.#t.indexOf(o);return l!==c&&n.push($e(c,l,o)),{modified:n.length>0?Z(this,n):!1,reverse:[]}}else{const c=this._pool.getNode(t.id);if(c&&this.#e.has(c)){c._setParentLink(this,t.parentKey),this.#e.delete(c),this._insertAndSort(c);const l=this.#t.indexOf(c);return{modified:Z(this,[i===-1?Kt(l,c):an(l,c),...n]),reverse:[]}}else{i!==-1&&this.#t.splice(i,1);const{newItem:l,newIndex:d}=this.#d(t,t.parentKey);return{modified:Z(this,[i===-1?Kt(d,l):an(d,l),...n]),reverse:[]}}}}#r(t){if(t===void 0||this._pool===void 0)return null;const n=this._pool.getNode(t);if(n===void 0)return null;const s=this._detachChild(n);return s.modified===!1?null:s.modified.updates[0]}#o(t){if(this._pool===void 0)throw new Error("Can't attach child if managed pool is not present");const n=as(t.parentKey),s=this._indexOfPosition(n);s!==-1&&this.#a(s,n);const{newItem:r,newIndex:i}=this.#d(t,n);return{modified:Z(this,[Kt(i,r)]),reverse:[]}}#c(t){const n=this.#t.find(i=>i._id===t.id),s=as(t.parentKey),r=this._indexOfPosition(s);if(n){if(n._parentKey===s)return{modified:!1};{const i=this.#t.indexOf(n);r!==-1&&this.#a(r,s),n._setParentLink(this,s),this._sortItems();const o=this._indexOfPosition(s);return o===i?{modified:!1}:{modified:Z(this,[$e(i,o,n)]),reverse:[]}}}else{const i=M(this._pool).getNode(t.id);if(i&&this.#e.has(i)){i._setParentLink(this,s),this.#e.delete(i),this._insertAndSort(i);const o=this._indexOfPosition(s);return{modified:Z(this,[Kt(o,i)]),reverse:[]}}else{r!==-1&&this.#a(r,s);const{newItem:o,newIndex:c}=this.#d(t,s);return{modified:Z(this,[Kt(c,o)]),reverse:[]}}}}#l(t){const{id:n,parentKey:s}=t,r=Bn(t);if(this._pool?.getNode(n)!==void 0)return{modified:!1};r._attach(n,M(this._pool)),r._setParentLink(this,s);const i=this._indexOfPosition(s);let o=s;if(i!==-1){const l=this.#t[i]?._parentPos,d=this.#t[i+1]?._parentPos;o=ne(l,d),r._setParentLink(this,o)}this._insertAndSort(r);const c=this._indexOfPosition(o);return{modified:Z(this,[Kt(c,r)]),reverse:[{type:5,id:n}]}}#u(t){const{id:n,parentKey:s}=t,r=Bn(t);if(this._pool?.getNode(n)!==void 0)return{modified:!1};this.#n.set(s,M(t.opId));const i=this._indexOfPosition(s);r._attach(n,M(this._pool)),r._setParentLink(this,s);const o=s;if(i!==-1){const c=this.#t[i];c._detach(),this.#t[i]=r;const l=Ps(c._toOps(M(this._id),s,this._pool),t.id),d=[an(i,r)],a=this.#r(t.deletedId);return a&&d.push(a),{modified:Z(this,d),reverse:l}}else{this._insertAndSort(r),this.#r(t.deletedId);const c=this._indexOfPosition(o);return{reverse:[{type:5,id:n}],modified:Z(this,[Kt(c,r)])}}}_attachChild(t,n){if(this._pool===void 0)throw new Error("Can't attach child if managed pool is not present");let s;return t.intent==="set"?n===1?s=this.#s(t):n===2?s=this.#i(t):s=this.#u(t):n===1?s=this.#o(t):n===2?s=this.#c(t):s=this.#l(t),s.modified!==!1&&this.invalidate(),s}_detachChild(t){if(t){const n=M(t._parentKey),s=t._toOps(M(this._id),n,this._pool),r=this.#t.indexOf(t);if(r===-1)return{modified:!1};const[i]=this.#t.splice(r,1);return this.invalidate(),t._detach(),{modified:Z(this,[Ls(r,i)]),reverse:s}}return{modified:!1}}#h(t,n){if(this.#e.has(n)){this.#e.delete(n),n._setParentLink(this,t),this._insertAndSort(n);const i=this.#t.indexOf(n);return{modified:Z(this,[Kt(i,n)]),reverse:[]}}const s=n._parentKey;if(t===s)return{modified:!1};const r=this._indexOfPosition(t);if(r===-1){const i=this.#t.indexOf(n);n._setParentLink(this,t),this._sortItems();const o=this.#t.indexOf(n);return o===i?{modified:!1}:{modified:Z(this,[$e(i,o,n)]),reverse:[]}}else{this.#t[r]._setParentLink(this,ne(t,this.#t[r+1]?._parentPos));const i=this.#t.indexOf(n);n._setParentLink(this,t),this._sortItems();const o=this.#t.indexOf(n);return o===i?{modified:!1}:{modified:Z(this,[$e(i,o,n)]),reverse:[]}}}#p(t,n){const s=M(n._parentKey);if(this.#e.has(n)){const r=this._indexOfPosition(t);return this.#e.delete(n),r!==-1&&this.#t[r]._setParentLink(this,ne(t,this.#t[r+1]?._parentPos)),n._setParentLink(this,t),this._insertAndSort(n),{modified:!1}}else{if(t===s)return{modified:!1};const r=this.#t.indexOf(n),i=this._indexOfPosition(t);i!==-1&&this.#t[i]._setParentLink(this,ne(t,this.#t[i+1]?._parentPos)),n._setParentLink(this,t),this._sortItems();const o=this.#t.indexOf(n);return r===o?{modified:!1}:{modified:Z(this,[$e(r,o,n)]),reverse:[]}}}#f(t,n){const s=M(n._parentKey),r=this.#t.indexOf(n),i=this._indexOfPosition(t);let o=t;i!==-1&&(o=ne(t,this.#t[i+1]?._parentPos)),n._setParentLink(this,o),this._sortItems();const c=this.#t.indexOf(n);return r===c?{modified:!1}:{modified:Z(this,[$e(r,c,n)]),reverse:[{type:1,id:M(n._id),parentKey:s}]}}_setChildKey(t,n,s){return s===1?this.#h(t,n):s===2?this.#p(t,n):this.#f(t,n)}_apply(t,n){return super._apply(t,n)}_serialize(){if(this.parent.type!=="HasParent")throw new Error("Cannot serialize LiveList if parent is missing");return{type:1,parentId:M(this.parent.node._id,"Parent node expected to have ID"),parentKey:this.parent.key}}get length(){return this.#t.length}push(t){return this._pool?.assertStorageIsWritable(),this.insert(t,this.length)}insert(t,n){if(this._pool?.assertStorageIsWritable(),n<0||n>this.#t.length)throw new Error(`Cannot insert list item at index "${n}". index should be between 0 and ${this.#t.length}`);const s=this.#t[n-1]?this.#t[n-1]._parentPos:void 0,r=this.#t[n]?this.#t[n]._parentPos:void 0,i=ne(s,r),o=bn(t);if(o._setParentLink(this,i),this._insertAndSort(o),this._pool&&this._id){const c=this._pool.generateId();o._attach(c,this._pool),this._pool.dispatch(o._toOps(this._id,i,this._pool),[{type:5,id:c}],new Map([[this._id,Z(this,[Kt(n,o)])]]))}}move(t,n){if(this._pool?.assertStorageIsWritable(),n<0)throw new Error("targetIndex cannot be less than 0");if(n>=this.#t.length)throw new Error("targetIndex cannot be greater or equal than the list length");if(t<0)throw new Error("index cannot be less than 0");if(t>=this.#t.length)throw new Error("index cannot be greater or equal than the list length");let s=null,r=null;t<n?(r=n===this.#t.length-1?void 0:this.#t[n+1]._parentPos,s=this.#t[n]._parentPos):(r=this.#t[n]._parentPos,s=n===0?void 0:this.#t[n-1]._parentPos);const i=ne(s,r),o=this.#t[t],c=o._getParentKeyOrThrow();if(o._setParentLink(this,i),this._sortItems(),this._pool&&this._id){const l=new Map([[this._id,Z(this,[$e(t,n,o)])]]);this._pool.dispatch([{type:1,id:M(o._id),opId:this._pool.generateOpId(),parentKey:i}],[{type:1,id:M(o._id),parentKey:c}],l)}}delete(t){if(this._pool?.assertStorageIsWritable(),t<0||t>=this.#t.length)throw new Error(`Cannot delete list item at index "${t}". index should be between 0 and ${this.#t.length-1}`);const n=this.#t[t];n._detach();const[s]=this.#t.splice(t,1);if(this.invalidate(),this._pool){const r=n._id;if(r){const i=new Map;i.set(M(this._id),Z(this,[Ls(t,s)])),this._pool.dispatch([{id:r,opId:this._pool.generateOpId(),type:5}],n._toOps(M(this._id),n._getParentKeyOrThrow()),i)}}}clear(){if(this._pool?.assertStorageIsWritable(),this._pool){const t=[],n=[],s=[];for(const i of this.#t){i._detach();const o=i._id;o&&(t.push({type:5,id:o,opId:this._pool.generateOpId()}),n.push(...i._toOps(M(this._id),i._getParentKeyOrThrow())),s.push(Ls(0,i)))}this.#t=[],this.invalidate();const r=new Map;r.set(M(this._id),Z(this,s)),this._pool.dispatch(t,n,r)}else{for(const t of this.#t)t._detach();this.#t=[],this.invalidate()}}set(t,n){if(this._pool?.assertStorageIsWritable(),t<0||t>=this.#t.length)throw new Error(`Cannot set list item at index "${t}". index should be between 0 and ${this.#t.length-1}`);const s=this.#t[t],r=s._getParentKeyOrThrow(),i=s._id;s._detach();const o=bn(n);if(o._setParentLink(this,r),this.#t[t]=o,this.invalidate(),this._pool&&this._id){const c=this._pool.generateId();o._attach(c,this._pool);const l=new Map;l.set(this._id,Z(this,[an(t,o)]));const d=Ps(o._toOps(this._id,r,this._pool),i);this.#n.set(r,M(d[0].opId));const a=Ps(s._toOps(this._id,r,void 0),c);this._pool.dispatch(d,a,l)}}toArray(){return this.#t.map(t=>re(t))}every(t){return this.toArray().every(t)}filter(t){return this.toArray().filter(t)}find(t){return this.toArray().find(t)}findIndex(t){return this.toArray().findIndex(t)}forEach(t){return this.toArray().forEach(t)}get(t){if(!(t<0||t>=this.#t.length))return re(this.#t[t])}indexOf(t,n){return this.toArray().indexOf(t,n)}lastIndexOf(t,n){return this.toArray().lastIndexOf(t,n)}map(t){return this.#t.map((n,s)=>t(re(n),s))}some(t){return this.toArray().some(t)}[Symbol.iterator](){return new Fp(this.#t)}#d(t,n){const s=Bn(t);s._attach(t.id,M(this._pool)),s._setParentLink(this,n),this._insertAndSort(s);const r=this._indexOfPosition(n);return{newItem:s,newIndex:r}}#a(t,n){const s=ne(n,this.#t.length>t+1?this.#t[t+1]?._parentPos:void 0);this.#t[t]._setParentLink(this,s)}_toTreeNode(t){return{type:"LiveList",id:this._id??xe(),key:t,payload:this.#t.map((n,s)=>n.toTreeNode(s.toString()))}}toImmutable(){return super.toImmutable()}_toImmutable(){return this.#t.map(n=>n.toImmutable())}clone(){return new ui(this.#t.map(t=>t.clone()))}},Fp=class{#t;constructor(e){this.#t=e[Symbol.iterator]()}[Symbol.iterator](){return this}next(){const e=this.#t.next();return e.done?{done:!0,value:void 0}:{value:re(e.value)}}};function Z(e,t){return{node:e,type:"LiveList",updates:t}}function an(e,t){return{index:e,type:"set",item:t instanceof Re?t.data:t}}function Ls(e,t){return{type:"delete",index:e,deletedItem:t instanceof Re?t.data:t}}function Kt(e,t){return{index:e,type:"insert",item:t instanceof Re?t.data:t}}function $e(e,t,n){return{type:"move",index:t,item:n instanceof Re?n.data:n,previousIndex:e}}function Ps(e,t){return e.map((n,s)=>s===0?{...n,intent:"set",deletedId:t}:n)}var Rn=class hi extends fr{#t;#e;constructor(t){if(super(),this.#e=new Map,t){const n=[];for(const[s,r]of t){const i=bn(r);i._setParentLink(this,s),n.push([s,i])}this.#t=new Map(n)}else this.#t=new Map}_toOps(t,n,s){if(this._id===void 0)throw new Error("Cannot serialize item is not attached");const r=[],i={id:this._id,opId:s?.generateOpId(),type:7,parentId:t,parentKey:n};r.push(i);for(const[o,c]of this.#t)r.push(...c._toOps(this._id,o,s));return r}static _deserialize([t,n],s,r){const i=new hi;i._attach(t,r);const o=s.get(t);if(o===void 0)return i;for(const[c,l]of o){const d=Ka([c,l],s,r);d._setParentLink(i,l.parentKey),i.#t.set(l.parentKey,d),i.invalidate()}return i}_attach(t,n){super._attach(t,n);for(const[s,r]of this.#t)nt(r)&&r._attach(n.generateId(),n)}_attachChild(t,n){if(this._pool===void 0)throw new Error("Can't attach child if managed pool is not present");const{id:s,parentKey:r,opId:i}=t,o=r,c=Bn(t);if(this._pool.getNode(s)!==void 0)return{modified:!1};if(n===2){const a=this.#e.get(o);if(a===i)return this.#e.delete(o),{modified:!1};if(a!==void 0)return{modified:!1}}else n===1&&this.#e.delete(o);const l=this.#t.get(o);let d;if(l){const a=M(this._id);d=l._toOps(a,o),l._detach()}else d=[{type:5,id:s}];return c._setParentLink(this,o),c._attach(s,this._pool),this.#t.set(o,c),this.invalidate(),{modified:{node:this,type:"LiveMap",updates:{[o]:{type:"update"}}},reverse:d}}_detach(){super._detach();for(const t of this.#t.values())t._detach()}_detachChild(t){const n=M(this._id),s=M(t._parentKey),r=t._toOps(n,s,this._pool);for(const[o,c]of this.#t)c===t&&(this.#t.delete(o),this.invalidate());return t._detach(),{modified:{node:this,type:"LiveMap",updates:{[s]:{type:"delete",deletedItem:re(t)}}},reverse:r}}_serialize(){if(this.parent.type!=="HasParent")throw new Error("Cannot serialize LiveMap if parent is missing");return{type:2,parentId:M(this.parent.node._id,"Parent node expected to have ID"),parentKey:this.parent.key}}get(t){const n=this.#t.get(t);if(n!==void 0)return re(n)}set(t,n){this._pool?.assertStorageIsWritable();const s=this.#t.get(t);s&&s._detach();const r=bn(n);if(r._setParentLink(this,t),this.#t.set(t,r),this.invalidate(),this._pool&&this._id){const i=this._pool.generateId();r._attach(i,this._pool);const o=new Map;o.set(this._id,{node:this,type:"LiveMap",updates:{[t]:{type:"update"}}});const c=r._toOps(this._id,t,this._pool);this.#e.set(t,M(c[0].opId)),this._pool.dispatch(r._toOps(this._id,t,this._pool),s?s._toOps(this._id,t):[{type:5,id:i}],o)}}get size(){return this.#t.size}has(t){return this.#t.has(t)}delete(t){this._pool?.assertStorageIsWritable();const n=this.#t.get(t);if(n===void 0)return!1;if(n._detach(),this.#t.delete(t),this.invalidate(),this._pool&&n._id){const s=M(this._id),r=new Map;r.set(s,{node:this,type:"LiveMap",updates:{[t]:{type:"delete",deletedItem:re(n)}}}),this._pool.dispatch([{type:5,id:n._id,opId:this._pool.generateOpId()}],n._toOps(s,t),r)}return!0}entries(){const t=this.#t.entries();return{[Symbol.iterator](){return this},next(){const n=t.next();if(n.done)return{done:!0,value:void 0};const r=n.value[0],i=re(n.value[1]);return{value:[r,i]}}}}[Symbol.iterator](){return this.entries()}keys(){return this.#t.keys()}values(){const t=this.#t.values();return{[Symbol.iterator](){return this},next(){const n=t.next();return n.done?{done:!0,value:void 0}:{value:re(n.value)}}}}forEach(t){for(const n of this)t(n[1],n[0],this)}_toTreeNode(t){return{type:"LiveMap",id:this._id??xe(),key:t,payload:Array.from(this.#t.entries()).map(([n,s])=>s.toTreeNode(n))}}toImmutable(){return super.toImmutable()}_toImmutable(){const t=new Map;for(const[n,s]of this.#t)t.set(n,s.toImmutable());return Te(t)}clone(){return new hi(Array.from(this.#t).map(([t,n])=>[t,n.clone()]))}},Mr=128*1024,tn=class un extends fr{#t;#e;static detectLargeObjects=!1;static#n(t){const n=new Map;let s=null;for(const[r,i]of t)if($p(i))s=[r,i];else{const o=[r,i],c=n.get(i.parentId);c!==void 0?c.push(o):n.set(i.parentId,[o])}if(s===null)throw new Error("Root can't be null");return[s,n]}static _fromItems(t,n){const[s,r]=un.#n(t);return un._deserialize(s,r,n)}constructor(t={}){super(),this.#e=new Map;const n=ur(t);for(const s of Object.keys(n)){const r=n[s];nt(r)&&r._setParentLink(this,s)}this.#t=new Map(Object.entries(n))}_toOps(t,n,s){if(this._id===void 0)throw new Error("Cannot serialize item is not attached");const r=s?.generateOpId(),i=[],o={type:4,id:this._id,opId:r,parentId:t,parentKey:n,data:{}};i.push(o);for(const[c,l]of this.#t)nt(l)?i.push(...l._toOps(this._id,c,s)):o.data[c]=l;return i}static _deserialize([t,n],s,r){const i=new un(n.data);return i._attach(t,r),this._deserializeChildren(i,s,r)}static _deserializeChildren(t,n,s){const r=n.get(M(t._id));if(r===void 0)return t;for(const[i,o]of r){const c=jp([i,o],n,s);pn(c)&&c._setParentLink(t,o.parentKey),t.#t.set(o.parentKey,c),t.invalidate()}return t}_attach(t,n){super._attach(t,n);for(const[s,r]of this.#t)nt(r)&&r._attach(n.generateId(),n)}_attachChild(t,n){if(this._pool===void 0)throw new Error("Can't attach child if managed pool is not present");const{id:s,opId:r,parentKey:i}=t,o=ja(t);if(this._pool.getNode(s)!==void 0)return this.#e.get(i)===r&&this.#e.delete(i),{modified:!1};if(n===0)this.#e.set(i,M(r));else if(this.#e.get(i)!==void 0)return this.#e.get(i)===r?(this.#e.delete(i),{modified:!1}):{modified:!1};const c=M(this._id),l=this.#t.get(i);let d;return nt(l)?(d=l._toOps(c,i),l._detach()):l===void 0?d=[{type:6,id:c,key:i}]:d=[{type:3,id:c,data:{[i]:l}}],this.#t.set(i,o),this.invalidate(),pn(o)&&(o._setParentLink(this,i),o._attach(s,this._pool)),{reverse:d,modified:{node:this,type:"LiveObject",updates:{[i]:{type:"update"}}}}}_detachChild(t){if(t){const n=M(this._id),s=M(t._parentKey),r=t._toOps(n,s,this._pool);for(const[o,c]of this.#t)c===t&&(this.#t.delete(o),this.invalidate());return t._detach(),{modified:{node:this,type:"LiveObject",updates:{[s]:{type:"delete"}}},reverse:r}}return{modified:!1}}_detach(){super._detach();for(const t of this.#t.values())nt(t)&&t._detach()}_apply(t,n){return t.type===3?this.#s(t,n):t.type===6?this.#i(t,n):super._apply(t,n)}_serialize(){const t={};for(const[n,s]of this.#t)nt(s)||(t[n]=s);return this.parent.type==="HasParent"&&this.parent.node._id?{type:0,parentId:this.parent.node._id,parentKey:this.parent.key,data:t}:{type:0,data:t}}#s(t,n){let s=!1;const r=M(this._id),i=[],o={type:3,id:r,data:{}};for(const l in t.data){const d=this.#t.get(l);nt(d)?(i.push(...d._toOps(r,l)),d._detach()):d!==void 0?o.data[l]=d:d===void 0&&i.push({type:6,id:r,key:l})}const c={};for(const l in t.data){const d=t.data[l];if(d===void 0)continue;if(n)this.#e.set(l,M(t.opId));else if(this.#e.get(l)===void 0)s=!0;else if(this.#e.get(l)===t.opId){this.#e.delete(l);continue}else continue;const a=this.#t.get(l);nt(a)&&a._detach(),s=!0,c[l]={type:"update"},this.#t.set(l,d),this.invalidate()}return Object.keys(o.data).length!==0&&i.unshift(o),s?{modified:{node:this,type:"LiveObject",updates:c},reverse:i}:{modified:!1}}#i(t,n){const s=t.key,r=this.#t.get(s);if(r===void 0)return{modified:!1};if(!n&&this.#e.get(s)!==void 0)return{modified:!1};const i=M(this._id);let o=[];return nt(r)?(o=r._toOps(i,t.key),r._detach()):r!==void 0&&(o=[{type:3,id:i,data:{[s]:r}}]),this.#t.delete(s),this.invalidate(),{modified:{node:this,type:"LiveObject",updates:{[t.key]:{type:"delete",deletedItem:r}}},reverse:o}}toObject(){return Object.fromEntries(this.#t)}set(t,n){this._pool?.assertStorageIsWritable(),this.update({[t]:n})}get(t){return this.#t.get(t)}delete(t){this._pool?.assertStorageIsWritable();const n=t,s=this.#t.get(n);if(s===void 0)return;if(this._pool===void 0||this._id===void 0){nt(s)&&s._detach(),this.#t.delete(n),this.invalidate();return}let r;nt(s)?(s._detach(),r=s._toOps(this._id,n)):r=[{type:3,data:{[n]:s},id:this._id}],this.#t.delete(n),this.invalidate();const i=new Map;i.set(this._id,{node:this,type:"LiveObject",updates:{[t]:{type:"delete",deletedItem:s}}}),this._pool.dispatch([{type:6,key:n,id:this._id,opId:this._pool.generateOpId()}],r,i)}update(t){if(this._pool?.assertStorageIsWritable(),un.detectLargeObjects){const d={};for(const[f,g]of this.#t)nt(g)||(d[f]=g);for(const f of Object.keys(t)){const g=t[f];g!==void 0&&(nt(g)||(d[f]=g))}const a=JSON.stringify(d);if(a.length*4>Mr){const f=new TextEncoder().encode(a).length;if(f>Mr)throw new Error(`LiveObject size exceeded limit: ${f} bytes > ${Mr} bytes. See https://liveblocks.io/docs/platform/limits#Liveblocks-Storage-limits`)}}if(this._pool===void 0||this._id===void 0){for(const d in t){const a=t[d];if(a===void 0)continue;const u=this.#t.get(d);nt(u)&&u._detach(),nt(a)&&a._setParentLink(this,d),this.#t.set(d,a),this.invalidate()}return}const n=[],s=[],r=this._pool.generateOpId(),i={},o={id:this._id,type:3,data:{}},c={};for(const d in t){const a=t[d];if(a===void 0)continue;const u=this.#t.get(d);if(nt(u)?(s.push(...u._toOps(this._id,d)),u._detach()):u===void 0?s.push({type:6,id:this._id,key:d}):o.data[d]=u,nt(a)){a._setParentLink(this,d),a._attach(this._pool.generateId(),this._pool);const f=a._toOps(this._id,d,this._pool),g=f.find(m=>m.parentId===this._id);g&&this.#e.set(d,M(g.opId)),n.push(...f)}else i[d]=a,this.#e.set(d,r);this.#t.set(d,a),this.invalidate(),c[d]={type:"update"}}Object.keys(o.data).length!==0&&s.unshift(o),Object.keys(i).length!==0&&n.unshift({opId:r,id:this._id,type:3,data:i});const l=new Map;l.set(this._id,{node:this,type:"LiveObject",updates:c}),this._pool.dispatch(n,s,l)}toImmutable(){return super.toImmutable()}toTreeNode(t){return super.toTreeNode(t)}_toTreeNode(t){const n=this._id??xe();return{type:"LiveObject",id:n,key:t,payload:Array.from(this.#t.entries()).map(([s,r])=>nt(r)?r.toTreeNode(s):{type:"Json",id:`${n}:${s}`,key:s,payload:r})}}_toImmutable(){const t={};for(const[n,s]of this.#t)t[n]=pn(s)?s.toImmutable():s;return t}clone(){return new un(Object.fromEntries(Array.from(this.#t).map(([t,n])=>[t,pn(n)?n.clone():cs(n)])))}};function Bn(e){return bn(ja(e))}function ja(e){switch(e.type){case 8:return e.data;case 4:return new tn(e.data);case 7:return new Rn;case 2:return new Dn([]);default:return gt(e,"Unknown creation Op")}}function Ha(e,t){return e===t?!0:e.parent.type==="HasParent"?Ha(e.parent.node,t):!1}function Ka([e,t],n,s){switch(t.type){case 0:return tn._deserialize([e,t],n,s);case 1:return Dn._deserialize([e,t],n,s);case 2:return Rn._deserialize([e,t],n,s);case 3:return Re._deserialize([e,t],n,s);default:throw new Error("Unexpected CRDT type")}}function jp([e,t],n,s){switch(t.type){case 0:return tn._deserialize([e,t],n,s);case 1:return Dn._deserialize([e,t],n,s);case 2:return Rn._deserialize([e,t],n,s);case 3:return t.data;default:throw new Error("Unexpected CRDT type")}}function pn(e){return za(e)||Hp(e)||Kp(e)}function nt(e){return pn(e)||zp(e)}function za(e){return e instanceof Dn}function Hp(e){return e instanceof Rn}function Kp(e){return e instanceof tn}function zp(e){return e instanceof Re}function Wp(e){return e===void 0?void 0:pn(e)?e.clone():cs(e)}function re(e){return e instanceof Re?e.data:e instanceof Dn||e instanceof Rn||e instanceof tn?e:gt(e,"Unknown AbstractCrdt")}function bn(e){return e instanceof tn||e instanceof Rn||e instanceof Dn?e:new Re(e)}function qp(e,t){const n=[];return e.forEach((s,r)=>{t.get(r)||n.push({type:5,id:r})}),t.forEach((s,r)=>{const i=e.get(r);if(i)s.type===0&&(i.type!==0||le(s.data)!==le(i.data))&&n.push({type:3,id:r,data:s.data}),s.parentKey!==i.parentKey&&n.push({type:1,id:r,parentKey:M(s.parentKey,"Parent key must not be missing")});else switch(s.type){case 3:n.push({type:8,id:r,parentId:s.parentId,parentKey:s.parentKey,data:s.data});break;case 1:n.push({type:2,id:r,parentId:s.parentId,parentKey:s.parentKey});break;case 0:if(s.parentId===void 0||s.parentKey===void 0)throw new Error("Internal error. Cannot serialize storage root into an operation");n.push({type:4,id:r,parentId:s.parentId,parentKey:s.parentKey,data:s.data});break;case 2:n.push({type:7,id:r,parentId:s.parentId,parentKey:s.parentKey});break}}),n}function Gp(e,t){const n=e.updates;for(const[s,r]of Ta(t.updates))n[s]=r;return{...t,updates:n}}function Yp(e,t){const n=e.updates;for(const[s,r]of Ta(t.updates))n[s]=r;return{...t,updates:n}}function Jp(e,t){const n=e.updates;return{...t,updates:n.concat(t.updates)}}function $r(e,t){return e===void 0?t:e.type==="LiveObject"&&t.type==="LiveObject"?Gp(e,t):e.type==="LiveMap"&&t.type==="LiveMap"?Yp(e,t):e.type==="LiveList"&&t.type==="LiveList"?Jp(e,t):t}var Vr=class{#t;#e;#n;#s;constructor(){this.#t={},this.#e=0,this.#n=1,this.#s=0}get length(){return this.#s}*[Symbol.iterator](){const e=this.#s,t=this.#e;for(let n=0;n<e;n++)yield this.#t[t+n]}push(e){const t=Array.isArray(e)?e:[e];this.#n>Number.MAX_SAFE_INTEGER-t.length-1&&Bt("Deque full");for(const n of t)this.#t[this.#n++-1]=n;this.#s+=t.length}pop(){if(this.#s<1)return;this.#n--;const e=this.#t[this.#n-1];return delete this.#t[this.#n-1],this.#s--,e}pushLeft(e){const t=Array.isArray(e)?e:[e];this.#e<Number.MIN_SAFE_INTEGER+t.length&&Bt("Deque full");for(let n=t.length-1;n>=0;n--)this.#t[--this.#e]=t[n];this.#s+=t.length}popLeft(){if(this.#s<1)return;const e=this.#t[this.#e];return delete this.#t[this.#e],this.#e++,this.#s--,e}};function Xp(e){return e===null||typeof e=="string"||typeof e=="number"||typeof e=="boolean"}function Wa(e){return Array.isArray(e)}function Zp(e){return!Xp(e)&&!Wa(e)}var qa=(e=>(e[e.UPDATE_PRESENCE=100]="UPDATE_PRESENCE",e[e.BROADCAST_EVENT=103]="BROADCAST_EVENT",e[e.FETCH_STORAGE=200]="FETCH_STORAGE",e[e.UPDATE_STORAGE=201]="UPDATE_STORAGE",e[e.FETCH_YDOC=300]="FETCH_YDOC",e[e.UPDATE_YDOC=301]="UPDATE_YDOC",e))(qa||{});function Qp(e,t){const{connectionId:n,id:s,info:r}=e,i=ai(e.scopes);return Te(ur({connectionId:n,id:s,info:r,canWrite:i,canComment:Ba(e.scopes),isReadOnly:!i,presence:t}))}var tg=class{#t;#e;signal;constructor(){this.#t=new Tn({connections:new Map,presences:new Map}),this.signal=ae.from(this.#t,e=>si(Array.from(this.#t.get().presences.keys()).map(t=>this.getUser(Number(t))))),this.#e=new Map}get(){return this.signal.get()}connectionIds(){return this.#t.get().connections.keys()}clearOthers(){this.#t.mutate(e=>{e.connections.clear(),e.presences.clear(),this.#e.clear()})}#n(e){const t=this.#t.get(),n=t.connections.get(e),s=t.presences.get(e);if(n!==void 0&&s!==void 0)return Qp(n,s)}getUser(e){const t=this.#e.get(e);if(t)return t;const n=this.#n(e);if(n)return this.#e.set(e,n),n}#s(e){this.#e.delete(e)}setConnection(e,t,n,s){this.#t.mutate(r=>(r.connections.set(e,Te({connectionId:e,id:t,info:n,scopes:s})),r.presences.has(e)?this.#s(e):!1))}removeConnection(e){this.#t.mutate(t=>{t.connections.delete(e),t.presences.delete(e),this.#s(e)})}setOther(e,t){this.#t.mutate(n=>(n.presences.set(e,Te(ur(t))),n.connections.has(e)?this.#s(e):!1))}patchOther(e,t){this.#t.mutate(n=>{const s=n.presences.get(e);if(s===void 0)return!1;const r=Ca(s,t);return s===r?!1:(n.presences.set(e,Te(r)),this.#s(e))})}},fi=class Ga extends Error{context;constructor(t,n,s){super(t,{cause:s}),this.context=n,this.name="LiveblocksError"}get roomId(){return this.context.roomId}get code(){return this.context.code}static from(t,n){return new Ga(eg(t),t,n)}};function eg(e){switch(e.type){case"ROOM_CONNECTION_ERROR":switch(e.code){case 4001:return"Not allowed to connect to the room";case 4005:return"Room is already full";case 4006:return"Kicked out of the room, because the room ID changed";default:return"Could not connect to the room"}case"AI_CONNECTION_ERROR":switch(e.code){case 4001:return"Not allowed to connect to ai";default:return"Could not connect to the room"}case"CREATE_THREAD_ERROR":return"Could not create new thread";case"DELETE_THREAD_ERROR":return"Could not delete thread";case"EDIT_THREAD_METADATA_ERROR":return"Could not edit thread metadata";case"MARK_THREAD_AS_RESOLVED_ERROR":return"Could not mark thread as resolved";case"MARK_THREAD_AS_UNRESOLVED_ERROR":return"Could not mark thread as unresolved";case"SUBSCRIBE_TO_THREAD_ERROR":return"Could not subscribe to thread";case"UNSUBSCRIBE_FROM_THREAD_ERROR":return"Could not unsubscribe from thread";case"CREATE_COMMENT_ERROR":return"Could not create new comment";case"EDIT_COMMENT_ERROR":return"Could not edit comment";case"DELETE_COMMENT_ERROR":return"Could not delete comment";case"ADD_REACTION_ERROR":return"Could not add reaction";case"REMOVE_REACTION_ERROR":return"Could not remove reaction";case"MARK_INBOX_NOTIFICATION_AS_READ_ERROR":return"Could not mark inbox notification as read";case"DELETE_INBOX_NOTIFICATION_ERROR":return"Could not delete inbox notification";case"MARK_ALL_INBOX_NOTIFICATIONS_AS_READ_ERROR":return"Could not mark all inbox notifications as read";case"DELETE_ALL_INBOX_NOTIFICATIONS_ERROR":return"Could not delete all inbox notifications";case"UPDATE_ROOM_SUBSCRIPTION_SETTINGS_ERROR":return"Could not update room subscription settings";case"UPDATE_NOTIFICATION_SETTINGS_ERROR":return"Could not update notification settings";case"LARGE_MESSAGE_ERROR":return"Could not send large message";default:return gt(e,"Unhandled case")}}var sc=1024*1024-512;function ng(e){let t=0;return()=>`${e}:${t++}`}function rc(e,t){return{type:"User",id:`${t.connectionId}`,key:e,payload:{connectionId:t.connectionId,id:t.id,info:t.info,presence:t.presence,isReadOnly:!t.canWrite}}}function sg(){const e=typeof document<"u"?document:void 0,t={current:null};function n(){e?.visibilityState==="hidden"?t.current=t.current??Date.now():t.current=null}return e?.addEventListener("visibilitychange",n),[t,()=>{e?.removeEventListener("visibilitychange",n)}]}function rg(e,t){const n=t.roomId,s=e.initialPresence,r=e.initialStorage,i=t.roomHttpClient,[o,c]=sg(),l={...t.delegates,canZombie(){return t.backgroundKeepAliveTimeout!==void 0&&o.current!==null&&Date.now()>o.current+t.backgroundKeepAliveTimeout&&on()!=="synchronizing"}},d=new Va(l,t.enableDebugLogging),a={buffer:{flushTimerID:void 0,lastFlushedAt:0,presenceUpdates:{type:"full",data:s},messages:[],storageOperations:[]},staticSessionInfoSig:new Dt(null),dynamicSessionInfoSig:new Dt(null),myPresence:new ff(s),others:new tg,initialStorage:r,idFactory:null,yjsProvider:void 0,yjsProviderDidChange:J(),pool:Np(n,{getCurrentConnectionId:Q,onDispatch:I,isStorageWritable:U}),root:void 0,undoStack:[],redoStack:[],pausedHistory:null,activeBatch:null,unacknowledgedOps:new Map};let u;function f(h){const y=d.authValue;if(y!==null){const b=zi(y);if(b!==u)if(u=b,y.type==="secret"){const _=y.token.parsed;a.staticSessionInfoSig.set({userId:_.k==="sec-legacy"?_.id:_.uid,userInfo:_.k==="sec-legacy"?_.info:_.ui})}else a.staticSessionInfoSig.set({userId:void 0,userInfo:void 0})}w.status.notify(h),ht()}let g,m=!1;function v(h){h==="reconnecting"?g=setTimeout(()=>{w.lostConnection.notify("lost"),m=!0,a.others.clearOthers(),V({others:[{type:"reset"}]})},t.lostConnectionTimeout):(clearTimeout(g),m&&(h==="disconnected"?w.lostConnection.notify("failed"):w.lostConnection.notify("restored"),m=!1))}function P(){a.buffer.presenceUpdates={type:"full",data:{...a.myPresence.get()}},C!==null&&Pt({flush:!1}),vt()}function L(){clearTimeout(a.buffer.flushTimerID)}d.events.onMessage.subscribe(Ss),d.events.statusDidChange.subscribe(f),d.events.statusDidChange.subscribe(v),d.events.didConnect.subscribe(P),d.events.didDisconnect.subscribe(L),d.events.onConnectionError.subscribe(({message:h,code:y})=>{const b="ROOM_CONNECTION_ERROR",_=new fi(h,{type:b,code:y,roomId:n});t.errorEventSource.notify(_)});function I(h,y,b){if(a.activeBatch){for(const _ of h)a.activeBatch.ops.push(_);for(const[_,j]of b)a.activeBatch.updates.storageUpdates.set(_,$r(a.activeBatch.updates.storageUpdates.get(_),j));a.activeBatch.reverseOps.pushLeft(y)}else A(y),a.redoStack.length=0,T(h),V({storageUpdates:b})}function U(){const h=a.dynamicSessionInfoSig.get()?.scopes;return h!==void 0?ai(h):!0}const w={status:J(),lostConnection:J(),customEvent:J(),self:J(),myPresence:J(),others:J(),storageBatch:J(),history:J(),storageDidLoad:J(),storageStatus:J(),ydoc:J(),comments:J(),roomWillDestroy:J()};async function E(h,y){return i.createTextMention({roomId:n,mentionId:h,mention:y})}async function R(h){return i.deleteTextMention({roomId:n,mentionId:h})}async function x(h,y){await i.reportTextEditor({roomId:n,type:h,rootKey:y})}async function K(){return i.listTextVersions({roomId:n})}async function z(h){return i.listTextVersionsSince({roomId:n,since:h.since,signal:h.signal})}async function G(h){return i.getTextVersion({roomId:n,versionId:h})}async function ot(){return i.createTextVersion({roomId:n})}async function dt(h){return i.executeContextualPrompt({roomId:n,...h})}function*O(h){const{ops:y,...b}=h;if(y.length<2)throw new Error("Cannot split ops into smaller chunks");const _=Math.floor(y.length/2),j=y.slice(0,_),q=y.slice(_);for(const jt of[j,q]){const wt={ops:jt,...b},Ue=le([wt]);H(Ue)?yield*O(wt):yield Ue}}function*k(h){if(h.length<2)if(h[0].type===201){yield*O(h[0]);return}else throw new Error("Cannot split into chunks smaller than the allowed message size");const y=Math.floor(h.length/2),b=h.slice(0,y),_=h.slice(y);for(const j of[b,_]){const q=le(j);H(q)?yield*k(j):yield q}}function H(h){return h.length*4<sc?!1:new TextEncoder().encode(h).length>=sc}function B(h){const y=t.largeMessageStrategy??"default",b=le(h);if(!H(b))return d.send(b);switch(y){case"default":{const _="LARGE_MESSAGE_ERROR",j=new fi("Message is too large for websockets",{type:_});t.errorEventSource.notify(j)||pe("Message is too large for websockets.  Configure largeMessageStrategy option or useErrorListener to handle this.");return}case"split":{bt("Message is too large for websockets, splitting into smaller chunks");for(const _ of k(h))d.send(_);return}case"experimental-fallback-to-http":{bt("Message is too large for websockets, so sending over HTTP instead");const _=a.dynamicSessionInfoSig.get()?.nonce??Bt("Session is not authorized to send message over HTTP");i.sendMessagesOverHTTP({roomId:n,nonce:_,messages:h}).then(j=>{!j.ok&&j.status===403&&d.reconnect()}).catch(j=>{pe(`Failed to deliver message over HTTP: ${String(j)}`)});return}}}const W=ae.from(a.staticSessionInfoSig,a.dynamicSessionInfoSig,a.myPresence,(h,y,b)=>{if(h===null||y===null)return null;{const _=ai(y.scopes);return{connectionId:y.actor,id:h.userId,info:h.userInfo,presence:b,canWrite:_,canComment:Ba(y.scopes)}}});let ut;function ht(){const h=W.get();h!==null&&h!==ut&&(w.self.notify(h),ut=h)}const Tt=ae.from(W,h=>h!==null?rc("Me",h):null);function nn(h){if(h.items.length===0)throw new Error("Internal error: cannot load storage without items");a.root!==void 0?Pn(h.items):a.root=tn._fromItems(h.items,a.pool);const y=W.get()?.canWrite??!0,b=a.undoStack.length;for(const _ in a.initialStorage)a.root.get(_)===void 0&&(y?a.root.set(_,Wp(a.initialStorage[_])):bt(`Attempted to populate missing storage key '${_}', but current user has no write access`));a.undoStack.length=b}function Pn(h){if(a.root===void 0)return;const y=new Map;for(const[j,q]of a.pool.nodes)y.set(j,q._serialize());const b=qp(y,new Map(h)),_=ct(b,!1);V(_.updates)}function Le(h){a.undoStack.length>=50&&a.undoStack.shift(),a.undoStack.push(h),Un()}function A(h){a.pausedHistory!==null?a.pausedHistory.pushLeft(h):Le(h)}function V(h){const y=h.storageUpdates,b=h.others;if(b!==void 0&&b.length>0){const _=a.others.get();for(const j of b)w.others.notify({...j,others:_})}if((h.presence??!1)&&(ht(),w.myPresence.notify(a.myPresence.get())),y!==void 0&&y.size>0){const _=Array.from(y.values());w.storageBatch.notify(_)}Is()}function Q(){const h=a.dynamicSessionInfoSig.get();if(h)return h.actor;throw new Error("Internal. Tried to get connection id but connection was never open")}function ct(h,y){const b={reverse:new Vr,storageUpdates:new Map,presence:!1},_=new Set,j=h.map(q=>q.type!=="presence"&&!q.opId?{...q,opId:a.pool.generateOpId()}:q);for(const q of j)if(q.type==="presence"){const jt={type:"presence",data:{}};for(const wt in q.data)jt.data[wt]=a.myPresence.get()[wt];if(a.myPresence.patch(q.data),a.buffer.presenceUpdates===null)a.buffer.presenceUpdates={type:"partial",data:q.data};else for(const wt in q.data)a.buffer.presenceUpdates.data[wt]=q.data[wt];b.reverse.pushLeft(jt),b.presence=!0}else{let jt;if(y)jt=0;else{const Ue=M(q.opId);jt=a.unacknowledgedOps.delete(Ue)?2:1}const wt=Ft(q,jt);if(wt.modified){const Ue=wt.modified.node._id;Ue&&_.has(Ue)||(b.storageUpdates.set(M(wt.modified.node._id),$r(b.storageUpdates.get(M(wt.modified.node._id)),wt.modified)),b.reverse.pushLeft(wt.reverse)),(q.type===2||q.type===7||q.type===4)&&_.add(M(q.id))}}return{ops:j,reverse:Array.from(b.reverse),updates:{storageUpdates:b.storageUpdates,presence:b.presence}}}function Ft(h,y){if(Up(h))return{modified:!1};switch(h.type){case 6:case 3:case 5:{const b=a.pool.nodes.get(h.id);return b===void 0?{modified:!1}:b._apply(h,y===0)}case 1:{const b=a.pool.nodes.get(h.id);return b===void 0?{modified:!1}:b.parent.type==="HasParent"&&za(b.parent.node)?b.parent.node._setChildKey(as(h.parentKey),b,y):{modified:!1}}case 4:case 2:case 7:case 8:{if(h.parentId===void 0)return{modified:!1};const b=a.pool.nodes.get(h.parentId);return b===void 0?{modified:!1}:b._attachChild(h,y)}}}function Zt(h,y){const b={};a.buffer.presenceUpdates===null&&(a.buffer.presenceUpdates={type:"partial",data:{}});for(const _ in h){const j=h[_];j!==void 0&&(a.buffer.presenceUpdates.data[_]=j,b[_]=a.myPresence.get()[_])}a.myPresence.patch(h),a.activeBatch?(y?.addToHistory&&a.activeBatch.reverseOps.pushLeft({type:"presence",data:b}),a.activeBatch.updates.presence=!0):(vt(),y?.addToHistory&&A([{type:"presence",data:b}]),V({presence:!0}))}function Pe(h){if(h.targetActor!==void 0){const b=a.others.getUser(h.actor);a.others.setOther(h.actor,h.data);const _=a.others.getUser(h.actor);if(b===void 0&&_!==void 0)return{type:"enter",user:_}}else a.others.patchOther(h.actor,h.data);const y=a.others.getUser(h.actor);if(y)return{type:"update",updates:h.data,user:y}}function sn(h){const y=a.others.getUser(h.actor);return y?(a.others.removeConnection(h.actor),{type:"leave",user:y}):null}function ms(h){a.dynamicSessionInfoSig.set({actor:h.actor,nonce:h.nonce,scopes:h.scopes}),a.idFactory=ng(h.actor),ht();for(const y of a.others.connectionIds())h.users[y]===void 0&&a.others.removeConnection(y);for(const y in h.users){const b=h.users[y],_=Number(y);a.others.setConnection(_,b.id,b.info,b.scopes)}return{type:"reset"}}function ys(){return a.undoStack.length>0}function ws(){return a.redoStack.length>0}function Un(){w.history.notify({canUndo:ys(),canRedo:ws()})}function pr(h){a.others.setConnection(h.actor,h.id,h.info,h.scopes),a.buffer.messages.push({type:100,data:a.myPresence.get(),targetActor:h.actor}),vt();const y=a.others.getUser(h.actor);return y?{type:"enter",user:y}:void 0}function bs(h){return Zp(h)?h:null}function gr(h){const y=ce(h);return y===void 0?null:Wa(y)?si(y.map(b=>bs(b))):si([bs(y)])}function vs(h){if(h.size===0)return;const y=[],b=Array.from(h.values()),_=ct(b,!0);y.push({type:201,ops:_.ops}),V(_.updates),B(y)}function Ss(h){if(typeof h.data!="string")return;const y=gr(h.data);if(y===null||y.length===0)return;const b={storageUpdates:new Map,others:[]};for(const _ of y)switch(_.type){case 101:{const j=pr(_);j&&b.others.push(j);break}case 100:{const j=Pe(_);j&&b.others.push(j);break}case 103:{const j=a.others.get();w.customEvent.notify({connectionId:_.actor,user:_.actor<0?null:j.find(q=>q.connectionId===_.actor)??null,event:_.event});break}case 102:{const j=sn(_);j&&b.others.push(j);break}case 300:{w.ydoc.notify(_);break}case 104:{b.others.push(ms(_));break}case 200:{pt(_);break}case 201:{const j=ct(_.ops,!1);for(const[q,jt]of j.updates.storageUpdates)b.storageUpdates.set(q,$r(b.storageUpdates.get(q),jt));break}case 400:case 407:case 401:case 408:case 405:case 406:case 402:case 403:case 404:{w.comments.notify(_);break}}V(b)}function vt(){const h=a.buffer.storageOperations;if(h.length>0){for(const _ of h)a.unacknowledgedOps.set(M(_.opId),_);Is()}if(d.getStatus()!=="connected"){a.buffer.storageOperations=[];return}const y=Date.now(),b=y-a.buffer.lastFlushedAt;if(b>=t.throttleDelay){const _=mr();if(_.length===0)return;B(_),a.buffer={flushTimerID:void 0,lastFlushedAt:y,messages:[],storageOperations:[],presenceUpdates:null}}else clearTimeout(a.buffer.flushTimerID),a.buffer.flushTimerID=setTimeout(vt,t.throttleDelay-b)}function mr(){const h=[];a.buffer.presenceUpdates&&h.push(a.buffer.presenceUpdates.type==="full"?{type:100,targetActor:-1,data:a.buffer.presenceUpdates.data}:{type:100,data:a.buffer.presenceUpdates.data});for(const y of a.buffer.messages)h.push(y);return a.buffer.storageOperations.length>0&&h.push({type:201,ops:a.buffer.storageOperations}),h}function p(h,y,b){const _={type:301,update:h,guid:y,v2:b};a.buffer.messages.push(_),w.ydoc.notify(_),vt()}function S(h,y={shouldQueueEventIfNotReady:!1}){d.getStatus()!=="connected"&&!y.shouldQueueEventIfNotReady||(a.buffer.messages.push({type:103,event:h}),vt())}function T(h){const{storageOperations:y}=a.buffer;for(const b of h)y.push(b);vt()}let C=null,st=null;function pt(h){const y=new Map(a.unacknowledgedOps);nn(h),vs(y),st?.(),Is(),w.storageDidLoad.notify()}async function we(){if(!d.authValue)return;const h=await i.streamStorage({roomId:n});pt({items:h})}function Pt(h){const y=a.buffer.messages;t.unstable_streamData?we():y.some(b=>b.type===200)||y.push({type:200}),h.flush&&vt()}function Ut(){return C===null&&(Pt({flush:!0}),C=new Promise(h=>{st=h}),Is()),C}function Qt(){const h=a.root;return h!==void 0?h:(Ut(),null)}async function tt(){return a.root!==void 0?Promise.resolve({root:a.root}):(await Ut(),{root:M(a.root)})}function Ct(h,y,b){a.buffer.messages.find(_=>_.type===300&&_.vector===h&&_.guid===y&&_.v2===b)||a.buffer.messages.push({type:300,vector:h,guid:y,v2:b}),vt()}function te(){if(a.activeBatch)throw new Error("undo is not allowed during a batch");const h=a.undoStack.pop();if(h===void 0)return;a.pausedHistory=null;const y=ct(h,!0);V(y.updates),a.redoStack.push(y.reverse),Un();for(const b of y.ops)b.type!=="presence"&&a.buffer.storageOperations.push(b);vt()}function Nt(){if(a.activeBatch)throw new Error("redo is not allowed during a batch");const h=a.redoStack.pop();if(h===void 0)return;a.pausedHistory=null;const y=ct(h,!0);V(y.updates),a.undoStack.push(y.reverse),Un();for(const b of y.ops)b.type!=="presence"&&a.buffer.storageOperations.push(b);vt()}function _s(){a.undoStack.length=0,a.redoStack.length=0}function yr(h){if(a.activeBatch)return h();let y;a.activeBatch={ops:[],updates:{storageUpdates:new Map,presence:!1,others:[]},reverseOps:new Vr};try{y=h()}finally{const b=a.activeBatch;a.activeBatch=null,b.reverseOps.length>0&&A(Array.from(b.reverseOps)),b.ops.length>0&&(a.redoStack.length=0),b.ops.length>0&&T(b.ops),V(b.updates),vt()}return y}function Nn(){a.pausedHistory===null&&(a.pausedHistory=new Vr)}function rn(){const h=a.pausedHistory;a.pausedHistory=null,h!==null&&h.length>0&&Le(Array.from(h))}const ks=t.createSyncSource();function on(){return a.root===void 0?C===null?"not-loaded":"loading":a.unacknowledgedOps.size===0?"synchronized":"synchronizing"}let Qi=on();function Is(){const h=on();Qi!==h&&(Qi=h,w.storageStatus.notify(h)),ks.setSyncStatus(h==="synchronizing"?"synchronizing":"synchronized")}function to(){return W.get()!==null}async function ml(){for(;!to();){const{promise:h,resolve:y}=Hi(),b=Es.self.subscribeOnce(y),_=Es.status.subscribeOnce(y);await h,b(),_()}}function eo(){return Qt()!==null}async function yl(){for(;!eo();)await tt()}const wl=ae.from(a.others.signal,h=>h.map((y,b)=>rc(`Other ${b}`,y))),Es={status:w.status.observable,lostConnection:w.lostConnection.observable,customEvent:w.customEvent.observable,others:w.others.observable,self:w.self.observable,myPresence:w.myPresence.observable,storageBatch:w.storageBatch.observable,history:w.history.observable,storageDidLoad:w.storageDidLoad.observable,storageStatus:w.storageStatus.observable,ydoc:w.ydoc.observable,comments:w.comments.observable,roomWillDestroy:w.roomWillDestroy.observable};async function bl(h){return i.getThreadsSince({roomId:n,since:h.since,signal:h.signal})}async function vl(h){return i.getThreads({roomId:n,query:h?.query,cursor:h?.cursor})}async function Sl(h){return i.getThread({roomId:n,threadId:h})}async function _l(h){return i.createThread({roomId:n,threadId:h.threadId,commentId:h.commentId,metadata:h.metadata,body:h.body,attachmentIds:h.attachmentIds})}async function kl(h){return i.deleteThread({roomId:n,threadId:h})}async function Il({metadata:h,threadId:y}){return i.editThreadMetadata({roomId:n,threadId:y,metadata:h})}async function El(h){return i.markThreadAsResolved({roomId:n,threadId:h})}async function Al(h){return i.markThreadAsUnresolved({roomId:n,threadId:h})}async function Tl(h){return i.subscribeToThread({roomId:n,threadId:h})}async function Cl(h){return i.unsubscribeFromThread({roomId:n,threadId:h})}async function Ol(h){return i.createComment({roomId:n,threadId:h.threadId,commentId:h.commentId,body:h.body,attachmentIds:h.attachmentIds})}async function xl(h){return i.editComment({roomId:n,threadId:h.threadId,commentId:h.commentId,body:h.body,attachmentIds:h.attachmentIds})}async function Dl({threadId:h,commentId:y}){return i.deleteComment({roomId:n,threadId:h,commentId:y})}async function Rl({threadId:h,commentId:y,emoji:b}){return i.addReaction({roomId:n,threadId:h,commentId:y,emoji:b})}async function Ll({threadId:h,commentId:y,emoji:b}){return await i.removeReaction({roomId:n,threadId:h,commentId:y,emoji:b})}function Pl(h){return{type:"localAttachment",status:"idle",id:Rf(),name:h.name,size:h.size,mimeType:h.type,file:h}}async function Ul(h,y={}){return i.uploadAttachment({roomId:n,attachment:h,signal:y.signal})}function Nl(h){return i.getAttachmentUrl({roomId:n,attachmentId:h})}function no(h){return i.getSubscriptionSettings({roomId:n,signal:h?.signal})}function so(h){return i.updateSubscriptionSettings({roomId:n,settings:h})}async function Ml(h){await i.markRoomInboxNotificationAsRead({roomId:n,inboxNotificationId:h})}const ro=t.createSyncSource();function wr(h){return ro.setSyncStatus(h==="synchronizing"||h==="loading"?"synchronizing":"synchronized")}return Object.defineProperty({[Je]:{get presenceBuffer(){return cs(a.buffer.presenceUpdates?.data??null)},get undoStack(){return cs(a.undoStack)},get nodeCount(){return a.pool.nodes.size},getYjsProvider(){return a.yjsProvider},setYjsProvider(h){a.yjsProvider?.off("status",wr),a.yjsProvider=h,h?.on("status",wr),a.yjsProviderDidChange.notify()},yjsProviderDidChange:a.yjsProviderDidChange.observable,reportTextEditor:x,createTextMention:E,deleteTextMention:R,listTextVersions:K,listTextVersionsSince:z,getTextVersion:G,createTextVersion:ot,executeContextualPrompt:dt,getSelf_forDevTools:()=>Tt.get(),getOthers_forDevTools:()=>wl.get(),simulate:{explicitClose:h=>d._privateSendMachineEvent({type:"EXPLICIT_SOCKET_CLOSE",event:h}),rawSend:h=>d.send(h)},attachmentUrlsStore:i.getOrCreateAttachmentUrlsStore(n)},id:n,subscribe:ig(n,Es,t.errorEventSource),connect:()=>d.connect(),reconnect:()=>d.reconnect(),disconnect:()=>d.disconnect(),destroy:()=>{const{roomWillDestroy:h,...y}=w;for(const b of Object.values(y))b.dispose();w.roomWillDestroy.notify(),a.yjsProvider?.off("status",wr),ks.destroy(),ro.destroy(),c(),d.destroy(),h.dispose()},updatePresence:Zt,updateYDoc:p,broadcastEvent:S,batch:yr,history:{undo:te,redo:Nt,canUndo:ys,canRedo:ws,clear:_s,pause:Nn,resume:rn},fetchYDoc:Ct,getStorage:tt,getStorageSnapshot:Qt,getStorageStatus:on,isPresenceReady:to,isStorageReady:eo,waitUntilPresenceReady:No(ml),waitUntilStorageReady:No(yl),events:Es,getStatus:()=>d.getStatus(),getSelf:()=>W.get(),getPresence:()=>a.myPresence.get(),getOthers:()=>a.others.get(),getThreads:vl,getThreadsSince:bl,getThread:Sl,createThread:_l,deleteThread:kl,editThreadMetadata:Il,markThreadAsResolved:El,markThreadAsUnresolved:Al,subscribeToThread:Tl,unsubscribeFromThread:Cl,createComment:Ol,editComment:xl,deleteComment:Dl,addReaction:Rl,removeReaction:Ll,prepareAttachment:Pl,uploadAttachment:Ul,getAttachmentUrl:Nl,getNotificationSettings:no,getSubscriptionSettings:no,updateNotificationSettings:so,updateSubscriptionSettings:so,markInboxNotificationAsRead:Ml},Je,{enumerable:!1})}function ig(e,t,n){function s(o,c){return t.storageBatch.subscribe(l=>{const d=l.filter(a=>Ha(a.node,o));d.length>0&&c(d)})}function r(o,c){return t.storageBatch.subscribe(l=>{for(const d of l)d.node._id===o._id&&c(d.node)})}function i(o,c,l){if(typeof o=="string"&&og(o)){if(typeof c!="function")throw new Error("Second argument must be a callback function");const d=c;switch(o){case"event":return t.customEvent.subscribe(d);case"my-presence":return t.myPresence.subscribe(d);case"others":{const a=d;return t.others.subscribe(u=>{const{others:f,...g}=u;return a(f,g)})}case"error":return n.subscribe(a=>{if(a.roomId===e)return d(a)});case"status":return t.status.subscribe(d);case"lost-connection":return t.lostConnection.subscribe(d);case"history":return t.history.subscribe(d);case"storage-status":return t.storageStatus.subscribe(d);case"comments":return t.comments.subscribe(d);default:return gt(o,`"${String(o)}" is not a valid event name`)}}if(c===void 0||typeof o=="function")if(typeof o=="function"){const d=o;return t.storageBatch.subscribe(d)}else throw new Error("Please specify a listener callback");if(nt(o)){const d=o;return l?.isDeep?s(d,c):r(d,c)}throw new Error(`${String(o)} is not a value that can be subscribed to.`)}return i}function og(e){return e==="my-presence"||e==="others"||e==="event"||e==="error"||e==="history"||e==="status"||e==="storage-status"||e==="lost-connection"||e==="connection"||e==="comments"}function cg(e,t){return async()=>t.getAuthValue({requestedScope:"room:read",roomId:e})}function ag(e,t,n){return s=>{const r=n??(typeof WebSocket>"u"?void 0:WebSocket);if(r===void 0)throw new qt("To use Liveblocks client in a non-DOM environment, you need to provide a WebSocket polyfill.");const i=new URL(t);if(i.protocol=i.protocol==="http:"?"ws":"wss",i.pathname="/v7",i.searchParams.set("roomId",e),s.type==="secret")i.searchParams.set("tok",s.token.raw);else if(s.type==="public")i.searchParams.set("pubkey",s.publicApiKey);else return gt(s,"Unhandled case");return i.searchParams.set("version",dr),new r(i.toString())}}var lg=16,dg=1e3,ug=100,hg=15e3,fg=200,pg=1e3,gg=3e4,mg=5e3,yg=50,wg=50,bg=50;function vg(e){return typeof e=="string"&&e.startsWith("http")?e:Ip}function km(e){const t=e,n=Sg(t.throttle??ug),s=_g(t.lostConnectionTimeout??mg),r=ic(t.backgroundKeepAliveTimeout),i=vg(t.baseUrl),o=new Dt(void 0),c=Sp(e,A=>{const V=A.k==="sec-legacy"?A.id:A.uid;o.set(()=>V)}),l=t.polyfills?.fetch||globalThis.fetch?.bind(globalThis),d=Mf({baseUrl:i,fetchPolyfill:l,currentUserId:o,authManager:c}),a=new Map,u=yp({userId:o.get(),lostConnectionTimeout:s,backgroundKeepAliveTimeout:ic(t.backgroundKeepAliveTimeout),polyfills:t.polyfills,delegates:{createSocket:wp(i,t.polyfills?.WebSocket),authenticate:async()=>{const A=await c.getAuthValue({requestedScope:"room:read"});if(A.type==="public")throw new qt("Cannot use AI Copilots with a public API key");if(A.token.parsed.k==="sec-legacy")throw new qt("AI Copilots requires an ID or Access token");return A},canZombie:()=>!1}});function f(A){A.id,a.delete(A.id),A.destroy()}function g(A){const V=()=>{const Q=V;A.unsubs.delete(Q)?A.unsubs.size===0&&f(A.room):bt("This leave function was already called. Calling it more than once has no effect.")};return A.unsubs.add(V),{room:A.room,leave:V}}function m(A,...V){const Q=a.get(A);if(Q!==void 0)return g(Q);const ct=V[0]??{},Ft=(typeof ct.initialPresence=="function"?ct.initialPresence(A):ct.initialPresence)??{},Zt=(typeof ct.initialStorage=="function"?ct.initialStorage(A):ct.initialStorage)??{},Pe=rg({initialPresence:Ft,initialStorage:Zt},{roomId:A,throttleDelay:n,lostConnectionTimeout:s,backgroundKeepAliveTimeout:r,polyfills:t.polyfills,delegates:t.mockedDelegates??{createSocket:ag(A,i,t.polyfills?.WebSocket),authenticate:cg(A,c)},enableDebugLogging:t.enableDebugLogging,baseUrl:i,errorEventSource:W,largeMessageStrategy:t.largeMessageStrategy,unstable_streamData:!!t.unstable_streamData,roomHttpClient:d,createSyncSource:Tt}),sn={room:Pe,unsubs:new Set};if(a.set(A,sn),ct.autoConnect??!0){if(typeof atob>"u"){if(t.polyfills?.atob===void 0)throw new Error("You need to polyfill atob to use the client in your environment. Please follow the instructions at https://liveblocks.io/docs/errors/liveblocks-client/atob-polyfill");global.atob=t.polyfills.atob}Pe.connect()}return g(sn)}function v(A){const V=a.get(A)?.room;return V||null}function P(){c.reset(),o.set(()=>{});for(const{room:A}of a.values())zf(A.getStatus())||A.reconnect()}const L=t.resolveUsers,I=new Ie(async A=>{const V=A.flat(),Q=await L?.({userIds:V});return Nr(!L,"Set the resolveUsers option in createClient to specify user info."),Q??V.map(()=>{})},{delay:yg}),U=wn(I);function w(A){U.invalidate(A)}const E=t.resolveRoomsInfo,R=new Ie(async A=>{const V=A.flat(),Q=await E?.({roomIds:V});return Nr(!E,"Set the resolveRoomsInfo option in createClient to specify room info."),Q??V.map(()=>{})},{delay:wg}),x=wn(R);function K(A){x.invalidate(A)}const z=t.resolveGroupsInfo,G=new Ie(async A=>{const V=A.flat(),Q=await z?.({groupIds:V});return Nr(!z,"Set the resolveGroupsInfo option in createClient to specify group info."),Q??V.map(()=>{})},{delay:bg}),ot=wn(G);function dt(A){ot.invalidate(A)}const O=new Map;function k(){O.clear()}const H=[],B=new Dt("synchronized"),W=J();function ut(){const A=B.get();return A==="synchronizing"?A:"synchronized"}function ht(){B.set(H.some(A=>A.get()==="synchronizing")?"synchronizing":H.some(A=>A.get()==="has-local-changes")?"has-local-changes":"synchronized")}function Tt(){const A=new Dt("synchronized");H.push(A);const V=A.subscribe(()=>ht());function Q(Ft){A.set(Ft)}function ct(){V();const Ft=H.findIndex(Zt=>Zt===A);if(Ft>-1){const[Zt]=H.splice(Ft,1);Zt.get()!=="synchronized"&&ht()}}return{setSyncStatus:Q,destroy:ct}}{const A=Q=>{t.preventUnsavedChanges&&B.get()!=="synchronized"&&Q.preventDefault()};(typeof window<"u"?window:void 0)?.addEventListener("beforeunload",A)}async function nn(A){const V=await d.getNotificationSettings(A);return tc(V)}async function Pn(A){const V=await d.updateNotificationSettings(A);return tc(V)}const Le=Object.defineProperty({enterRoom:m,getRoom:v,logout:P,getInboxNotifications:d.getInboxNotifications,getInboxNotificationsSince:d.getInboxNotificationsSince,getUnreadInboxNotificationsCount:d.getUnreadInboxNotificationsCount,markAllInboxNotificationsAsRead:d.markAllInboxNotificationsAsRead,markInboxNotificationAsRead:d.markInboxNotificationAsRead,deleteAllInboxNotifications:d.deleteAllInboxNotifications,deleteInboxNotification:d.deleteInboxNotification,getNotificationSettings:nn,updateNotificationSettings:Pn,resolvers:{invalidateUsers:w,invalidateRoomsInfo:K,invalidateGroupsInfo:dt,invalidateMentionSuggestions:k},getSyncStatus:ut,events:{error:W,syncStatus:B},[Je]:{currentUserId:o,mentionSuggestionsCache:O,ai:u,resolveMentionSuggestions:t.resolveMentionSuggestions,usersStore:U,roomsInfoStore:x,groupsInfoStore:ot,getRoomIds(){return Array.from(a.keys())},httpClient:d,as:()=>Le,createSyncSource:Tt,emitError:(A,V)=>{const Q=fi.from(A,V);W.notify(Q)||pe(Q.message)}}},Je,{enumerable:!1});return Le}function Gi(e,t,n,s,r){if(typeof t!="number"||t<n||s!==void 0&&t>s)throw new Error(s!==void 0?`${e} should be between ${r??n} and ${s}.`:`${e} should be at least ${r??n}.`);return t}function ic(e){if(e!==void 0)return Gi("backgroundKeepAliveTimeout",e,hg)}function Sg(e){return Gi("throttle",e,lg,dg)}function _g(e){return Gi("lostConnectionTimeout",e,fg,gg,pg)}var kg={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};new RegExp(Object.keys(kg).map(e=>`\\${e}`).join("|"),"g");var Ig={_:"\\_","*":"\\*","#":"\\#","`":"\\`","~":"\\~","!":"\\!","|":"\\|","(":"\\(",")":"\\)","{":"\\{","}":"\\}","[":"\\[","]":"\\]"};new RegExp(Object.keys(Ig).map(e=>`\\${e}`).join("|"),"g");Bi(nf,dr,sf);var Eg="@liveblocks/client",Ag="3.9.2",Tg="esm";Bi(Eg,Ag,Tg);const Ya="3.7.7",Cg=Ya,Ln=typeof Buffer=="function",oc=typeof TextDecoder=="function"?new TextDecoder:void 0,cc=typeof TextEncoder=="function"?new TextEncoder:void 0,Og="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",Fn=Array.prototype.slice.call(Og),Us=(e=>{let t={};return e.forEach((n,s)=>t[n]=s),t})(Fn),xg=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,ft=String.fromCharCode.bind(String),ac=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):e=>new Uint8Array(Array.prototype.slice.call(e,0)),Ja=e=>e.replace(/=/g,"").replace(/[+\/]/g,t=>t=="+"?"-":"_"),Xa=e=>e.replace(/[^A-Za-z0-9\+\/]/g,""),Za=e=>{let t,n,s,r,i="";const o=e.length%3;for(let c=0;c<e.length;){if((n=e.charCodeAt(c++))>255||(s=e.charCodeAt(c++))>255||(r=e.charCodeAt(c++))>255)throw new TypeError("invalid character found");t=n<<16|s<<8|r,i+=Fn[t>>18&63]+Fn[t>>12&63]+Fn[t>>6&63]+Fn[t&63]}return o?i.slice(0,o-3)+"===".substring(o):i},Yi=typeof btoa=="function"?e=>btoa(e):Ln?e=>Buffer.from(e,"binary").toString("base64"):Za,pi=Ln?e=>Buffer.from(e).toString("base64"):e=>{let n=[];for(let s=0,r=e.length;s<r;s+=4096)n.push(ft.apply(null,e.subarray(s,s+4096)));return Yi(n.join(""))},Fs=(e,t=!1)=>t?Ja(pi(e)):pi(e),Dg=e=>{if(e.length<2){var t=e.charCodeAt(0);return t<128?e:t<2048?ft(192|t>>>6)+ft(128|t&63):ft(224|t>>>12&15)+ft(128|t>>>6&63)+ft(128|t&63)}else{var t=65536+(e.charCodeAt(0)-55296)*1024+(e.charCodeAt(1)-56320);return ft(240|t>>>18&7)+ft(128|t>>>12&63)+ft(128|t>>>6&63)+ft(128|t&63)}},Rg=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,Qa=e=>e.replace(Rg,Dg),lc=Ln?e=>Buffer.from(e,"utf8").toString("base64"):cc?e=>pi(cc.encode(e)):e=>Yi(Qa(e)),vn=(e,t=!1)=>t?Ja(lc(e)):lc(e),dc=e=>vn(e,!0),Lg=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,Pg=e=>{switch(e.length){case 4:var t=(7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3),n=t-65536;return ft((n>>>10)+55296)+ft((n&1023)+56320);case 3:return ft((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return ft((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},tl=e=>e.replace(Lg,Pg),el=e=>{if(e=e.replace(/\s+/g,""),!xg.test(e))throw new TypeError("malformed base64.");e+="==".slice(2-(e.length&3));let t,n="",s,r;for(let i=0;i<e.length;)t=Us[e.charAt(i++)]<<18|Us[e.charAt(i++)]<<12|(s=Us[e.charAt(i++)])<<6|(r=Us[e.charAt(i++)]),n+=s===64?ft(t>>16&255):r===64?ft(t>>16&255,t>>8&255):ft(t>>16&255,t>>8&255,t&255);return n},Ji=typeof atob=="function"?e=>atob(Xa(e)):Ln?e=>Buffer.from(e,"base64").toString("binary"):el,nl=Ln?e=>ac(Buffer.from(e,"base64")):e=>ac(Ji(e).split("").map(t=>t.charCodeAt(0))),sl=e=>nl(rl(e)),Ug=Ln?e=>Buffer.from(e,"base64").toString("utf8"):oc?e=>oc.decode(nl(e)):e=>tl(Ji(e)),rl=e=>Xa(e.replace(/[-_]/g,t=>t=="-"?"+":"/")),gi=e=>Ug(rl(e)),Ng=e=>{if(typeof e!="string")return!1;const t=e.replace(/\s+/g,"").replace(/={0,2}$/,"");return!/[^\s0-9a-zA-Z\+/]/.test(t)||!/[^\s0-9a-zA-Z\-_]/.test(t)},il=e=>({value:e,enumerable:!1,writable:!0,configurable:!0}),ol=function(){const e=(t,n)=>Object.defineProperty(String.prototype,t,il(n));e("fromBase64",function(){return gi(this)}),e("toBase64",function(t){return vn(this,t)}),e("toBase64URI",function(){return vn(this,!0)}),e("toBase64URL",function(){return vn(this,!0)}),e("toUint8Array",function(){return sl(this)})},cl=function(){const e=(t,n)=>Object.defineProperty(Uint8Array.prototype,t,il(n));e("toBase64",function(t){return Fs(this,t)}),e("toBase64URI",function(){return Fs(this,!0)}),e("toBase64URL",function(){return Fs(this,!0)})},Mg=()=>{ol(),cl()},gn={version:Ya,VERSION:Cg,atob:Ji,atobPolyfill:el,btoa:Yi,btoaPolyfill:Za,fromBase64:gi,toBase64:vn,encode:vn,encodeURI:dc,encodeURL:dc,utob:Qa,btou:tl,decode:gi,isValid:Ng,fromUint8Array:Fs,toUint8Array:sl,extendString:ol,extendUint8Array:cl,extendBuiltins:Mg},en=e=>_n((t,n)=>{e.onerror=s=>n(new Error(s.target.error)),e.onsuccess=s=>t(s.target.result)}),$g=(e,t)=>_n((n,s)=>{const r=indexedDB.open(e);r.onupgradeneeded=i=>t(i.target.result),r.onerror=i=>s(ue(i.target.error)),r.onsuccess=i=>{const o=i.target.result;o.onversionchange=()=>{o.close()},n(o)}}),Vg=e=>en(indexedDB.deleteDatabase(e)),Bg=(e,t)=>t.forEach(n=>e.createObjectStore.apply(e,n)),jn=(e,t,n="readwrite")=>{const s=e.transaction(t,n);return t.map(r=>Gg(s,r))},al=(e,t)=>en(e.count(t)),Fg=(e,t)=>en(e.get(t)),ll=(e,t)=>en(e.delete(t)),jg=(e,t,n)=>en(e.put(t,n)),mi=(e,t)=>en(e.add(t)),Hg=(e,t,n)=>en(e.getAll(t,n)),Kg=(e,t,n)=>{let s=null;return qg(e,t,r=>(s=r,!1),n).then(()=>s)},zg=(e,t=null)=>Kg(e,t,"prev"),Wg=(e,t)=>_n((n,s)=>{e.onerror=s,e.onsuccess=async r=>{const i=r.target.result;if(i===null||await t(i)===!1)return n();i.continue()}}),qg=(e,t,n,s="next")=>Wg(e.openKeyCursor(t,s),r=>n(r.key)),Gg=(e,t)=>e.objectStore(t),Yg=(e,t)=>IDBKeyRange.upperBound(e,t),Jg=(e,t)=>IDBKeyRange.lowerBound(e,t),Br="custom",dl="updates",ul=500,hl=(e,t=()=>{},n=()=>{})=>{const[s]=jn(e.db,[dl]);return Hg(s,Jg(e._dbref,!1)).then(r=>{e._destroyed||(t(s),Y(e.doc,()=>{r.forEach(i=>$c(e.doc,i))},e,!1),n(s))}).then(()=>zg(s).then(r=>{e._dbref=r+1})).then(()=>al(s).then(r=>{e._dbsize=r})).then(()=>s)},Xg=(e,t=!0)=>hl(e).then(n=>{(t||e._dbsize>=ul)&&mi(n,Ti(e.doc)).then(()=>ll(n,Yg(e._dbref,!0))).then(()=>al(n).then(s=>{e._dbsize=s}))});class fl extends Kl{constructor(t,n){super(),this.doc=n,this.name=t,this._dbref=0,this._dbsize=0,this._destroyed=!1,this.db=null,this.synced=!1,this._db=$g(t,s=>Bg(s,[["updates",{autoIncrement:!0}],["custom"]])),this.whenSynced=_n(s=>this.on("synced",()=>s(this))),this._db.then(s=>{this.db=s,hl(this,o=>mi(o,Ti(n)),()=>{if(this._destroyed)return this;this.synced=!0,this.emit("synced",[this])})}),this._storeTimeout=1e3,this._storeTimeoutId=null,this._storeUpdate=(s,r)=>{if(this.db&&r!==this){const[i]=jn(this.db,[dl]);mi(i,s),++this._dbsize>=ul&&(this._storeTimeoutId!==null&&clearTimeout(this._storeTimeoutId),this._storeTimeoutId=setTimeout(()=>{Xg(this,!1),this._storeTimeoutId=null},this._storeTimeout))}},n.on("update",this._storeUpdate),this.destroy=this.destroy.bind(this),n.on("destroy",this.destroy)}destroy(){return this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this.doc.off("update",this._storeUpdate),this.doc.off("destroy",this.destroy),this._destroyed=!0,this._db.then(t=>{t.close()})}clearData(){return this.destroy().then(()=>{Vg(this.name)})}get(t){return this._db.then(n=>{const[s]=jn(n,[Br],"readonly");return Fg(s,t)})}set(t,n){return this._db.then(s=>{const[r]=jn(s,[Br]);return jg(r,n,t)})}del(t){return this._db.then(n=>{const[s]=jn(n,[Br]);return ll(s,t)})}}/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Zg(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function Xi(e,...t){if(!Zg(e))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw new Error("Uint8Array expected of length "+t+", got length="+e.length)}function uc(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Qg(e,t){Xi(e);const n=t.outputLen;if(e.length<n)throw new Error("digestInto() expects output buffer of length at least "+n)}function yi(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function Fr(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function zt(e,t){return e<<32-t|e>>>t}function tm(e){if(typeof e!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(e))}function pl(e){return typeof e=="string"&&(e=tm(e)),Xi(e),e}class em{}function nm(e){const t=s=>e().update(pl(s)).digest(),n=e();return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=()=>e(),t}function sm(e,t,n,s){if(typeof e.setBigUint64=="function")return e.setBigUint64(t,n,s);const r=BigInt(32),i=BigInt(4294967295),o=Number(n>>r&i),c=Number(n&i),l=s?4:0,d=s?0:4;e.setUint32(t+l,o,s),e.setUint32(t+d,c,s)}function rm(e,t,n){return e&t^~e&n}function im(e,t,n){return e&t^e&n^t&n}class om extends em{constructor(t,n,s,r){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=t,this.outputLen=n,this.padOffset=s,this.isLE=r,this.buffer=new Uint8Array(t),this.view=Fr(this.buffer)}update(t){uc(this),t=pl(t),Xi(t);const{view:n,buffer:s,blockLen:r}=this,i=t.length;for(let o=0;o<i;){const c=Math.min(r-this.pos,i-o);if(c===r){const l=Fr(t);for(;r<=i-o;o+=r)this.process(l,o);continue}s.set(t.subarray(o,o+c),this.pos),this.pos+=c,o+=c,this.pos===r&&(this.process(n,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){uc(this),Qg(t,this),this.finished=!0;const{buffer:n,view:s,blockLen:r,isLE:i}=this;let{pos:o}=this;n[o++]=128,yi(this.buffer.subarray(o)),this.padOffset>r-o&&(this.process(s,0),o=0);for(let u=o;u<r;u++)n[u]=0;sm(s,r-8,BigInt(this.length*8),i),this.process(s,0);const c=Fr(t),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const d=l/4,a=this.get();if(d>a.length)throw new Error("_sha2: outputLen bigger than state");for(let u=0;u<d;u++)c.setUint32(4*u,a[u],i)}digest(){const{buffer:t,outputLen:n}=this;this.digestInto(t);const s=t.slice(0,n);return this.destroy(),s}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:n,buffer:s,length:r,finished:i,destroyed:o,pos:c}=this;return t.destroyed=o,t.finished=i,t.length=r,t.pos=c,r%n&&t.buffer.set(s),t}clone(){return this._cloneInto()}}const Se=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),cm=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),_e=new Uint32Array(64);class am extends om{constructor(t=32){super(64,t,8,!1),this.A=Se[0]|0,this.B=Se[1]|0,this.C=Se[2]|0,this.D=Se[3]|0,this.E=Se[4]|0,this.F=Se[5]|0,this.G=Se[6]|0,this.H=Se[7]|0}get(){const{A:t,B:n,C:s,D:r,E:i,F:o,G:c,H:l}=this;return[t,n,s,r,i,o,c,l]}set(t,n,s,r,i,o,c,l){this.A=t|0,this.B=n|0,this.C=s|0,this.D=r|0,this.E=i|0,this.F=o|0,this.G=c|0,this.H=l|0}process(t,n){for(let u=0;u<16;u++,n+=4)_e[u]=t.getUint32(n,!1);for(let u=16;u<64;u++){const f=_e[u-15],g=_e[u-2],m=zt(f,7)^zt(f,18)^f>>>3,v=zt(g,17)^zt(g,19)^g>>>10;_e[u]=v+_e[u-7]+m+_e[u-16]|0}let{A:s,B:r,C:i,D:o,E:c,F:l,G:d,H:a}=this;for(let u=0;u<64;u++){const f=zt(c,6)^zt(c,11)^zt(c,25),g=a+f+rm(c,l,d)+cm[u]+_e[u]|0,v=(zt(s,2)^zt(s,13)^zt(s,22))+im(s,r,i)|0;a=d,d=l,l=c,c=o+g|0,o=i,i=r,r=s,s=g+v|0}s=s+this.A|0,r=r+this.B|0,i=i+this.C|0,o=o+this.D|0,c=c+this.E|0,l=l+this.F|0,d=d+this.G|0,a=a+this.H|0,this.set(s,r,i,o,c,l,d,a)}roundClean(){yi(_e)}destroy(){this.set(0,0,0,0,0,0,0,0),yi(this.buffer)}}const hc=nm(()=>new am);var lm="@liveblocks/yjs",dm="3.9.2",um="esm",jr=()=>new Map,hm=(e,t,n)=>{let s=e.get(t);return s===void 0&&e.set(t,s=n()),s},fm=()=>new Set,pm=Array.from,Zi=class{constructor(){this._observers=jr()}on(e,t){hm(this._observers,e,fm).add(t)}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}off(e,t){const n=this._observers.get(e);n!==void 0&&(n.delete(t),n.size===0&&this._observers.delete(e))}emit(e,t){return pm((this._observers.get(e)||jr()).values()).forEach(n=>n(...t))}destroy(){this._observers=jr()}},se="__yjs",Ns="__yjs_clientid",gm=class extends Zi{room;doc;states=new Map;actorToClientMap=new Map;meta=new Map;_checkInterval=0;othersUnsub;constructor(e,t){super(),this.doc=e,this.room=t,this.room.updatePresence({[Ns]:this.doc.clientID}),this.othersUnsub=this.room.events.others.subscribe(n=>{let s;if(n.type==="leave"){const r=this.actorToClientMap.get(n.user.connectionId);r!==void 0&&(s={added:[],updated:[],removed:[r]}),this.rebuildActorToClientMap(n.others)}if(n.type==="enter"||n.type==="update"){this.rebuildActorToClientMap(n.others);const r=this.actorToClientMap.get(n.user.connectionId);r!==void 0&&(s={added:n.type==="enter"?[r]:[],updated:n.type==="update"?[r]:[],removed:[]})}n.type==="reset"&&this.rebuildActorToClientMap(n.others),s!==void 0&&(this.emit("change",[s,"presence"]),this.emit("update",[s,"presence"]))})}rebuildActorToClientMap(e){this.actorToClientMap.clear(),e.forEach(t=>{t.presence[Ns]!==void 0&&this.actorToClientMap.set(t.connectionId,t.presence[Ns])})}destroy(){this.emit("destroy",[this]),this.othersUnsub(),this.setLocalState(null),super.destroy()}getLocalState(){const e=this.room.getPresence();return Object.keys(e).length===0||typeof e[se]>"u"?null:e[se]}setLocalState(e){const t=this.room.getSelf()?.presence;if(e===null){if(t===void 0)return;this.room.updatePresence({...t,[se]:null}),this.emit("update",[{added:[],updated:[],removed:[this.doc.clientID]},"local"]);return}const n=t?.[se],s=n===void 0?[this.doc.clientID]:[],r=n===void 0?[]:[this.doc.clientID];this.room.updatePresence({[se]:{...n||{},...e||{}}}),this.emit("update",[{added:s,updated:r,removed:[]},"local"])}setLocalStateField(e,t){const n=this.room.getSelf()?.presence[se],s={[e]:t};this.room.updatePresence({[se]:{...n||{},...s}})}getStates(){const t=this.room.getOthers().reduce((s,r)=>{const i=r.presence[se],o=r.presence[Ns];return i!==void 0&&o!==void 0&&s.set(o,i||{}),s},new Map),n=this.room.getSelf()?.presence[se];return n!==void 0&&t.set(this.doc.clientID,n),t}},fc=class gl extends Zi{unsubscribers=[];_synced=!1;doc;updateRoomDoc;fetchRoomDoc;useV2Encoding;localSnapshotHashΣ;remoteSnapshotHashΣ;debounceTimer=null;static DEBOUNCE_INTERVAL_MS=200;isLocalAndRemoteSnapshotEqualΣ;constructor({doc:t,isRoot:n,updateDoc:s,fetchDoc:r,useV2Encoding:i}){super(),this.doc=t,this.useV2Encoding=i,this.doc.on(i?"updateV2":"update",this.updateHandler),this.updateRoomDoc=c=>{s(c,n?void 0:this.doc.guid)},this.fetchRoomDoc=c=>{r(c,n?void 0:this.doc.guid)},this.syncDoc();const o=this.useV2Encoding?Gr(Ts(this.doc)):ko(Ts(this.doc));this.localSnapshotHashΣ=new Dt(gn.fromUint8Array(hc(o))),this.remoteSnapshotHashΣ=new Dt(null),this.isLocalAndRemoteSnapshotEqualΣ=ae.from(()=>{const c=this.remoteSnapshotHashΣ.get();return!(c===null||this.localSnapshotHashΣ.get()!==c)})}handleServerUpdate=({update:t,stateVector:n,readOnly:s,v2:r,remoteSnapshotHash:i})=>{if((r?Ai:$c)(this.doc,t,"backend"),n){if(!s)try{const l=(this.useV2Encoding?Vc:Ti)(this.doc,gn.toUint8Array(n));this.updateRoomDoc(l)}catch(c){console.warn(c)}this.synced=!0}this.remoteSnapshotHashΣ.set(i)};syncDoc=()=>{this.synced=!1;const t=gn.fromUint8Array(lu(this.doc));this.fetchRoomDoc(t)};get synced(){return this._synced}set synced(t){this._synced!==t&&(this._synced=t,this.emit("synced",[t]),this.emit("sync",[t]))}debounced_updateLocalSnapshot(){this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{const t=this.useV2Encoding?Gr(Ts(this.doc)):ko(Ts(this.doc));this.localSnapshotHashΣ.set(gn.fromUint8Array(hc(t))),this.debounceTimer=null},gl.DEBOUNCE_INTERVAL_MS)}updateHandler=(t,n)=>{this.debounced_updateLocalSnapshot();const s=n instanceof fl;n!=="backend"&&!s&&this.updateRoomDoc(t)};experimental_getSyncStatus(){return this.remoteSnapshotHashΣ.get()===null?"loading":this.isLocalAndRemoteSnapshotEqualΣ.get()?"synchronized":"synchronizing"}destroy(){this.debounceTimer&&clearTimeout(this.debounceTimer),this.doc.off("update",this.updateHandler),this.unsubscribers.forEach(t=>t()),this._observers=new Map,this.doc.destroy()}},mm=class extends Zi{room;rootDoc;options;indexeddbProvider=null;isPaused=!1;unsubscribers=[];awareness;rootDocHandler;subdocHandlersΣ=new Tn(new Map);syncStatusΣ;permanentUserData;constructor(e,t,n={}){super(),this.rootDoc=t,this.room=e,this.options=n,this.rootDocHandler=new fc({doc:t,isRoot:!0,updateDoc:this.updateDoc,fetchDoc:this.fetchDoc,useV2Encoding:this.options.useV2Encoding_experimental??!1}),this.options.enablePermanentUserData&&(this.permanentUserData=new uu(t)),e[Je].setYjsProvider(this),this.awareness=new gm(this.rootDoc,this.room),this.unsubscribers.push(this.room.events.status.subscribe(s=>{s==="connected"?this.rootDocHandler.syncDoc():this.rootDocHandler.synced=!1})),this.unsubscribers.push(this.room.events.ydoc.subscribe(s=>{const{type:r}=s;if(r===qa.UPDATE_YDOC)return;const{stateVector:i,update:o,guid:c,v2:l,remoteSnapshotHash:d}=s,a=this.room.getSelf()?.canWrite??!0,u=gn.toUint8Array(o);c!==void 0?this.subdocHandlersΣ.get().get(c)?.handleServerUpdate({update:u,stateVector:i,readOnly:!a,v2:l,remoteSnapshotHash:d}):this.rootDocHandler.handleServerUpdate({update:u,stateVector:i,readOnly:!a,v2:l,remoteSnapshotHash:d})})),n.offlineSupport_experimental&&this.setupOfflineSupport(),this.rootDocHandler.on("synced",()=>{const s=this.rootDocHandler.synced;for(const[r,i]of this.subdocHandlersΣ.get())i.syncDoc();this.emit("synced",[s]),this.emit("sync",[s])}),this.rootDoc.on("subdocs",this.handleSubdocs),this.syncDoc(),this.syncStatusΣ=ae.from(()=>{const s=this.rootDocHandler.experimental_getSyncStatus();return s==="loading"||s==="synchronizing"?s:Array.from(this.subdocHandlersΣ.get().values()).map(i=>i.experimental_getSyncStatus()).some(i=>i!=="synchronized")?"synchronizing":"synchronized"}),this.emit("status",[this.getStatus()]),this.unsubscribers.push(this.syncStatusΣ.subscribe(()=>{this.emit("status",[this.getStatus()])}))}setupOfflineSupport=()=>{this.indexeddbProvider=new fl(this.room.id,this.rootDoc);const e=()=>{this.rootDocHandler.synced=!0};this.indexeddbProvider.on("synced",e),this.unsubscribers.push(()=>{this.indexeddbProvider?.off("synced",e)})};handleSubdocs=({loaded:e,removed:t,added:n})=>{e.forEach(this.createSubdocHandler);const s=this.subdocHandlersΣ.get();if(this.options.autoloadSubdocs)for(const r of n)s.has(r.guid)||r.load();for(const r of t)s.has(r.guid)&&(s.get(r.guid)?.destroy(),s.delete(r.guid))};updateDoc=(e,t)=>{(this.room.getSelf()?.canWrite??!0)&&!this.isPaused&&this.room.updateYDoc(gn.fromUint8Array(e),t,this.useV2Encoding)};fetchDoc=(e,t)=>{this.room.fetchYDoc(e,t,this.useV2Encoding)};createSubdocHandler=e=>{const t=this.subdocHandlersΣ.get();if(t.has(e.guid)){t.get(e.guid)?.syncDoc();return}const n=new fc({doc:e,isRoot:!1,updateDoc:this.updateDoc,fetchDoc:this.fetchDoc,useV2Encoding:this.options.useV2Encoding_experimental??!1});t.set(e.guid,n)};loadSubdoc=e=>{for(const t of this.rootDoc.subdocs)if(t.guid===e)return t.load(),!0;return!1};syncDoc=()=>{this.rootDocHandler.syncDoc();for(const[e,t]of this.subdocHandlersΣ.get())t.syncDoc()};get useV2Encoding(){return this.options.useV2Encoding_experimental??!1}get synced(){return this.rootDocHandler.synced}async pause(){await this.indexeddbProvider?.destroy(),this.indexeddbProvider=null,this.isPaused=!0}unpause(){this.isPaused=!1,this.options.offlineSupport_experimental&&this.setupOfflineSupport(),this.rootDocHandler.syncDoc()}getStatus(){return this.syncStatusΣ.get()}destroy(){this.unsubscribers.forEach(e=>e()),this.awareness.destroy(),this.rootDocHandler.destroy(),this._observers=new Map;for(const[e,t]of this.subdocHandlersΣ.get())t.destroy();this.subdocHandlersΣ.get().clear(),super.destroy()}async clearOfflineData(){if(this.indexeddbProvider)return this.indexeddbProvider.clearData()}getYDoc(){return this.rootDoc}disconnect(){}connect(){}get subdocHandlers(){return this.subdocHandlersΣ.get()}set subdocHandlers(e){this.subdocHandlersΣ.mutate(t=>{t.clear();for(const[n,s]of e)t.set(n,s)})}},pc=new WeakMap,Im=(e,t={})=>{const n=pc.get(e);if(n!==void 0)return n;const s=new Ze,r=new mm(e,s,t);return e.events.roomWillDestroy.subscribeOnce(()=>{r.destroy()}),pc.set(e,r),r};Bi(lm,dm,um);export{Mt as Y,Sm as a,yt as b,km as c,vm as d,Im as g,$h as r,Tr as s,_m as w};
