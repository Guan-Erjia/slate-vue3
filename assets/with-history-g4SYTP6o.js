import{i as m,O as p,E as y,T as w,P as S}from"./editable-CteuoeWb.js";import{G as M}from"./index-C_5Oh6uc.js";const H={isHistory(t){return m(t)&&Array.isArray(t.redos)&&Array.isArray(t.undos)&&(t.redos.length===0||p.isOperationList(t.redos[0].operations))&&(t.undos.length===0||p.isOperationList(t.undos[0].operations))}},u=new WeakMap,c=new WeakMap,f=new WeakMap,i={isHistoryEditor(t){return H.isHistory(t.history)&&y.isEditor(t)},isMerging(t){return c.get(t)},isSplittingOnce(t){return f.get(t)},setSplittingOnce(t,e){f.set(t,e)},isSaving(t){return u.get(t)},redo(t){t.redo()},undo(t){t.undo()},withMerging(t,e){const r=i.isMerging(t);c.set(t,!0),e(),c.set(t,r)},withNewBatch(t,e){const r=i.isMerging(t);c.set(t,!0),f.set(t,!0),e(),c.set(t,r),f.delete(t)},withoutMerging(t,e){const r=i.isMerging(t);c.set(t,!1),e(),c.set(t,r)},withoutSaving(t,e){const r=i.isSaving(t);u.set(t,!1);try{e()}finally{u.set(t,r)}}},_=t=>{const e=t,{apply:r}=e;return e.history={undos:M([]),redos:M([])},e.redo=()=>{const{history:s}=e,o=s.redos;if(o.length>0){const n=o[o.length-1];n.selectionBefore&&w.setSelection(e,n.selectionBefore),i.withoutSaving(e,()=>{y.withoutNormalizing(e,()=>{for(const a of n.operations)e.apply(a)})}),s.redos.pop(),e.writeHistory("undos",n)}},e.undo=()=>{const{history:s}=e,{undos:o}=s;if(o.length>0){const n=o[o.length-1];i.withoutSaving(e,()=>{y.withoutNormalizing(e,()=>{const a=n.operations.map(p.inverse).reverse();for(const l of a)e.apply(l);n.selectionBefore&&w.setSelection(e,n.selectionBefore)})}),e.writeHistory("redos",n),s.undos.pop()}},e.apply=s=>{const{operations:o,history:n}=e,{undos:a}=n,l=a[a.length-1],d=l&&l.operations[l.operations.length-1];let g=i.isSaving(e),h=i.isMerging(e);if(g==null&&(g=B(s)),g){if(h==null&&(l==null?h=!1:o.includes(d)?h=!0:h=x(s,d)),i.isSplittingOnce(e)&&(h=!1,i.setSplittingOnce(e,void 0)),l&&h)l.operations.push(s);else{const O={operations:[s],selectionBefore:{...e.selection}};e.writeHistory("undos",O)}for(;a.length>100;)a.shift();n.redos=[]}r(s)},e.writeHistory=(s,o)=>{e.history[s].push(o)},e},x=(t,e)=>!!(e&&t.type==="insert_text"&&e.type==="insert_text"&&t.offset===e.offset+e.text.length&&S.equals(t.path,e.path)||e&&t.type==="remove_text"&&e.type==="remove_text"&&t.offset+t.text.length===e.offset&&S.equals(t.path,e.path)),B=(t,e)=>t.type!=="set_selection";export{_ as w};
